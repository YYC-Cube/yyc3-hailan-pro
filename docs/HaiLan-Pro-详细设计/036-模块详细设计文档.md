---
file: 036-模块详细设计文档.md
description: HaiLan Pro 各业务模块的功能、逻辑、接口、数据的详细设计，指导开发落地
author: YanYuCloudCube Team
version: v1.0.0
created: 2026-01-26
updated: 2026-01-26
status: published
tags:
  - HaiLan-Pro-详细设计,[模块设计]
---

> ***YanYuCloudCube***
> **标语**：言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **标语**：万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 036 模块详细设计文档

## 概述

本文档详细描述HaiLan Pro各业务模块的功能、逻辑、接口、数据的详细设计，为开发落地提供技术规范和实施指导。

## 核心内容

### 1. 背景与目标

#### 1.1 设计目标

- **模块化设计**：将系统划分为高内聚、低耦合的模块
- **接口标准化**：统一的API接口规范和数据格式
- **数据一致性**：确保数据在各模块间的一致性
- **可维护性**：便于后续维护和扩展

### 2. 模块架构设计

#### 2.1 模块分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                      表现层 (Presentation Layer)                │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │   PWA前端     │  │  微信小程序  │  │ 支付宝小程序 │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      网关层 (Gateway Layer)                     │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              API Gateway + 负载均衡 + SSL终止          │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      业务层 (Business Layer)                     │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌───────┐  │
│  │用户服务 │  │商城服务 │  │隐私服务 │  │AI服务  │  │IoT服务│  │
│  │         │  │         │  │         │  │         │  │     │
│  │- 登录   │  │- 商品   │  │- 加密   │  │- 对话   │  │- 设备│  │
│  │- 注册   │  │- 订单   │  │- 脱敏   │  │- 推荐   │  │- 控制│  │
│  │- 信息   │  │- 支付   │  │- 伪装   │  │- 知识   │  │- 同步│  │
│  └─────────┘  └─────────┘  └─────────�  └─────────�  └───────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐              │
│  │PostgreSQL│  │ MongoDB │  │  Redis  │  │RabbitMQ │              │
│  │(关系数据)│  │(文档数据)│  │  缓存   │  │ 消息队列│              │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘              │
└─────────────────────────────────────────────────────────────┘
```

### 3. 核心业务模块设计

#### 3.1 用户服务模块 (User Service)

##### 3.1.1 模块职责

| 职责 | 描述 |
|-----|------|
| 用户注册/登录 | 手机号、邮箱、第三方登录 |
| 用户信息管理 | 用户信息维护、实名认证 |
| 生物识别 | 指纹、面容识别 |
| 权限管理 | 角色权限、用户权限 |
| 账户安全 | 密码修改、设备管理、账户注销 |

##### 3.1.2 API接口定义

```typescript
// 用户服务API接口
interface UserServiceAPI {
  // 用户注册
  POST /api/v1/users/register: {
    request: RegisterRequest;
    response: AuthResponse;
  };

  // 用户登录
  POST /api/v1/users/login: {
    request: LoginRequest;
    response: AuthResponse;
  };

  // 第三方登录
  POST /api/v1/users/oauth/:provider: {
    request: OAuthRequest;
    response: AuthResponse;
  };

  // 获取用户信息
  GET /api/v1/users/me: {
    headers: { Authorization: 'Bearer {token}' };
    response: UserProfile;
  };

  // 更新用户信息
  PUT /api/v1/users/me: {
    headers: { Authorization: 'Bearer {token}' };
    request: UpdateUserRequest;
    response: UserProfile;
  };
}

// 请求/响应类型定义
interface RegisterRequest {
  phone?: string;
  email?: string;
  password: string;
  code: string;
  nickname?: string;
  inviteCode?: string;
}

interface LoginRequest {
  type: 'phone' | 'email' | 'biometric';
  phone?: string;
  email?: string;
  password?: string;
  code?: string;
}

interface AuthResponse {
  success: boolean;
  userId: string;
  token: string;
  refreshToken: string;
  expiresIn: number;
  user: UserProfile;
}

interface UserProfile {
  userId: string;
  nickname: string;
  avatar?: string;
  email?: string;
  phone?: string;
  gender?: 'male' | 'female' | 'other';
  memberLevel: MemberLevel;
  privacyLevel: PrivacyLevel;
  createdAt: Date;
}
```

#### 3.2 商城服务模块 (Mall Service)

##### 3.2.1 模块职责

| 职责 | 描述 |
|-----|------|
| 商品管理 | 商品CRUD、上下架、库存管理 |
| 分类管理 | 场景化分类体系维护 |
| 购物车 | 购物车操作、持久化 |
| 订单管理 | 订单创建、支付、状态管理 |
| 支付集成 | 多渠道支付接入 |

##### 3.2.2 核心数据模型

```typescript
// 商品数据模型
interface Product {
  id: string;
  sku: string;                    // 商品SKU
  name: string;
  category: ProductCategory;
  price: number;
  originalPrice?: number;
  images: ProductImage[];
  description: string;
  specifications: ProductSpec[];
  stock: number;
  sales: number;
  rating: number;                  // 评分 0-5
  tags: string[];
  isRestricted: boolean;           // 是否限制商品
  medicalLevel?: MedicalLevel;     // 医疗等级
  createdAt: Date;
  updatedAt: Date;
}

enum ProductCategory {
  CARE = 'CARE',                   // 关怀系列
  PLAY = 'PLAY',                   // 愉悦系列
  INTIMACY = 'INTIMACY',           // 亲密系列
  LINGERIE = 'LINGERIE',           // 情趣内衣
  SMART = 'SMART'                   // 智能硬件
}

interface ProductImage {
  id: string;
  url: string;
  type: 'cover' | 'detail' | 'thumbnail';
  alt: string;
  order: number;
}

interface ProductSpec {
  name: string;
  value: string;
  options: SpecOption[];
}

// 订单数据模型
interface Order {
  id: string;
  userId: string;
  orderNo: string;               // 订单号
  items: OrderItem[];
  totalAmount: number;
  discountAmount: number;
  actualAmount: number;
  status: OrderStatus;
  privacyLevel: ShippingPrivacyLevel;
  shippingInfo: EncryptedShippingInfo;
  paymentInfo: PaymentInfo;
  createdAt: Date;
  updatedAt: Date;
}

interface OrderItem {
  productId: string;
  productSku: string;
  productName: string;
  quantity: number;
  unitPrice: number;
  totalPrice: number;
}
```

#### 3.3 隐私服务模块 (Privacy Service)

##### 3.3.1 模块职责

| 职责 | 描述 |
|-----|------|
| 数据加密 | 敏感数据加密/解密服务 |
| 数据脱敏 | 数据展示脱敏处理 |
| 隐私模式 | 隐私浏览模式管理 |
| 应用伪装 | 应用图标/名称伪装 |
| 数据清理 | 数据清理和销毁 |

##### 3.3.2 隐私级别定义

```typescript
// 隐私级别枚举
enum PrivacyLevel {
  STANDARD = 'standard',     // 标准：基础保护
  STEALTH = 'stealth',        // 隐身：增强保护
  DISGUISE = 'disguise'        // 伪装：最高保护
}

// 隐私配置
interface PrivacyConfig {
  level: PrivacyLevel;
  features: {
    dataEncryption: boolean;      // 数据加密
    anonymousBilling: boolean;    // 匿名账单
    disguisedShipping: boolean;   // 伪装发货
    dataAutoCleanup: boolean;     // 自动清理
    biometricAuth: boolean;       // 生物识别
    stealthMode: boolean;         // 隐身模式
  };
}

// 加密服务接口
interface EncryptionService {
  // 加密数据
  encrypt(data: string, key?: string): Promise<EncryptedData>;

  // 解密数据
  decrypt(encryptedData: EncryptedData, key?: string): Promise<string>;

  // 生成数据加密密钥
  generateDataKey(userId: string): Promise<DataKey>;
}

interface EncryptedData {
  algorithm: 'AES-256-GCM';
  iv: string;
  ciphertext: string;
  tag: string;
  keyId: string;
  timestamp: number;
}
```

#### 3.4 AI服务模块 (AI Service)

##### 3.4.1 模块架构

```typescript
// AI服务架构
interface AIServiceArchitecture {
  // 对话服务
  conversation: {
    llm: 'GPT-4 / 文心一言';
    contextSize: 10;  // 上下文轮数
    maxTokens: 2000;
    temperature: 0.7;
  };

  // 推荐服务
  recommendation: {
    collaborative: '协同过滤';
    contentBased: '内容推荐';
    hybrid: '混合推荐';
    fallback: '热门推荐';
  };

  // 知识服务
  knowledge: {
    vectorDb: 'Chroma';
    embedding: 'text-embedding-ada-002';
    topK: 5;
    threshold: 0.7;
  };
}

// AI对话服务接口
interface AIServiceAPI {
  // 发送消息
  POST /api/v1/ai/chat: {
    headers: { Authorization: 'Bearer {token}' };
    request: ChatRequest;
    response: ChatResponse;
  };

  // 智能推荐
  POST /api/v1/ai/recommend: {
    headers: { Authorization: 'Bearer {token}' };
    request: RecommendationRequest;
    response: RecommendationResponse;
  };

  // 健康咨询
  POST /api/v1/ai/health/consult: {
    headers: { Authorization: 'Bearer {token}' };
    request: HealthConsultRequest;
    response: HealthConsultResponse;
  };
}
```

#### 3.5 IoT服务模块 (IoT Service)

##### 3.5.1 模块职责

| 职责 | 描述 |
|-----|------|
| 设备管理 | 设备绑定、解绑、信息管理 |
| 设备控制 | 远程控制、参数调节、模式切换 |
| 数据同步 | 设备数据采集、同步、存储 |
| 固件升级 | OTA升级、版本管理 |

##### 3.5.2 设备控制接口

```typescript
// IoT服务接口
interface IoTServiceAPI {
  // 设备绑定
  POST /api/v1/iot/devices: {
    headers: { Authorization: 'Bearer {token}' };
    request: DeviceBindRequest;
    response: DeviceBindResponse;
  };

  // 设备控制
  POST /api/v1/iot/devices/:deviceId/control: {
    headers: { Authorization: 'Bearer {token}' };
    request: DeviceControlRequest;
    response: DeviceControlResponse;
  };

  // 获取设备状态
  GET /api/v1/iot/devices/:deviceId/status: {
    headers: { Authorization: 'Bearer {token}' };
    response: DeviceStatus;
  };
}

interface DeviceControlRequest {
  action: 'switch' | 'setMode' | 'setIntensity';
  parameters: Record<string, any>;
  encrypted: boolean;
}
```

### 4. 接口设计规范

#### 4.1 RESTful API标准

```typescript
// RESTful API设计规范
interface RESTfulAPIStandards {
  // URL设计
  url: {
    format: '/api/v{version}/{resource}/{id}';
    naming: 'kebab-case';
    plural: true;
  };

  // HTTP方法映射
  methods: {
    'POST': 'create',    // 创建资源
    'GET': 'read',      // 读取资源
    'PUT': 'update',   // 完整更新
    'PATCH': 'modify', // 部分更新
    'DELETE': 'delete'  // 删除资源
  };

  // 状态码规范
  statusCodes: {
    200: 'OK',
    201: 'Created',
    204: 'No Content',
    400: 'Bad Request',
    401: 'Unauthorized',
    403: 'Forbidden',
    404: 'Not Found',
    500: 'Internal Server Error'
  };

  // 响应格式
  responseFormat: {
    success: {
      code: number;
      message: string;
      data: any;
    };
    error: {
      code: number;
      message: string;
      error: string;
      details?: any;
    };
  };
}
```

#### 4.2 接口错误码体系

| 错误码 | 错误描述 | HTTP状态码 | 处理建议 |
|-------|---------|-----------|---------|
| 1001 | 参数缺失 | 400 | 检查请求参数 |
| 1002 | 参数格式错误 | 400 | 检查参数格式 |
| 1003 | 用户未登录 | 401 | 引导用户登录 |
| 1004 | 权限不足 | 403 | 检查用户权限 |
| 1005 | 资源不存在 | 404 | 检查资源ID |
| 2001 | 用户已存在 | 400 | 使用登录或找回密码 |
| 3001 | 库存不足 | 400 | 提示库存不足 |
| 4001 | AI服务不可用 | 503 | 稍后重试 |
| 5001 | 设备未绑定 | 400 | 先绑定设备 |

### 5. 数据设计规范

#### 5.1 数据库设计

##### 5.1.1 PostgreSQL表设计

| 表名 | 说明 | 主要字段 |
|-----|------|---------|
| users | 用户表 | user_id, phone, email, nickname, password_hash, member_level, privacy_level |
| user_profiles | 用户档案表 | user_id, gender, birthday, avatar, preferences |
| products | 商品表 | product_id, sku, name, category, price, stock, sales, rating |
| orders | 订单表 | order_id, user_id, order_no, total_amount, status, privacy_level |
| order_items | 订单明细表 | item_id, order_id, product_id, quantity, unit_price |
| devices | IoT设备表 | device_id, user_id, device_type, device_name, firmware_version |
| device_data | 设备数据表 | data_id, device_id, data_type, data_value, timestamp |

##### 5.1.2 MongoDB集合设计

| 集合名 | 用途 | 文档结构 |
|-------|------|---------|
| conversations | AI对话历史 | {userId, messages:[], timestamp} |
| recommendations | 推荐记录 | {userId, productId, reason, timestamp} |
| audit_logs | 审计日志 | {userId, action, resource, ip, timestamp} |

#### 5.2 Redis缓存设计

```typescript
// Redis缓存设计
interface RedisCacheDesign {
  // 用户会话
  session: {
    key: 'session:{userId}';
    ttl: 7200;  // 2小时
    data: 'UserSession';
  };

  // 商品缓存
  product: {
    key: 'product:{productId}';
    ttl: 3600;  // 1小时
    data: 'Product';
  };

  // 购物车
  cart: {
    key: 'cart:{userId}';
    ttl: 86400;  // 24小时
    data: 'Cart';
  };

  // 接口限流
  rateLimit: {
    key: 'ratelimit:{userId}:{api}';
    ttl: 60;     // 1分钟
    data: 'number'; // 请求次数
  };
}
```

---

## 附录

### A. 模块依赖关系图

### B. 接口完整列表

### C. 数据库ER图

### D. 术语表

| 术语 | 说明 |
|-----|------|
| **API** | Application Programming Interface，应用程序接口 |
| **RESTful** | Representational State Transfer，表现层状态转换 |
| **DTO** | Data Transfer Object，数据传输对象 |
| **CRUD** | Create, Read, Update, Delete |

### E. 修订历史

| 版本 | 日期 | 修订人 | 修订内容 |
|-----|------|-------|---------|
| v1.0.0 | 2026-01-26 | YanYuCloudCube Team | 初始版本创建 |

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
