---
@file: 047-跨端适配代码规范文档.md
@description: HaiLan Pro 小程序、APP、H5多端适配的代码规范与兼容方案
@author: YanYuCloudCube Team
@version: v1.0.0
@created: 2026-01-26
@updated: 2026-01-26
@status: published
@tags: [HaiLan-Pro-详细设计],[]
---

> ***YanYuCloudCube***
> **标语**：言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **标语**：万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 047 跨端适配代码规范文档

## 概述

本文档详细描述HaiLan Pro-HaiLan-Pro-详细设计-跨端适配代码规范文档相关内容，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景
HaiLan Pro (海蓝) 是新一代高端、私密、智能的情趣健康生活管理平台。项目基于「五高五标五化」理念，通过 PWA 技术结合 AI 智能辅助与物联网，为用户提供从生理健康到心理愉悦的全方位解决方案。

#### 1.2 项目愿景
打造极致隐私、智能陪伴、品质合规、全场景覆盖的情趣健康生活管理平台，为用户提供安全、专业、高端的健康生活体验。

#### 1.3 核心价值主张
- **极致隐私**：双重加密、隐私浏览模式及伪装发货机制
- **智能陪伴**：基于 LLM 的 AI 情感与生理健康顾问
- **品质合规**：医疗级标准商品，高端"海蓝蓝"视觉调性
- **全场景覆盖**：PWA 端支持离线浏览、桌面安装及无缝推送

#### 1.4 文档目标
- 规范跨端适配代码规范文档相关的业务标准与技术落地要求
- 为项目相关人员提供清晰的参考依据
- 保障相关模块开发、实施、运维的一致性与规范性

### 2. 设计原则

#### 2.1 五高原则
- **高可用性**：确保系统7x24小时稳定运行，支持PWA离线能力
- **高性能**：优化响应时间和处理能力，支持高并发访问
- **高安全性**：保护用户数据和隐私安全，双重加密机制
- **高扩展性**：支持业务快速扩展，微服务架构设计
- **高可维护性**：便于后续维护和升级，模块化设计

#### 2.2 五标体系
- **标准化**：统一的技术和流程标准
- **规范化**：严格的开发和管理规范
- **自动化**：提高开发效率和质量，CI/CD自动化
- **智能化**：利用AI技术提升能力，LLM智能顾问
- **可视化**：直观的监控和管理界面

#### 2.3 五化架构
- **流程化**：标准化的开发流程
- **文档化**：完善的文档体系
- **工具化**：高效的开发工具链
- **数字化**：数据驱动的决策
- **生态化**：开放的生态系统

### 3. 跨端适配代码规范文档

#### 3.1 多端架构设计

##### 3.1.1 平台适配策略

```typescript
// 多端适配架构定义
interface CrossPlatformArchitecture {
  // 核心代码层 (100%共享)
  core: {
    businessLogic: 'src/core/';     // 业务逻辑
    stateManagement: 'src/store/';   // 状态管理
    utils: 'src/core/utils/';        // 工具函数
    types: 'src/core/types/';        // 类型定义
    constants: 'src/core/constants/'; // 常量定义
    api: 'src/core/api/';            // API封装
  };

  // 平台适配层 (平台特定代码)
  platforms: {
    h5: {
      path: 'src/platforms/h5/';
      features: ['ServiceWorker', 'WebBluetooth', 'PushNotifications'];
      framework: 'Vue3 + Vite';
      buildTarget: 'es2020';
    };
    wechat: {
      path: 'src/platforms/wechat/';
      features: ['微信登录', '微信支付', '订阅消息', '客服消息'];
      framework: 'Uni-app';
      buildTarget: 'mp-weixin';
    };
    alipay: {
      path: 'src/platforms/alipay/';
      features: ['支付宝登录', '支付宝支付', '小程序消息'];
      framework: 'Uni-app';
      buildTarget: 'mp-alipay';
    };
  };
}
```

##### 3.1.2 条件编译规范

```typescript
// 条件编译配置
// vite.config.ts
import { defineConfig } from 'vite';
import uni from '@dcloudio/vite-plugin-uni';
import { UniAdapter } from './src/platforms/UniAdapter';

export default defineConfig({
  plugins: [
    uni(),
    UniAdapter({
      wechat: {
        appid: process.env.VITE_WECHAT_APPID,
        setting: {
          urlCheck: false,
          es6: true,
          postcss: true,
          minified: true
        }
      },
      alipay: {
        appid: process.env.VITE_ALIPAY_APPID,
        setting: {
          urlCheck: false,
          es6: true,
          postcss: true,
          minified: true
        }
      }
    })
  ],
  // 条件编译配置
  define: {
    'process.env.PLATFORM': JSON.stringify(process.env.VITE_PLATFORM)
  }
});

// 平台检测代码
// src/utils/platform.ts
export const platform = {
  isH5: process.env.VITE_PLATFORM === 'h5',
  isWeChat: process.env.VITE_PLATFORM === 'wechat',
  isAlipay: process.env.VITE_PLATFORM === 'alipay',
  isMiniProgram: process.env.VITE_PLATFORM === 'wechat' || process.env.VITE_PLATFORM === 'alipay',

  get platformName() {
    if (this.isH5) return 'h5';
    if (this.isWeChat) return 'wechat';
    if (this.isAlipay) return 'alipay';
    return 'unknown';
  }
};

// 条件引入
// 条件组件引入
const MyComponent = () => import('./MyComponent.vue');

// 条件API调用
if (platform.isWeChat) {
  // 微信小程序特定代码
  uni.requestPayment({
    provider: 'wxpay',
    ...
  });
}
```

#### 3.2 API适配规范

##### 3.2.1 统一API接口

```typescript
// 统一API适配层
// src/core/api/adapters/base.adapter.ts
export class BaseAPIAdapter {
  protected baseURL: string;

  constructor() {
    this.baseURL = this.getBaseURL();
  }

  protected getBaseURL(): string {
    return process.env.VITE_API_BASE_URL;
  }

  // 通用请求方法
  async request<T>(config: AxiosRequestConfig): Promise<T> {
    const platform = process.env.VITE_PLATFORM;

    // 平台特定配置
    const platformConfig = this.getPlatformConfig(platform);
    Object.assign(config, platformConfig);

    // 添加平台标识
    config.headers = {
      ...config.headers,
      'X-Platform': platform,
      'X-App-Version': process.env.VITE_APP_VERSION
    };

    // 发送请求
    return this.axios.request<T>(config);
  }

  protected getPlatformConfig(platform: string): Partial<AxiosRequestConfig> {
    switch (platform) {
      case 'h5':
        return {
          timeout: 30000,
          withCredentials: true
        };
      case 'wechat':
        return {
          timeout: 10000, // 小程序超时时间更短
        };
      case 'alipay':
        return {
          timeout: 10000,
        };
      default:
        return {};
    }
  }
}
```

##### 3.2.2 平台特定API适配

```typescript
// 微信小程序API适配
// src/platforms/wechat/api/wechat.adapter.ts
import { BaseAPIAdapter } from '@/core/api/adapters/base.adapter';

export class WeChatAPIAdapter extends BaseAPIAdapter {
  // 微信登录
  async login(code: string): Promise<WeChatLoginResponse> {
    const response = await this.request<WeChatLoginResponse>({
      url: '/api/v1/auth/wechat/login',
      method: 'POST',
      data: {
        code,
        appid: process.env.VITE_WECHAT_APPID
      }
    });

    return response;
  }

  // 微信支付
  async createPayment(params: WeChatPayParams): Promise<WeChatPayResponse> {
    const response = await this.request<WeChatPayResponse>({
      url: '/api/v1/payment/wechat/create',
      method: 'POST',
      data: {
        ...params,
        appid: process.env.VITE_WECHAT_APPID
      }
    });

    // 调用小程序支付API
    uni.requestPayment({
      provider: 'wxpay',
      ...response.paymentParams
    });

    return response;
  }
}

// 支付宝小程序API适配
// src/platforms/alipay/api/alipay.adapter.ts
export class AlipayAPIAdapter extends BaseAPIAdapter {
  // 支付宝登录
  async login(authCode: string): Promise<AlipayLoginResponse> {
    const response = await this.request<AlipayLoginResponse>({
      url: '/api/v1/auth/alipay/login',
      method: 'POST',
      data: {
        authCode,
        appid: process.env.VITE_ALIPAY_APPID
      }
    });

    return response;
  }

  // 支付宝支付
  async createPayment(params: AlipayPayParams): Promise<AlipayPayResponse> {
    const response = await this.request<AlipayPayResponse>({
      url: '/api/v1/payment/alipay/create',
      method: 'POST',
      data: {
        ...params,
        appid: process.env.VITE_ALIPAY_APPID
      }
    });

    // 调用支付宝支付API
    my.tradePay(response.paymentParams);

    return response;
  }
}
```

#### 3.3 UI组件适配规范

##### 3.3.1 组件适配策略

```typescript
// 组件适配规范
interface ComponentAdaptationStrategy {
  // 通用组件 (全平台共享)
  universal: {
    path: 'src/components/common/';
    components: [
      'HButton',
      'HInput',
      'HCard',
      'HModal',
      'HLoading'
    ];
    adaptation: '完全兼容';
  };

  // 平台特定组件
  platformSpecific: {
    h5: {
      path: 'src/platforms/h5/components/';
      components: [
        'ServiceWorkerInstaller',
        'WebBluetoothConnector',
        'PWAInstallPrompt'
      ];
    };
    wechat: {
      path: 'src/platforms/wechat/components/';
      components: [
        'WeChatShareButton',
        'WeChatSubscribeMessage',
        'CustomerServiceButton'
      ];
    };
    alipay: {
      path: 'src/platforms/alipay/components/';
      components: [
        'AlipayShareButton',
        'AlipaySubscribeMessage'
      ];
    };
  };
}
```

##### 3.3.2 条件组件实现

```vue
<!-- 条件组件示例：分享按钮 -->
<!-- src/components/common/ShareButton.vue -->
<template>
  <!-- H5: Web Share API -->
  <button v-if="platform.isH5" @click="shareWeb" class="share-btn">
    <slot></slot>
  </button>

  <!-- 微信小程序 -->
  <button v-else-if="platform.isWeChat" open-type="share" class="share-btn">
    <slot></slot>
  </button>

  <!-- 支付宝小程序 -->
  <button v-else-if="platform.isAlipay" open-type="share" class="share-btn">
    <slot></slot>
  </button>

  <!-- 其他平台：不支持 -->
  <button v-else disabled class="share-btn disabled">
    <slot></slot>
  </button>
</template>

<script setup lang="ts">
import { platform } from '@/utils/platform';

// H5分享
async function shareWeb() {
  if (navigator.share) {
    try {
      await navigator.share({
        title: '分享标题',
        text: '分享描述',
        url: window.location.href
      });
    } catch (error) {
      console.error('分享失败:', error);
      // 降级处理：复制链接
      copyToClipboard();
    }
  } else {
    // 不支持原生分享，显示自定义分享面板
    showSharePanel();
  }
}

// 微信小程序分享
// 通过页面配置实现，组件仅作为触发器
function showSharePanel() {
  // 显示自定义分享面板
}
</script>
```

#### 3.4 样式适配规范

##### 3.4.1 响应式样式适配

```css
/* 样式适配规范 */
/* src/styles/adaptation.css */

/* 安全区域适配 - 适配刘海屏 */
.safe-area-inset-bottom {
  padding-bottom: constant(safe-area-inset-bottom, 20px);
}

.safe-area-inset-top {
  padding-top: constant(safe-area-inset-top, 44px);
}

/* 小程序特有样式 */
/* #ifdef MP-WEIXIN */
.mp-weixin {
  /* 小程序按钮样式 */
  .button {
    border-radius: 0;
    background: none;
    padding: 0;
  }

  /* 小程序滚动容器 */
  .scroll-view {
    -webkit-overflow-scrolling: touch;
  }
}
/* #endif */

/* H5特有样式 */
/* #ifdef H5 */
.h5-only {
  /* H5特有效果 */
  .backdrop-blur {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
}
/* #endif */

/* 平台条件样式 */
.platform-h5 .h5-feature {
  display: block;
}

.platform-wechat .wechat-feature {
  display: block;
}

.platform-alipay .alipay-feature {
  display: block;
}

/* 隐藏平台不支持的功能 */
.platform-wechat .h5-only {
  display: none !important;
}

.platform-alipay .h5-only {
  display: none !important;
}
```

#### 3.5 功能降级规范

##### 3.5.1 功能适配矩阵

```typescript
// 功能适配矩阵
interface FeatureAdaptationMatrix {
  features: {
    // 生物识别
    biometric: {
      h5: {
        support: 'WebAuthn API';
        fallback: '密码登录';
        check: () => !!window.PublicKeyCredential
      };
      wechat: {
        support: 'wx.checkIsSupportSoterAuthentication';
        fallback: '密码登录';
      };
      alipay: {
        support: false;
        alternative: '密码登录';
      };
    };

    // 蓝牙
    bluetooth: {
      h5: {
        support: 'Web Bluetooth API';
        fallback: '手动操作';
        check: () => 'bluetooth' in navigator
      };
      wechat: {
        support: 'wx.openBluetoothAdapter';
        fallback: '手动操作';
      };
      alipay: {
        support: false;
        alternative: '手动操作';
      };
    };

    // 推送通知
    push: {
      h5: {
        support: 'Push API + Notification API';
        alternative: '应用内消息';
      };
      wechat: {
        support: '订阅消息';
        alternative: '模板消息';
      };
      alipay {
        support: '小程序消息';
        alternative: '应用内消息';
      };
    };

    // 扫码
    scan: {
      h5: {
        support: 'Barcode Detection API + WebRTC';
        fallback: '手动输入';
      };
      wechat: {
        support: 'wx.scanCode';
        fallback: '手动输入';
      };
      alipay: {
        support: 'my.scan';
        fallback: '手动输入';
      };
    };
  };
}
```

##### 3.5.2 降级策略实现

```typescript
// 功能降级服务
// src/core/services/fallback.service.ts
export class FallbackService {
  /**
   * 生物识别降级
   */
  async biometricAuth(): Promise<boolean> {
    const platform = process.env.VITE_PLATFORM;

    if (platform === 'h5') {
      // 尝试WebAuthn
      if ('credentials' in navigator) {
        try {
          const credential = await navigator.credentials.get({
            publicKey: {
              challenge: new Uint8Array(32),
              allowCredentials: true,
              userVerification: 'preferred'
            }
          });
          return true;
        } catch {
          // 降级到密码登录
          return false;
        }
      }
    } else if (platform === 'wechat') {
      // 检查微信生物识别支持
      const supported = await wx.checkIsSupportSoterAuthentication();
      if (supported) {
        return true;
      }
    }

    // 降级到密码登录
    return false;
  }

  /**
   * 蓝牙功能降级
   */
  async bluetoothConnect(deviceId: string): Promise<boolean> {
    const platform = process.env.VITE_PLATFORM;

    if (platform === 'h5') {
      // 尝试Web Bluetooth
      if ('bluetooth' in navigator) {
        try {
          const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [deviceId] }]
          });
          const server = await device.gatt.connect();
          return true;
        } catch {
          return false;
        }
      }
    } else if (platform === 'wechat') {
      // 尝试微信蓝牙
      try {
        await wx.openBluetoothAdapter();
        await wx.createBLEConnection();
        return true;
      } catch {
        return false;
      }
    }

    return false;
  }

  /**
   * 扫码功能降级
   */
  async scanCode(): Promise<string | null> {
    const platform = process.env.VITE_PLATFORM;

    if (platform === 'h5') {
      // 使用输入框手动输入
      const code = await this.showManualInputDialog();
      return code;
    } else if (platform === 'wechat') {
      // 微信扫码
      try {
        const result = await wx.scanCode();
        return result.scanType === 'QR_CODE' ? result.result : null;
      } catch {
        return null;
      }
    } else if (platform === 'alipay') {
      // 支付宝扫码
      try {
        const result = await my.scan();
        return result.code;
      } catch {
        return null;
      }
    }

    return null;
  }
}
```

#### 3.6 构建配置规范

##### 3.6.1 构建脚本配置

```javascript
// package.json
{
  "scripts": {
    // H5构建
    "build:h5": "vite build --mode h5",
    "dev:h5": "vite --mode h5",

    // 微信小程序构建
    "build:wechat": "uni build --platform mp-weixin",
    "dev:wechat": "uni --platform mp-weixin",

    // 支付宝小程序构建
    "build:alipay": "uni build --platform mp-alipay",
    "dev:alipay": "uni --platform mp-alipay",

    // 所有平台构建
    "build:all": "npm run build:h5 && npm run build:wechat && npm run build:alipay"
  }
}
```

##### 3.6.2 UniApp配置

```json
// manifest.json - 微信小程序
{
  "name": "海蓝",
  "appid": "__UNI__",
  "description": "高端私密智能健康生活管理平台",
  "versionName": "1.0.0",
  "versionCode": "100",
  "mp-weixin": {
    "appid": "",
    "setting": {
      "urlCheck": false,
      "es6": true,
      "postcss": true,
      "minified": true
    },
    "permission": {
      "scope.userLocation": {
        "desc": "您的位置信息将用于优化推荐服务"
      },
      "scope.userLocationBackground": {
        "desc": "后台获取位置信息"
      },
      "scope.address": {
        "desc": "用于添加收货地址"
      }
    },
    "requiredPrivateInfos": [
      "chooseAddress",
      "chooseContact"
    ]
  }
}

// manifest.json - 支付宝小程序
{
  "name": "海蓝",
  "appid": "__UNI__",
  "description": "高端私密智能健康生活管理平台",
  "versionName": "1.0.0",
  "versionCode": "1.0.0",
  "mp-alipay": {
    "appid": "",
    "setting": {
      "urlCheck": false,
      "es6": true,
      "postcss": true,
      "minified": true
    },
    "permission": {
      "location": {
        "desc": "您的位置信息将用于优化推荐服务"
      }
    }
  }
}
```

#### 3.7 测试规范

##### 3.7.1 多端测试策略

```typescript
// 多端测试规范
interface MultiPlatformTesting {
  // 测试环境
  environments: {
    h5: {
      browsers: ['Chrome', 'Safari', 'Edge', 'Firefox'];
      devices: ['iPhone 12', 'Samsung Galaxy S21'];
      tools: ['Cypress', 'Playwright'];
    };
    wechat: {
      tools: ['微信开发者工具', '真机调试'];
      devices: ['iPhone (iOS)', 'Android'];
    };
    alipay: {
      tools: ['支付宝开发者工具', '真机调试'];
      devices: ['iPhone (iOS)', 'Android'];
    };
  };

  // 测试类型
  testTypes: {
    functional: '功能测试 - 所有核心功能';
    compatible: '兼容性测试 - API/组件兼容';
    performance: '性能测试 - 加载速度/响应时间';
    security: '安全测试 - 数据加密/权限控制';
    ui: 'UI测试 - 界面展示/交互';
  };

  // 测试用例
  testCases: [
    '用户注册/登录',
    '商品浏览/搜索',
    '购物车/下单',
    '支付流程',
    '隐私功能',
    'AI对话',
    'IoT设备控制'
  ];
}
```

---

## 附录

### A. 平台差异对照表

### B. API兼容性处理

### C. 组件适配示例

### D. 术语表

| 术语 | 说明 |
|-----|------|
| **Uni-app** | 跨平台应用开发框架 |
| **条件编译** | 根据条件编译不同代码 |
| **Polyfill** | 代码垫片，提供缺失功能 |
| **降级策略** | 功能不可用时的替代方案 |

### E. 修订历史

| 版本 | 日期 | 修订人 | 修订内容 |
|-----|------|-------|---------|
| v1.0.0 | 2026-01-26 | YanYuCloudCube Team | 初始版本创建 |

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
