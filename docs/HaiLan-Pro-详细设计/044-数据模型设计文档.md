---
file: 044-数据模型设计文档.md
description: HaiLan Pro 业务数据模型的详细定义，包含实体、属性、关系与约束规则
author: YanYuCloudCube Team
version: v1.0.0
created: 2026-01-26
updated: 2026-01-26
status: published
tags:
  - HaiLan-Pro-详细设计,[]
---

> ***YanYuCloudCube***
> **标语**：言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **标语**：万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 044 数据模型设计文档

## 概述

本文档详细描述HaiLan Pro-HaiLan-Pro-详细设计-数据模型设计文档相关内容，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景
HaiLan Pro (海蓝) 是新一代高端、私密、智能的情趣健康生活管理平台。项目基于「五高五标五化」理念，通过 PWA 技术结合 AI 智能辅助与物联网，为用户提供从生理健康到心理愉悦的全方位解决方案。

#### 1.2 项目愿景
打造极致隐私、智能陪伴、品质合规、全场景覆盖的情趣健康生活管理平台，为用户提供安全、专业、高端的健康生活体验。

#### 1.3 核心价值主张
- **极致隐私**：双重加密、隐私浏览模式及伪装发货机制
- **智能陪伴**：基于 LLM 的 AI 情感与生理健康顾问
- **品质合规**：医疗级标准商品，高端"海蓝蓝"视觉调性
- **全场景覆盖**：PWA 端支持离线浏览、桌面安装及无缝推送

#### 1.4 文档目标
- 规范数据模型设计文档相关的业务标准与技术落地要求
- 为项目相关人员提供清晰的参考依据
- 保障相关模块开发、实施、运维的一致性与规范性

### 2. 设计原则

#### 2.1 五高原则
- **高可用性**：确保系统7x24小时稳定运行，支持PWA离线能力
- **高性能**：优化响应时间和处理能力，支持高并发访问
- **高安全性**：保护用户数据和隐私安全，双重加密机制
- **高扩展性**：支持业务快速扩展，微服务架构设计
- **高可维护性**：便于后续维护和升级，模块化设计

#### 2.2 五标体系
- **标准化**：统一的技术和流程标准
- **规范化**：严格的开发和管理规范
- **自动化**：提高开发效率和质量，CI/CD自动化
- **智能化**：利用AI技术提升能力，LLM智能顾问
- **可视化**：直观的监控和管理界面

#### 2.3 五化架构
- **流程化**：标准化的开发流程
- **文档化**：完善的文档体系
- **工具化**：高效的开发工具链
- **数字化**：数据驱动的决策
- **生态化**：开放的生态系统

### 3. 数据模型设计文档

#### 3.1 数据库架构设计

##### 3.1.1 数据库选型

```typescript
// 数据库架构定义
interface DatabaseArchitecture {
  // PostgreSQL - 关系型数据库
  postgresql: {
    version: 'PostgreSQL 16';
    purpose: '存储核心业务数据';
    features: ['ACID事务', '外键约束', '全文搜索', 'JSON支持'];
    databases: {
      primary: 'hailan_pro_db';
      readonly: 'hailan_pro_readonly_db';
      archive: 'hailan_pro_archive_db';
    };
  };

  // MongoDB - 文档数据库
  mongodb: {
    version: 'MongoDB 7';
    purpose: '存储非结构化数据';
    features: ['灵活Schema', '高吞吐', '水平扩展'];
    databases: {
      primary: 'hailan_mongo_db';
      analytics: 'hailan_analytics_db';
    };
  };

  // Redis - 缓存数据库
  redis: {
    version: 'Redis 7';
    purpose: '缓存和会话存储';
    features: ['内存存储', '发布订阅', 'Sorted Sets'];
    databases: {
      cache: 0,
      session: 1,
      queue: 2,
      rateLimit: 3
    };
  };
}
```

##### 3.1.2 数据分层策略

| 数据层 | 存储介质 | 数据类型 | 保留期限 | 备份策略 |
|-------|---------|---------|---------|---------|
| **热数据** | PostgreSQL + Redis | 活跃用户、实时订单 | 永久 | 实时同步 |
| **温数据** | PostgreSQL | 历史订单、日志数据 | 3年 | 每日备份 |
| **冷数据** | MongoDB归档 | 早期数据、审计日志 | 5年+ | 每周备份 |
| **临时数据** | Redis TTL | 会话、验证码 | 数分钟/小时 | 无需备份 |

#### 3.2 PostgreSQL表设计

##### 3.2.1 用户相关表

```sql
-- 用户表
CREATE TABLE users (
    -- 主键
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_no VARCHAR(20) UNIQUE NOT NULL,        -- 用户编号 (HL + 8位数字)

    -- 账户信息
    phone VARCHAR(20) UNIQUE,                   -- 手机号 (加密)
    phone_hash VARCHAR(64) UNIQUE,              -- 手机号哈希 (用于查询)
    email VARCHAR(255) UNIQUE,                  -- 邮箱 (加密)
    email_hash VARCHAR(64) UNIQUE,              -- 邮箱哈希
    password_hash VARCHAR(255) NOT NULL,        -- 密码哈希 (bcrypt)
    salt VARCHAR(255) NOT NULL,                 -- 密码盐值

    -- 第三方登录
    wechat_openid VARCHAR(128) UNIQUE,          -- 微信OpenID
    alipay_userid VARCHAR(128) UNIQUE,          -- 支付宝UserID
    apple_id VARCHAR(128) UNIQUE,               -- Apple ID

    -- 状态
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- active, suspended, deleted
    verified BOOLEAN NOT NULL DEFAULT FALSE,    -- 是否实名认证
    privacy_level VARCHAR(20) NOT NULL DEFAULT 'standard', -- standard, stealth, disguise

    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    deleted_at TIMESTAMP,

    -- 索引
    CONSTRAINT chk_user_status CHECK (status IN ('active', 'suspended', 'deleted')),
    CONSTRAINT chk_privacy_level CHECK (privacy_level IN ('standard', 'stealth', 'disguise'))
);

CREATE INDEX idx_users_phone ON users(phone_hash);
CREATE INDEX idx_users_email ON users(email_hash);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at DESC);

-- 用户档案表
CREATE TABLE user_profiles (
    profile_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,

    -- 基本信息
    nickname VARCHAR(50),
    avatar_url VARCHAR(500),
    gender VARCHAR(10),                         -- male, female, other
    birth_date DATE,

    -- 偏好设置
    preferences JSONB,                          -- 用户偏好设置
    notification_settings JSONB,                -- 通知设置
    privacy_settings JSONB,                     -- 隐私设置

    -- 会员信息
    member_level VARCHAR(20) NOT NULL DEFAULT 'basic', -- basic, silver, gold, platinum
    member_expires_at TIMESTAMP,

    -- 统计
    login_count INTEGER NOT NULL DEFAULT 0,
    total_orders INTEGER NOT NULL DEFAULT 0,
    total_amount DECIMAL(12,2) NOT NULL DEFAULT 0,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_member_level CHECK (member_level IN ('basic', 'silver', 'gold', 'platinum'))
);

CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);

-- 用户地址表 (加密存储)
CREATE TABLE user_addresses (
    address_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,

    -- 加密地址信息
    recipient_name_encrypted TEXT NOT NULL,     -- 收件人姓名 (加密)
    recipient_phone_encrypted TEXT NOT NULL,    -- 收件人电话 (加密)
    province_encrypted TEXT NOT NULL,           -- 省份 (加密)
    city_encrypted TEXT NOT NULL,               -- 城市 (加密)
    district_encrypted TEXT NOT NULL,           -- 区县 (加密)
    detail_address_encrypted TEXT NOT NULL,     -- 详细地址 (加密)
    postal_code_encrypted TEXT,                 -- 邮编 (加密)

    -- 非加密信息
    address_alias VARCHAR(50),                  -- 地址别名 (如: 家、公司)
    is_default BOOLEAN NOT NULL DEFAULT FALSE,
    is_privacy BOOLEAN NOT NULL DEFAULT FALSE,  -- 是否隐私发货地址

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_addresses_user_id ON user_addresses(user_id);
```

##### 3.2.2 商品相关表

```sql
-- 商品分类表
CREATE TABLE product_categories (
    category_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    category_code VARCHAR(20) UNIQUE NOT NULL,  -- 分类代码
    parent_id UUID REFERENCES product_categories(category_id), -- 父分类

    -- 分类信息
    category_name VARCHAR(100) NOT NULL,
    category_name_en VARCHAR(100),
    description TEXT,
    icon_url VARCHAR(500),

    -- 场景分类
    scenario VARCHAR(20) NOT NULL,              -- CARE, PLAY, INTIMACY, LINGERIE, SMART
    display_order INTEGER NOT NULL DEFAULT 0,

    -- 状态
    is_active BOOLEAN NOT NULL DEFAULT TRUE,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_scenario CHECK (scenario IN ('CARE', 'PLAY', 'INTIMACY', 'LINGERIE', 'SMART'))
);

CREATE INDEX idx_product_categories_scenario ON product_categories(scenario);
CREATE INDEX idx_product_categories_parent ON product_categories(parent_id);

-- 商品表
CREATE TABLE products (
    product_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_no VARCHAR(30) UNIQUE NOT NULL,     -- 商品SKU (HL + 分类码 + 6位数字)
    category_id UUID NOT NULL REFERENCES product_categories(category_id),

    -- 基本信息
    product_name VARCHAR(200) NOT NULL,
    product_name_en VARCHAR(200),
    short_description VARCHAR(500),
    description TEXT,

    -- 价格信息
    price DECIMAL(10,2) NOT NULL,               -- 现价
    original_price DECIMAL(10,2),               -- 原价
    cost_price DECIMAL(10,2),                   -- 成本价

    -- 库存信息
    stock INTEGER NOT NULL DEFAULT 0,
    stock_warn_threshold INTEGER DEFAULT 10,
    sales INTEGER NOT NULL DEFAULT 0,           -- 销量

    -- 商品属性
    brand VARCHAR(100),
    model VARCHAR(100),
    material VARCHAR(200),
    size VARCHAR(100),
    color VARCHAR(100),

    -- 医疗等级
    medical_level VARCHAR(20),                  -- 医疗等级 (如有)
    is_restricted BOOLEAN NOT NULL DEFAULT FALSE, -- 是否限制商品

    -- 评分和标签
    rating DECIMAL(3,2) NOT NULL DEFAULT 0,     -- 平均评分 0-5.00
    review_count INTEGER NOT NULL DEFAULT 0,    -- 评价数量
    tags JSONB,                                 -- 商品标签

    -- 媒体
    cover_image_url VARCHAR(500) NOT NULL,
    images JSONB,                               -- 图片数组

    -- 状态
    status VARCHAR(20) NOT NULL DEFAULT 'draft', -- draft, active, inactive, out_of_stock
    is_featured BOOLEAN NOT NULL DEFAULT FALSE, -- 是否精选

    -- SEO
    slug VARCHAR(200) UNIQUE,
    meta_title VARCHAR(200),
    meta_description TEXT,

    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP,

    CONSTRAINT chk_product_status CHECK (status IN ('draft', 'active', 'inactive', 'out_of_stock')),
    CONSTRAINT chk_price CHECK (price >= 0 AND original_price >= 0)
);

CREATE INDEX idx_products_category ON products(category_id);
CREATE INDEX idx_products_status ON products(status);
CREATE INDEX idx_products_featured ON products(is_featured) WHERE is_featured = TRUE;
CREATE INDEX idx_products_sales ON products(sales DESC);
CREATE INDEX idx_products_rating ON products(rating DESC);
CREATE INDEX idx_products_slug ON products(slug);

-- 商品规格表
CREATE TABLE product_specifications (
    spec_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID NOT NULL REFERENCES products(product_id) ON DELETE CASCADE,

    spec_name VARCHAR(100) NOT NULL,            -- 规格名称 (如: 颜色, 尺寸)
    spec_value VARCHAR(200) NOT NULL,           -- 规格值 (如: 红色, XL)
    spec_order INTEGER NOT NULL DEFAULT 0,

    stock INTEGER NOT NULL DEFAULT 0,
    price_adjustment DECIMAL(10,2) DEFAULT 0,   -- 价格调整

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_product_specifications_product ON product_specifications(product_id);
```

##### 3.2.3 订单相关表

```sql
-- 订单表
CREATE TABLE orders (
    order_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_no VARCHAR(30) UNIQUE NOT NULL,       -- 订单号 (HL + 时间戳 + 随机数)
    user_id UUID NOT NULL REFERENCES users(user_id),

    -- 订单金额
    subtotal_amount DECIMAL(12,2) NOT NULL,     -- 商品小计
    discount_amount DECIMAL(12,2) NOT NULL DEFAULT 0, -- 优惠金额
    shipping_fee DECIMAL(12,2) NOT NULL DEFAULT 0,   -- 运费
    total_amount DECIMAL(12,2) NOT NULL,        -- 订单总额
    paid_amount DECIMAL(12,2),                  -- 实付金额

    -- 订单状态
    status VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending, paid, shipped, delivered, cancelled, refunded
    payment_status VARCHAR(20) NOT NULL DEFAULT 'unpaid', -- unpaid, paying, paid, failed, refunded

    -- 隐私设置
    privacy_level VARCHAR(20) NOT NULL DEFAULT 'standard', -- 发货隐私级别
    is_privacy_shipping BOOLEAN NOT NULL DEFAULT FALSE, -- 是否隐私发货

    -- 发货信息 (加密)
    shipping_info_encrypted JSONB,              -- 加密的发货信息
    shipping_time INTEGER NOT NULL DEFAULT 3,   -- 预计发货时间(天)

    -- 支付信息
    payment_method VARCHAR(20),                 -- wechat, alipay, card
    payment_time TIMESTAMP,

    -- 时间戳
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    paid_at TIMESTAMP,
    shipped_at TIMESTAMP,
    delivered_at TIMESTAMP,
    cancelled_at TIMESTAMP,

    CONSTRAINT chk_order_status CHECK (status IN ('pending', 'paid', 'shipped', 'delivered', 'cancelled', 'refunded')),
    CONSTRAINT chk_payment_status CHECK (payment_status IN ('unpaid', 'paying', 'paid', 'failed', 'refunded'))
);

CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_order_no ON orders(order_no);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_payment_status ON orders(payment_status);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);

-- 订单明细表
CREATE TABLE order_items (
    item_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(order_id) ON DELETE CASCADE,
    product_id UUID NOT NULL REFERENCES products(product_id),

    -- 商品信息 (快照)
    product_name VARCHAR(200) NOT NULL,
    product_no VARCHAR(30) NOT NULL,
    product_image_url VARCHAR(500),
    specifications JSONB,                       -- 规格快照

    -- 数量和价格
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(10,2) NOT NULL,
    subtotal_price DECIMAL(12,2) NOT NULL,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_product_id ON order_items(product_id);
```

##### 3.2.4 IoT设备相关表

```sql
-- IoT设备表
CREATE TABLE iot_devices (
    device_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_no VARCHAR(30) UNIQUE NOT NULL,      -- 设备编号
    user_id UUID REFERENCES users(user_id) ON DELETE SET NULL,

    -- 设备信息
    device_name VARCHAR(100) NOT NULL,
    device_type VARCHAR(50) NOT NULL,           -- 设备类型
    brand VARCHAR(100),
    model VARCHAR(100),

    -- 连接信息
    bluetooth_mac VARCHAR(17),                  -- 蓝牙MAC地址
    firmware_version VARCHAR(50),
    hardware_version VARCHAR(50),

    -- 状态
    is_bound BOOLEAN NOT NULL DEFAULT FALSE,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    last_connected_at TIMESTAMP,
    last_synced_at TIMESTAMP,

    -- 设备设置
    settings JSONB,

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    bound_at TIMESTAMP
);

CREATE INDEX idx_iot_devices_user_id ON iot_devices(user_id);
CREATE INDEX idx_iot_devices_device_no ON iot_devices(device_no);
CREATE INDEX idx_iot_devices_type ON iot_devices(device_type);
```

#### 3.3 MongoDB集合设计

##### 3.3.1 AI对话集合

```typescript
// MongoDB集合设计 - conversations
interface ConversationsCollection {
  _id: ObjectId;
  userId: string;                               // 用户ID
  sessionId: string;                            // 会话ID
  messages: ConversationMessage[];              // 消息数组
  metadata: {
    model: string;                              // 使用的模型
    totalTokens: number;                        // 总Token数
    startTime: Date;                            // 会话开始时间
    endTime?: Date;                             // 会话结束时间
  };
  createdAt: Date;
  updatedAt: Date;
}

interface ConversationMessage {
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
  tokens?: number;
  sources?: string[];                           // RAG来源
}

// 索引
db.conversations.createIndex({ userId: 1, createdAt: -1 });
db.conversations.createIndex({ sessionId: 1 });
db.conversations.createIndex({ updatedAt: -1 }, { expireAfterSeconds: 7776000 }); // 90天后删除
```

##### 3.3.2 推荐记录集合

```typescript
// MongoDB集合设计 - recommendations
interface RecommendationsCollection {
  _id: ObjectId;
  userId: string;
  productId: string;
  algorithm: 'collaborative' | 'content-based' | 'hybrid';
  score: number;                                // 推荐得分
  reason: string;                               // 推荐理由
  context: {
    source: string;                             // 推荐来源
    timestamp: Date;
    userAction?: string;                        // 用户行为
  };
  feedback?: {
    clicked: boolean;
    purchased: boolean;
    rating?: number;
  };
  createdAt: Date;
}

// 索引
db.recommendations.createIndex({ userId: 1, createdAt: -1 });
db.recommendations.createIndex({ productId: 1 });
db.recommendations.createIndex({ score: -1 });
```

##### 3.3.3 审计日志集合

```typescript
// MongoDB集合设计 - audit_logs
interface AuditLogsCollection {
  _id: ObjectId;
  userId?: string;
  action: string;                               // 操作类型
  resource: string;                             // 资源类型
  resourceId?: string;                          // 资源ID
  method: 'GET' | 'POST' | 'PUT' | 'DELETE';
  endpoint: string;
  ip: string;
  userAgent: string;
  status: 'success' | 'failure';
  errorCode?: string;
  metadata: Record<string, any>;
  timestamp: Date;
}

// 索引
db.audit_logs.createIndex({ userId: 1, timestamp: -1 });
db.audit_logs.createIndex({ action: 1, timestamp: -1 });
db.audit_logs.createIndex({ timestamp: -1 }, { expireAfterSeconds: 31536000 }); // 1年后删除
```

#### 3.4 Redis缓存设计

##### 3.4.1 缓存键规范

```typescript
// Redis缓存键设计
interface RedisCacheKeys {
  // 用户会话 (DB 1)
  session: {
    key: `session:${userId}`;
    ttl: 7200;  // 2小时
    value: UserSession;
  };

  // 用户信息缓存 (DB 0)
  userInfo: {
    key: `user:info:${userId}`;
    ttl: 1800;  // 30分钟
    value: UserInfo;
  };

  // 商品缓存 (DB 0)
  product: {
    detail: {
      key: `product:detail:${productId}`;
      ttl: 3600;  // 1小时
    };
    list: {
      key: `product:list:${category}:${page}`;
      ttl: 600;   // 10分钟
    };
  };

  // 购物车 (DB 1)
  cart: {
    key: `cart:${userId}`;
    ttl: 86400;  // 24小时
    value: Cart;
  };

  // 接口限流 (DB 3)
  rateLimit: {
    key: `ratelimit:${userId}:${api}`;
    ttl: 60;     // 1分钟
    value: number; // 请求次数
  };

  // 分布式锁 (DB 2)
  lock: {
    key: `lock:${resource}:${id}`;
    ttl: 30;     // 30秒自动释放
  };
}
```

##### 3.4.2 缓存数据结构

```typescript
// 用户会话结构
interface UserSession {
  userId: string;
  token: string;
  refreshToken: string;
  loginTime: Date;
  lastActivity: Date;
  deviceInfo: {
    type: 'mobile' | 'tablet' | 'desktop';
    os: string;
    browser: string;
  };
  permissions: string[];
}

// 购物车结构
interface Cart {
  userId: string;
  items: CartItem[];
  totalAmount: number;
  updatedAt: Date;
}

interface CartItem {
  productId: string;
  quantity: number;
  specifications?: Record<string, string>;
  addedAt: Date;
}
```

#### 3.5 数据关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据关系ER图                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┐     ┌──────────────┐     ┌──────────────┐         │
│  │  users   │────<│user_profiles │     │user_addresses │         │
│  │          │ 1:1 │              │ 1:N │              │         │
│  └──────────┘     └──────────────┘     └──────────────┘         │
│        │
│        │ 1:N
│        ▼
│  ┌──────────┐     ┌──────────┐     ┌──────────────┐              │
│  │  orders  │────<│order_items│     │product_specs │              │
│  │          │ 1:N │          │ N:1 │              │              │
│  └──────────┘     └──────────┘     └──────────────┘              │
│        │                                            │             │
│        │ N:1                                        │             │
│        ▼                                            ▼             │
│  ┌──────────┐                                ┌──────────┐        │
│  │ products │────────────────────────────────│categories│        │
│  │          │ N:1                            │          │        │
│  └──────────┘                                └──────────┘        │
│        │
│        │ 1:N
│        ▼
│  ┌──────────┐                                                       │
│  │iot_devices│                                                      │
│  │          │                                                       │
│  └──────────┘                                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.6 数据迁移与备份

##### 3.6.1 备份策略

| 数据类型 | 备份频率 | 保留期限 | 存储位置 |
|---------|---------|---------|---------|
| PostgreSQL | 每日全量 + 每小时增量 | 30天 | 阿里云OSS |
| MongoDB | 每日全量 | 30天 | 阿里云OSS |
| Redis | 每日RDB + 实时AOF | 7天 | 本地存储 |

##### 3.6.2 数据归档

```typescript
// 数据归档策略
interface DataArchivePolicy {
  // 订单归档
  orders: {
    condition: 'created_at < NOW() - INTERVAL 3 years';
    destination: 'hailan_pro_archive_db.orders_archive';
    frequency: 'monthly';
  };

  // 日志归档
  logs: {
    condition: 'timestamp < NOW() - INTERVAL 6 months';
    destination: 'MongoDB archive collection';
    frequency: 'weekly';
  };

  // 对话归档
  conversations: {
    condition: 'updatedAt < NOW() - INTERVAL 90 days';
    destination: 'MongoDB archive collection';
    frequency: 'daily';
    ttl: 2592000; // 30天后删除
  };
}
```

---

## 附录

### A. 完整ER图

### B. 索引优化建议

### C. 数据迁移脚本

### D. 术语表

| 术语 | 说明 |
|-----|------|
| **UUID** | Universally Unique Identifier，通用唯一标识符 |
| **JSONB** | JSON Binary，PostgreSQL的二进制JSON类型 |
| **TTL** | Time To Live，存活时间 |
| **RDB** | Redis Database，Redis数据库文件 |

### E. 修订历史

| 版本 | 日期 | 修订人 | 修订内容 |
|-----|------|-------|---------|
| v1.0.0 | 2026-01-26 | YanYuCloudCube Team | 初始版本创建 |

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
