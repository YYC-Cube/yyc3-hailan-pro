---
file: 129-性能测试方案.md
description: HaiLan Pro 性能测试方案，包含压力测试、并发测试、响应时间测试
author: YanYuCloudCube Team
version: v1.0.0
created: 2026-01-26
updated: 2026-01-26
status: published
tags:
  - HaiLan-Pro-审核测试,[]
---

> ***YanYuCloudCube***
> **标语**：言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **标语**：万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 129 性能测试方案

## 概述

本文档详细描述HaiLan Pro-HaiLan-Pro-审核测试-性能测试方案相关内容，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景
HaiLan Pro (海蓝) 是新一代高端、私密、智能的情趣健康生活管理平台。项目基于「五高五标五化」理念，通过 PWA 技术结合 AI 智能辅助与物联网，为用户提供从生理健康到心理愉悦的全方位解决方案。

#### 1.2 项目愿景
打造极致隐私、智能陪伴、品质合规、全场景覆盖的情趣健康生活管理平台，为用户提供安全、专业、高端的健康生活体验。

#### 1.3 核心价值主张
- **极致隐私**：双重加密、隐私浏览模式及伪装发货机制
- **智能陪伴**：基于 LLM 的 AI 情感与生理健康顾问
- **品质合规**：医疗级标准商品，高端"海蓝蓝"视觉调性
- **全场景覆盖**：PWA 端支持离线浏览、桌面安装及无缝推送

#### 1.4 文档目标
- 规范性能测试方案相关的业务标准与技术落地要求
- 为项目相关人员提供清晰的参考依据
- 保障相关模块开发、实施、运维的一致性与规范性

### 2. 设计原则

#### 2.1 五高原则
- **高可用性**：确保系统7x24小时稳定运行，支持PWA离线能力
- **高性能**：优化响应时间和处理能力，支持高并发访问
- **高安全性**：保护用户数据和隐私安全，双重加密机制
- **高扩展性**：支持业务快速扩展，微服务架构设计
- **高可维护性**：便于后续维护和升级，模块化设计

#### 2.2 五标体系
- **标准化**：统一的技术和流程标准
- **规范化**：严格的开发和管理规范
- **自动化**：提高开发效率和质量，CI/CD自动化
- **智能化**：利用AI技术提升能力，LLM智能顾问
- **可视化**：直观的监控和管理界面

#### 2.3 五化架构
- **流程化**：标准化的开发流程
- **文档化**：完善的文档体系
- **工具化**：高效的开发工具链
- **数字化**：数据驱动的决策
- **生态化**：开放的生态系统

### 3. 性能测试方案

#### 3.1 测试目标与指标

HaiLan Pro 性能测试旨在确保系统在各种负载条件下保持高性能、高可用性。

```yaml
性能测试目标:

  响应时间指标:
    API响应时间:
      - P50 < 100ms
      - P95 < 200ms
      - P99 < 500ms

    页面加载时间:
      - 首屏渲染(FCP) < 1.5s
      - 完全加载(LCP) < 2.5s
      - 可交互时间(TTI) < 3.5s

    AI响应时间:
      - 对话响应 < 3s
      - 推荐生成 < 1s

  吞吐量指标:
    - 并发用户数: 10000+
    - QPS(Query Per Second): 5000+
    - TPS(Transaction Per Second): 1000+

  资源利用率:
    CPU使用率:
      - 正常负载: < 60%
      - 峰值负载: < 85%

    内存使用率:
      - 正常负载: < 70%
      - 峰值负载: < 90%

    数据库连接:
      - 活跃连接: < 80%
      - 等待连接: < 5%
```

#### 3.2 负载测试

使用 JMeter/K6 进行负载测试，验证系统在高并发下的表现。

```typescript
// k6/load-test/api-load-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate, Trend } from 'k6/metrics';

// 自定义指标
const errorRate = new Rate('errors');
const responseTime = new Trend('response_time');

// 测试配置
export const options = {
  stages: [
    { duration: '2m', target: 100 },   // 预热：2分钟到100用户
    { duration: '5m', target: 500 },   // 加压：5分钟到500用户
    { duration: '10m', target: 1000 }, // 峰值：10分钟到1000用户
    { duration: '5m', target: 500 },   // 减压：5分钟到500用户
    { duration: '2m', target: 0 },     // 恢复：2分钟到0用户
  ],
  thresholds: {
    http_req_duration: ['p(95)<200', 'p(99)<500'],
    http_req_failed: ['rate<0.01'],
    errors: ['rate<0.05'],
  },
};

const BASE_URL = __ENV.BASE_URL || 'https://api.hailan.pro';

// 测试数据
const testUsers = JSON.parse(open('./test-users.json'));

export function setup() {
  // 登录获取token
  const tokens = [];
  for (const user of testUsers.slice(0, 100)) {
    const loginRes = http.post(`${BASE_URL}/auth/login`, JSON.stringify({
      email: user.email,
      password: user.password,
    }), {
      headers: { 'Content-Type': 'application/json' },
    });

    if (loginRes.status === 200) {
      tokens.push(JSON.parse(loginRes.body).accessToken);
    }
  }
  return { tokens };
}

export default function(data) {
  // 随机选择用户token
  const token = data.tokens[Math.floor(Math.random() * data.tokens.length)];
  const headers = {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  };

  // 测试场景1: 获取商品列表
  const listRes = http.get(`${BASE_URL}/products?page=1&limit=20`, { headers });

  check(listRes, {
    '商品列表状态码200': (r) => r.status === 200,
    '商品列表响应时间<200ms': (r) => r.timings.duration < 200,
    '返回商品数据': (r) => JSON.parse(r.body).data.length > 0,
  }) || errorRate.add(1);

  responseTime.add(listRes.timings.duration);
  sleep(1);

  // 测试场景2: 获取商品详情
  const productId = 'prod-001';
  const detailRes = http.get(`${BASE_URL}/products/${productId}`, { headers });

  check(detailRes, {
    '商品详情状态码200': (r) => r.status === 200,
    '商品详情响应时间<150ms': (r) => r.timings.duration < 150,
  }) || errorRate.add(1);

  sleep(1);

  // 测试场景3: AI对话测试
  const chatRes = http.post(`${BASE_URL}/ai/chat`, JSON.stringify({
    message: '你好，我想咨询一些健康问题',
    context: { conversationId: `test-${__VU}` },
  }), { headers });

  check(chatRes, {
    'AI对话状态码200': (r) => r.status === 200,
    'AI响应时间<3s': (r) => r.timings.duration < 3000,
    '返回AI回复': (r) => JSON.parse(r.body).reply !== undefined,
  }) || errorRate.add(1);

  sleep(2);
}

export function teardown(data) {
  console.log('测试完成，清理资源...');
}
```

#### 3.3 压力测试

```typescript
// k6/stress-test/stress-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '1m', target: 100 },
    { duration: '2m', target: 500 },
    { duration: '3m', target: 1000 },
    { duration: '5m', target: 2000 },  // 超出预期负载
    { duration: '5m', target: 3000 },  // 极限压力
    { duration: '5m', target: 4000 },  // 破坏点测试
    { duration: '2m', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<1000'], // 压力下放宽要求
    http_req_failed: ['rate<0.1'],     // 允许少量错误
  },
};

const BASE_URL = 'https://api.hailan.pro';

export default function() {
  const payload = JSON.stringify({
    email: `test${__VU}@hailan.pro`,
    password: 'TestPassword123!',
  });

  const params = {
    headers: { 'Content-Type': 'application/json' },
  };

  // 注册接口压力测试
  const res = http.post(`${BASE_URL}/auth/register`, payload, params);

  check(res, {
    '状态码<500': (r) => r.status < 500,
    '响应时间<5s': (r) => r.timings.duration < 5000,
  });

  sleep(1);
}
```

#### 3.4 前端性能测试

```typescript
// playwright/performance/frontend-performance.spec.ts
import { test, expect } from '@playwright/test';

test.describe('前端性能测试', () => {
  test('首页性能指标', async ({ page }) => {
    // 启用性能追踪
    await page.goto('/');

    const metrics = await page.evaluate(() => {
      const timing = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
      const paint = performance.getEntriesByType('paint');

      return {
        // 核心Web指标
        FCP: paint.find(p => p.name === 'first-contentful-paint')?.startTime,
        LCP: performance.getEntriesByType('largest-contentful-paint')[0]?.startTime,
        FID: performance.getEntriesByType('first-input')[0]?.processingStart,

        // 传统指标
        DOMContentLoaded: timing.domContentLoadedEventEnd - timing.domContentLoadedEventStart,
        LoadComplete: timing.loadEventEnd - timing.loadEventStart,
        TTFB: timing.responseStart - timing.requestStart,

        // 资源指标
        resourceCount: performance.getEntriesByType('resource').length,
      };
    });

    // 验证性能指标
    expect(metrics.FCP).toBeLessThan(1500); // 首次内容绘制 < 1.5s
    expect(metrics.LCP).toBeLessThan(2500); // 最大内容绘制 < 2.5s
    expect(metrics.FID).toBeLessThan(100);  // 首次输入延迟 < 100ms
    expect(metrics.TTFB).toBeLessThan(600); // 首字节时间 < 600ms

    console.log('性能指标:', metrics);
  });

  test('商品列表页面渲染性能', async ({ page }) => {
    const startTime = Date.now();

    await page.goto('/products');

    // 等待列表渲染完成
    await page.waitForSelector('.product-card', { timeout: 5000 });

    const renderTime = Date.now() - startTime;

    // 获取渲染的商品数量
    const productCount = await page.locator('.product-card').count();

    expect(renderTime).toBeLessThan(2000);
    expect(productCount).toBeGreaterThan(0);

    // 测量滚动性能
    const scrollStartTime = Date.now();
    await page.mouse.wheel(0, 1000);
    await page.waitForTimeout(500);

    const scrollTime = Date.now() - scrollStartTime;
    expect(scrollTime).toBeLessThan(1000); // 滚动响应 < 1s
  });

  test('PWA离线缓存性能', async ({ page }) => {
    // 首次访问建立缓存
    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // 第二次访问应该使用缓存
    const startTime = Date.now();
    await page.reload();
    const cacheLoadTime = Date.now() - startTime;

    // 缓存加载应该更快
    expect(cacheLoadTime).toBeLessThan(1000);

    // 验证Service Worker状态
    const swStatus = await page.evaluate(async () => {
      const reg = await navigator.serviceWorker.getRegistration();
      return {
        active: !!reg?.active,
        state: reg?.active?.state,
      };
    });

    expect(swStatus.active).toBe(true);
    expect(swStatus.state).toBe('activated');
  });

  test('内存使用检测', async ({ page, context }) => {
    await page.goto('/');

    // 模拟长时间使用
    for (let i = 0; i < 10; i++) {
      await page.goto('/products');
      await page.goto('/products/prod-001');
      await page.goto('/cart');
    }

    // 获取内存使用
    const memoryMetrics = await page.evaluate(() => {
      return {
        jsHeapSizeLimit: (performance as any).memory?.jsHeapSizeLimit,
        totalJSHeapSize: (performance as any).memory?.totalJSHeapSize,
        usedJSHeapSize: (performance as any).memory?.usedJSHeapSize,
      };
    });

    // 验证内存没有明显泄漏
    const memoryUsageRatio = memoryMetrics.usedJSHeapSize / memoryMetrics.jsHeapSizeLimit;
    expect(memoryUsageRatio).toBeLessThan(0.5); // 内存使用率 < 50%

    console.log('内存指标:', memoryMetrics);
  });
});
```

#### 3.5 数据库性能测试

```sql
-- SQL性能测试脚本

-- 1. 查询性能测试
EXPLAIN ANALYZE
SELECT u.id, u.email, up.nickname, u.privacy_level
FROM users u
LEFT JOIN user_profiles up ON u.id = up.user_id
WHERE u.privacy_level = 'STANDARD'
  AND u.created_at > NOW() - INTERVAL '30 days'
ORDER BY u.created_at DESC
LIMIT 20;

-- 2. 索引效果验证
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE user_id = 'user-123'
  AND status IN ('PENDING', 'PROCESSING')
ORDER BY created_at DESC;

-- 3. 复杂关联查询测试
EXPLAIN ANALYZE
SELECT
  o.id,
  o.total_amount,
  o.status,
  json_agg(
    json_build_object(
      'product_name', p.name,
      'quantity', oi.quantity,
      'price', oi.price
    )
  ) as items
FROM orders o
JOIN order_items oi ON o.id = oi.order_id
JOIN products p ON oi.product_id = p.id
WHERE o.user_id = 'user-123'
GROUP BY o.id
ORDER BY o.created_at DESC;

-- 4. 批量插入性能测试
-- 测试10000条记录插入时间
\timing on

INSERT INTO user_activities (user_id, activity_type, metadata)
SELECT
  'user-' || (random() * 1000)::int,
  (ARRAY['PAGE_VIEW', 'PRODUCT_VIEW', 'SEARCH'])[floor(random() * 3 + 1)],
  jsonb_build_object('timestamp', NOW())
FROM generate_series(1, 10000);

\timing off

-- 5. 并发查询测试
-- 使用pgbench进行并发测试
-- pgbench -c 50 -j 10 -T 60 hailan-pro
```

#### 3.6 API性能基准测试

```typescript
// __tests__/performance/api-benchmark.test.ts
import { describe, it, expect } from 'bun:test';
import { benchmark, BenchmarkResult } from 'bun';

describe('API性能基准测试', () => {
  const API_BASE = 'http://localhost:3000/api';
  let authToken: string;

  beforeAll(async () => {
    // 获取测试token
    const res = await fetch(`${API_BASE}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: 'test@hailan.pro',
        password: 'password123',
      }),
    });
    const data = await res.json();
    authToken = data.accessToken;
  });

  benchmark('GET /products - 商品列表查询', async () => {
    const res = await fetch(`${API_BASE}/products`, {
      headers: { 'Authorization': `Bearer ${authToken}` },
    });
    expect(res.status).toBe(200);
  });

  benchmark('GET /products/:id - 商品详情查询', async () => {
    const res = await fetch(`${API_BASE}/products/prod-001`, {
      headers: { 'Authorization': `Bearer ${authToken}` },
    });
    expect(res.status).toBe(200);
  });

  benchmark('POST /ai/chat - AI对话', async () => {
    const res = await fetch(`${API_BASE}/ai/chat`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: '你好',
      }),
    });
    expect(res.status).toBe(200);
  });

  benchmark('POST /cart/items - 添加购物车', async () => {
    const res = await fetch(`${API_BASE}/cart/items`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        productId: 'prod-001',
        quantity: 1,
      }),
    });
    expect(res.ok).toBe(true);
  });

  benchmark('PATCH /user/privacy-level - 隐私等级切换', async () => {
    const res = await fetch(`${API_BASE}/user/privacy-level`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        privacyLevel: 'STEALTH',
      }),
    });
    expect(res.status).toBe(200);
  });
});
```

#### 3.7 性能监控指标

```yaml
性能监控配置:

  APM监控:
    service: "HaiLan-Pro-API"
    environment: "production"

    traces:
      - name: "HTTP请求"
        sampling: 0.1  # 10%采样率
        attributes:
          - "user.id"
          - "privacy.level"

      - name: "数据库查询"
        sampling: 0.05  # 5%采样率
        slow_threshold: 100ms

      - name: "AI调用"
        sampling: 1.0  # 100%采样
        attributes:
          - "model"
          - "tokens"

  告警规则:
    - name: "API响应时间告警"
      condition: "p95响应时间 > 500ms"
      duration: "5m"
      severity: "warning"

    - name: "错误率告警"
      condition: "错误率 > 1%"
      duration: "3m"
      severity: "critical"

    - name: "数据库连接池告警"
      condition: "活跃连接数 > 80%"
      duration: "2m"
      severity: "warning"

    - name: "内存使用告警"
      condition: "内存使用率 > 85%"
      duration: "5m"
      severity: "warning"
```

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
