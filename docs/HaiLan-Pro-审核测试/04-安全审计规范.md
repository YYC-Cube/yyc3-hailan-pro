# 海蓝 (HaiLan) Pro - 安全审计规范

> **合规与风险防护的最后一公里**
> **关联脚本**: `scripts/security/securityTestPlan.md` (已整合)

---

## 1. 安全测试目标

- **数据保护**: 确保用户隐私（手机、身份证、支付信息）不泄露。
- **系统可用**: 防范 DDoS 攻击、逻辑漏洞导致的系统崩溃。
- **合规性**: 符合《网络安全法》、PCI-DSS（支付）等行业标准。

---

## 2. 审计分类与流程

### 2.1 静态应用安全测试 (SAST)
- **定义**: 不运行代码，通过工具分析源代码、配置文件、依赖库。
- **工具**: SonarQube, Snyk, npm audit。
- **执行**: 每次代码提交 (CI 集成)。
- **覆盖**:
    - 硬编码密码/密钥。
    - 不安全的函数调用 (`eval`, `innerHTML`)。
    - 过时的依赖库 (存在 CVE 漏洞)。

### 2.2 动态应用安全测试 (DAST)
- **定义**: 在系统运行时，通过模拟攻击扫描漏洞。
- **工具**: OWASP ZAP, Burp Suite, Nikto。
- **执行**: 部署至 Staging 环境后，上线前。
- **覆盖**:
    - SQL 注入 (SQLi)。
    - 跨站脚本攻击 (XSS)。
    - 跨站请求伪造 (CSRF)。
    - 服务器端请求伪造 (SSRF)。

### 2.3 渗透测试
- **定义**: 模拟黑客攻击手法，进行深度测试（特别是业务逻辑漏洞）。
- **方式**: 黑盒测试（无内部信息）+ 灰盒测试（基于 API 文档）。
- **执行**: 每季度一次，或重大版本上线前。
- **覆盖**:
    - 越权访问 (IDOR): 修改 URL 访问他人订单/地址。
    - 业务逻辑绕过: 修改库存为负数、重复使用优惠券。
    - 暴力破解: 登录接口。

---

## 3. OWASP Top 10 检查清单

| 类别 | 检查项 | 测试方法 | 风险等级 | 修复方案 |
|------|-------|---------|---------|---------|
| **A01: 访问控制失效** | 水平/垂直越权 | 手工修改 URL 参数 | Critical | 后端鉴权，绑定用户ID |
| **A02: 加密失效** | 敏感数据明文传输 | Wireshark 抓包 | Critical | 强制 HTTPS, 数据库字段加密 |
| **A03: 注入** | SQLi, NoSQLi, XSS | 输入 `' or 1=1`, `<script>` | Critical | 参数化查询，输入转义 |
| **A04: 不安全设计** | 优惠券无限用 | 手工测试 | High | 后端业务校验，限制次数 |
| **A05: 安全配置错误** | 服务器版本泄露 | Nikto 扫描, Curl 查看响应头 | Low | 隐藏版本号, 关闭 Debug 模式 |
| **A06: 易受攻击组件** | 依赖库 CVE | Snyk 扫描 | High | 升级依赖库至最新版 |
| **A07: 身份识别失效** | 弱密码策略 | 注册 `123456` | Medium | 强密码规则, 锁定机制 |
| **A08: 完整性失效** | 支付金额篡改 | Proxy 拦截修改包 | Critical | 后端二次校验金额，签名验证 |
| **A09: 日志失效** | 登录失败无记录 | 尝试错误密码 10 次 | Medium | 记录 IP, 时间, 错误原因 |
| **A10: 服务器端伪造** | 访问内网资源 | 输入 URL `http://localhost` | High | 验证 URL 白名单, 拦截内网IP |

---

## 4. 安全加固标准

### 4.1 Web 层
- **HTTPS**: 全站强制跳转，SSL Labs 评级 A+。
- **安全头**:
    - `Strict-Transport-Security (HSTS)`: max-age=31536000; includeSubDomains; preload
    - `Content-Security-Policy (CSP)`: default-src 'self'; script-src 'self' 'unsafe-inline'
    - `X-Frame-Options`: DENY
    - `X-Content-Type-Options`: nosniff
- **WAF**: 启用 AWS WAF，配置规则（IP Sets, Rate Limits, Geo Blocking）。

### 4.2 应用层
- **输入验证**: 所有用户输入（URL参数、表单、文件名）必须白名单验证。
- **输出转义**: 所有输出到 HTML 的内容必须转义，防止 XSS。
- **认证**:
    - 密码加密: `bcrypt` (cost factor 12)。
    - Session: HttpOnly, Secure, SameSite。
    - JWT: 短期过期 (7天), 签名验证。

### 4.3 数据层
- **最小权限**: 数据库用户仅有增删改查权限，无 Drop 权限。
- **加密存储**: 手机号、身份证号、支付密码加密存储 (AES-256)。
- **定期备份**: 异地备份，备份文件加密。

---

## 5. 安全审计报告

### 5.1 报告结构

```markdown
# 安全审计报告 (SA-20260204-01)

## 1. 审计概况
- **日期**: 2026-02-04
- **环境**: Staging
- **审计人员**: Security Team
- **范围**: Web应用, API接口, 移动端

## 2. 漏洞发现
| ID | 漏洞名称 | 风险等级 | 位置 | 修复建议 | 状态 |
|-----|---------|---------|------|---------|------|
| SEC-001 | SQL注入 | Critical | /search?q= | 参数化查询 | 待修复 |
| SEC-002 | 越权访问 | High | /api/orders/123 | 权限校验 | 已修复 |

## 3. 依赖库扫描
- 扫描工具: Snyk
- 发现漏洞: 0 High, 2 Low
- 修复建议: 升级 `moment.js` 至 v2.x

## 4. 合规性检查
- [x] 数据传输加密
- [x] 敏感信息脱敏
- [x] 隐私政策链接
- [ ] 定期安全审计 (需补签)

## 5. 结论
- **总体评级**: B+ (存在 1 个 Critical 漏洞，需修复后上线)
- **上线决策**: **不通过**，需修复 SEC-001 并重新审计。
```

### 5.2 风险定级

| 等级 | 定义 | 响应时间 |
|------|------|----------|
| **Critical** | 导致数据泄露、系统被控 | 4小时 (阻断上线) |
| **High** | 绕过认证、注入漏洞 | 24小时 (阻断上线) |
| **Medium** | 一般性XSS、信息泄露 | 3天 (可挂起上线) |
| **Low** | 版本泄露、无实际危害 | 1周 (延后修复) |

---

## 6. 应急响应

若在线上发生安全事件（如数据泄露）：
1. **止损**: 立即关闭受影响服务或页面，阻断流量。
2. **取证**: 保留日志，分析攻击来源和方式。
3. **修复**: 修复漏洞代码，升级防御措施。
4. **通报**: 依据法律法规，上报相关监管机构，通知受影响用户。
5. **复盘**: 更新安全策略，增加自动化检测规则。

---

## 7. 常用工具指令

```bash
# 1. 依赖漏洞扫描 (npm)
npm audit --audit-level=high

# 2. 依赖漏洞扫描
snyk test

# 3. OWASP ZAP 扫描
zap-cli quick-scan --self-contained -r report.html https://staging.hailan.com

# 4. SSL 评级 (在线)
# 访问 https://www.ssllabs.com/ssltest/

# 5. Git Secrets 扫描
gitleaks detect --source . --report-format json
```
