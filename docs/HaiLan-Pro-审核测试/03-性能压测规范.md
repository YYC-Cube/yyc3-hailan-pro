# 海蓝 (HaiLan) Pro - 性能压测规范

> **容量规划与SLA保障的基石**
> **关联脚本**: `scripts/performance/loadTest.k6.js`, `scripts/performance/executionGuide.md` (已整合)

---

## 1. 性能测试定义

性能测试通过模拟真实用户行为，对系统施加负载，以评估系统的**响应速度、吞吐量、稳定性和资源利用率**。

---

## 2. 测试类型与目标

### 2.1 基准测试
- **定义**: 在单用户或低并发下，建立系统性能基线。
- **时机**: 系统初次上线，或硬件升级后。
- **输出**: 无负载下的 FCP, TTI, API 响应时间基准值。

### 2.2 负载测试
- **定义**: 模拟预期生产环境峰值流量（如大促期间）。
- **时机**: 每次大版本发布前。
- **输出**: 在预期流量下的系统表现（验证是否达标）。

### 2.3 压力测试
- **定义**: 不断增加并发用户数，直到系统崩溃或响应时间急剧恶化。
- **时机**: 寻找系统极限（SPOF - Single Point of Failure）。
- **输出**: 系统最大承载能力（Max Users）和崩溃点。

### 2.4 浸泡/稳定性测试
- **定义**: 在接近最大负载下，持续运行较长一段时间（通常 24h - 72h）。
- **时机**: 上线前或长时间停机后。
- **输出**: 系统是否存在内存泄露、连接池耗尽等随时间劣化的问题。

---

## 3. 性能指标 (SLA - Service Level Agreement)

### 3.1 前端性能指标

| 指标 | 目标值 (SLA) | 达标阈值 | 工具 |
|------|-------------|----------|------|
| **First Contentful Paint (FCP)** | < 1.8s | < 2.0s | Lighthouse |
| **Largest Contentful Paint (LCP)** | < 2.5s | < 4.0s | Lighthouse |
| **Time to Interactive (TTI)** | < 3.8s | < 7.3s | Lighthouse |
| **Total Blocking Time (TBT)** | < 200ms | < 600ms | Lighthouse |
| **Cumulative Layout Shift (CLS)** | < 0.1 | < 0.25 | Lighthouse |
| **Lighthouse Score** | > 90 | > 75 | Lighthouse |

### 3.2 后端性能指标

| 指标 | 目标值 (SLA) | 达标阈值 | 工具 |
|------|-------------|----------|------|
| **95th Percentile Response Time (p95)** | < 1000ms | < 2000ms | k6 / APM |
| **99th Percentile Response Time (p99)** | < 2000ms | < 5000ms | k6 / APM |
| **Average Response Time** | < 500ms | < 1000ms | k6 |
| **Requests Per Second (RPS)** | > 100 | > 50 | k6 |
| **Error Rate (HTTP 4xx/5xx)** | < 0.5% | < 1.0% | k6 |
| **Max Concurrent Users** | > 200 | > 100 | k6 |

### 3.3 资源利用率指标

| 资源 | 警告阈值 | 危险阈值 | 动作 |
|------|----------|----------|------|
| **Web Server CPU** | 70% | 90% | 自动扩容或报警 |
| **Database CPU** | 75% | 90% | 检查慢查询，优化索引 |
| **Memory Usage** | 80% | 95% | 检查内存泄露，重启服务 |

---

## 4. k6 脚本编写规范

### 4.1 脚本结构
标准性能测试脚本包含：导入、选项、默认函数、检查点。

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

// 1. 配置选项
export let options = {
  stages: [
    { duration: '2m', target: 10 },  // 爬坡
    { duration: '5m', target: 50 },  // 峰值
    { duration: '2m', target: 0 },  // 降坡
  ],
  thresholds: {
    http_req_duration: ['p(95)<1000'], // SLA
    http_req_failed: ['rate<0.01'],   // 错误率 < 1%
  },
};

// 2. 默认函数 (每个VU每次迭代执行)
export default function () {
  // 请求
  let res = http.get('https://api.hailan.com/products');

  // 检查点 (断言)
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });

  // 思考时间
  sleep(1);
}
```

### 4.2 场景模拟
真实用户行为包含“浏览”、“思考”、“点击”。
- **使用 `sleep()`**: 模拟用户阅读、思考时间（如浏览商品详情后停留 2s）。
- **随机化**: 使用 `Math.random()` 选择不同的商品ID，避免缓存击穿。

### 4.3 数据驱动
将测试数据（如商品ID列表）存储在 JSON 文件中，通过 `open()` 读取，实现参数化测试。

---

## 5. 压测执行流程

### 5.1 前置准备
1.  **环境检查**: 确认 Staging 环境运行正常，数据充足。
2.  **基准测试**: 先运行单用户测试，记录 p50, p95, p99 值。
3.  **配置监控**: 开启 CloudWatch/Grafana Dashboard，准备接收压测数据。

### 5.2 压测执行
1.  **部署脚本**: 确保 `scripts/performance/loadTest.k6.js` 是最新。
2.  **启动压测**:
    ```bash
    # 本地执行
    k6 run scripts/performance/loadTest.k6.js

    # Docker 执行 (更接近生产网络环境)
    docker run --rm -i -v $PWD:/scripts loadimpact/k6 run /scripts/loadTest.k6.js
    ```
3.  **实时观察**: 关注响应时间曲线、错误率。若错误率 > 1%，立即暂停压测，排查原因。

### 5.3 结果分析
1.  **导出报告**:
    ```bash
    k6 run --out json=report.json scripts/performance/loadTest.k6.js
    ```
2.  **对比 SLA**: 检查 p95, p99 是否达标。
3.  **定位瓶颈**: 查看 CloudWatch 指标，是数据库慢（DB CPU 高）还是网络带宽（Outbound Traffic 高）。

---

## 6. 性能调优与回归

### 6.1 常见瓶颈与调优方案

| 瓶颈现象 | 可能原因 | 调优方案 |
|---------|----------|---------|
| **API 响应慢 (p99 > 2000ms)** | 数据库查询慢 | 添加索引，优化 SQL，使用 Redis 缓存。 |
| **DB CPU 高 ( > 90% )** | 复杂聚合查询 | 读写分离，物化视图，缓存结果。 |
| **高并发下 502 错误** | Nginx 连接数满 | 调整 `worker_processes`, 增加后端 Pod 数量。 |
| **前端加载慢 (FCP > 3s)** | 资源体积大 | 启用 Brotli 压缩，CDN 预热，Code Splitting。 |

### 6.2 性能回归
每次压测后，记录结果至《性能测试报告》。
- **下次压测前**: 必须对比上次结果，若性能下降（退化），需回溯代码变更，定位原因。
- **自动化监控**: Lighthouse CI 在每次 Pull Request 时检测，防止性能退化。

---

## 7. 压测报告模板

```markdown
# 性能测试报告 (PT-20260204-01)

## 1. 测试概况
- **日期**: 2026-02-04
- **环境**: Staging
- **工具**: k6
- **类型**: 负载测试

## 2. 测试配置
- **目标并发**: 200 VU
- **测试时长**: 10m
- **RPS 峰值**: 150

## 3. SLA 达标情况
| 指标 | 目标 | 实际 | 状态 |
|------|------|------|------|
| p95 Response Time | < 1000ms | 850ms | ✅ PASS |
| Error Rate | < 0.5% | 0.02% | ✅ PASS |
| Max VUs | > 200 | 300 | ✅ PASS |

## 4. 资源监控
- **Web CPU**: 峰值 55% (正常)
- **DB CPU**: 峰值 68% (正常)

## 5. 结论与建议
**结论**: 性能优于预期 SLA，系统可支持 200 并发。
**建议**: 无重大瓶颈，可按计划上线。
```
