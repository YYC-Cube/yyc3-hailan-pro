---
@file: 149-日志管理系统.md
@description: HaiLan Pro 日志管理系统，包含日志收集、日志存储、日志分析
@author: YanYuCloudCube Team
@version: v1.0.0
@created: 2026-01-26
@updated: 2026-01-26
@status: published
@tags: [HaiLan-Pro-部署运维],[]
---

> ***YanYuCloudCube***
> **标语**：言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **标语**：万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 149 日志管理系统

## 概述

本文档详细描述HaiLan Pro-HaiLan-Pro-部署运维-日志管理系统相关内容，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景
HaiLan Pro (海蓝) 是新一代高端、私密、智能的情趣健康生活管理平台。项目基于「五高五标五化」理念，通过 PWA 技术结合 AI 智能辅助与物联网，为用户提供从生理健康到心理愉悦的全方位解决方案。

#### 1.2 项目愿景
打造极致隐私、智能陪伴、品质合规、全场景覆盖的情趣健康生活管理平台，为用户提供安全、专业、高端的健康生活体验。

#### 1.3 核心价值主张
- **极致隐私**：双重加密、隐私浏览模式及伪装发货机制
- **智能陪伴**：基于 LLM 的 AI 情感与生理健康顾问
- **品质合规**：医疗级标准商品，高端"海蓝蓝"视觉调性
- **全场景覆盖**：PWA 端支持离线浏览、桌面安装及无缝推送

#### 1.4 文档目标
- 规范日志管理系统相关的业务标准与技术落地要求
- 为项目相关人员提供清晰的参考依据
- 保障相关模块开发、实施、运维的一致性与规范性

### 2. 设计原则

#### 2.1 五高原则
- **高可用性**：确保系统7x24小时稳定运行，支持PWA离线能力
- **高性能**：优化响应时间和处理能力，支持高并发访问
- **高安全性**：保护用户数据和隐私安全，双重加密机制
- **高扩展性**：支持业务快速扩展，微服务架构设计
- **高可维护性**：便于后续维护和升级，模块化设计

#### 2.2 五标体系
- **标准化**：统一的技术和流程标准
- **规范化**：严格的开发和管理规范
- **自动化**：提高开发效率和质量，CI/CD自动化
- **智能化**：利用AI技术提升能力，LLM智能顾问
- **可视化**：直观的监控和管理界面

#### 2.3 五化架构
- **流程化**：标准化的开发流程
- **文档化**：完善的文档体系
- **工具化**：高效的开发工具链
- **数字化**：数据驱动的决策
- **生态化**：开放的生态系统

### 3. 日志管理系统

#### 3.1 日志架构

HaiLan Pro 采用 ELK (Elasticsearch, Logstash, Kibana) 栈构建集中式日志管理系统。

**日志架构：**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           日志采集层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ Filebeat    │ │ Fluentd     │ │ App Logs    │ │ Nginx Logs  │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           日志处理层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐                                      │
│  │ Logstash    │ │ Filters     │                                      │
│  │ (Parser)    │ │ (Grok/Mutate)│                                     │
│  └─────────────┘  └─────────────┘                                      │
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           日志存储层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                     Elasticsearch Cluster                          ││
│  │                    (3 Nodes, 1 Replica)                            ││
│  └─────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           日志展示层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐                                      │
│  │ Kibana      │ │ Grafana     │                                      │
│  │ (Dashboard) │ │ (Visualization)│                                    │
│  └─────────────┘  └─────────────┘                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.2 日志格式规范

**标准日志格式：**

```json
{
  "@timestamp": "2026-01-26T10:30:45.123Z",
  "level": "info",
  "message": "User login successful",
  "service": "hailan-frontend",
  "environment": "production",
  "context": {
    "userId": "uuid-1234",
    "sessionId": "sess-5678",
    "requestId": "req-abcd"
  },
  "error": {
    "stack": "Error: ...",
    "code": "ERR_001"
  }
}
```

**日志级别定义：**

| 级别 | 用途 | 示例场景 |
|------|------|----------|
| TRACE | 最详细的调试信息 | 函数入口/出口 |
| DEBUG | 调试信息 | 变量值、中间状态 |
| INFO | 一般信息 | 用户操作、业务流程 |
| WARN | 警告信息 | 降级、重试 |
| ERROR | 错误信息 | 异常、失败操作 |
| FATAL | 致命错误 | 服务不可用 |

#### 3.3 日志收集配置

**Filebeat 配置：**

```yaml
# filebeat.yml
filebeat.inputs:
  - type: container
    paths:
      - '/var/log/containers/hailan-*.log'
    processors:
      - add_kubernetes_metadata:
          host: ${NODE_NAME}
          matchers:
            - logs_path:
                logs_path: "/var/log/containers/"
      - drop_event:
          when:
            equals:
              kubernetes.container.name: "filebeat"

output.logstash:
  hosts: ["logstash:5044"]
  compression_level: 3
  bulk_max_size: 2048

logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644
```

**Logstash 配置：**

```ruby
# logstash.conf
input {
  beats {
    port => 5044
  }
}

filter {
  # 解析 JSON 日志
  json {
    source => "message"
  }

  # Kubernetes 元数据
  if [kubernetes][container][name] {
    mutate {
      add_field => {
        "service" => "%{[kubernetes][container][name]}"
      }
    }
  }

  # 时间戳处理
  date {
    match => ["timestamp", "ISO8601"]
  }

  # 移除不需要的字段
  mutate {
    remove_field => ["message", "agent", "ecs", "log"]
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "hailan-pro-%{+YYYY.MM.dd}"
    user => "elastic"
    password => "${ELASTICSEARCH_PASSWORD}"
  }
}
```

#### 3.4 日志查询

**常用查询语句：**

```bash
# 查看错误日志
level:ERROR

# 查看特定服务日志
service:hailan-frontend

# 查看特定用户操作
context.userId:"uuid-1234"

# 查看最近的错误
level:ERROR AND @timestamp:[now-1h TO now]

# 统计错误类型
level:ERROR | stats count by error.code
```

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
