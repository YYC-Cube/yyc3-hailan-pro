---
file: 141-部署架构设计.md
description: HaiLan Pro 部署架构设计，包含容器化部署、负载均衡、高可用方案
author: YanYuCloudCube Team
version: v1.0.0
created: 2026-01-26
updated: 2026-01-26
status: published
tags:
  - HaiLan-Pro-部署运维,[]
---

> ***YanYuCloudCube***
> **标语**：言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **标语**：万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 141 部署架构设计

## 概述

本文档详细描述HaiLan Pro-HaiLan-Pro-部署运维-部署架构设计相关内容，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景
HaiLan Pro (海蓝) 是新一代高端、私密、智能的情趣健康生活管理平台。项目基于「五高五标五化」理念，通过 PWA 技术结合 AI 智能辅助与物联网，为用户提供从生理健康到心理愉悦的全方位解决方案。

#### 1.2 项目愿景
打造极致隐私、智能陪伴、品质合规、全场景覆盖的情趣健康生活管理平台，为用户提供安全、专业、高端的健康生活体验。

#### 1.3 核心价值主张
- **极致隐私**：双重加密、隐私浏览模式及伪装发货机制
- **智能陪伴**：基于 LLM 的 AI 情感与生理健康顾问
- **品质合规**：医疗级标准商品，高端"海蓝蓝"视觉调性
- **全场景覆盖**：PWA 端支持离线浏览、桌面安装及无缝推送

#### 1.4 文档目标
- 规范部署架构设计相关的业务标准与技术落地要求
- 为项目相关人员提供清晰的参考依据
- 保障相关模块开发、实施、运维的一致性与规范性

### 2. 设计原则

#### 2.1 五高原则
- **高可用性**：确保系统7x24小时稳定运行，支持PWA离线能力
- **高性能**：优化响应时间和处理能力，支持高并发访问
- **高安全性**：保护用户数据和隐私安全，双重加密机制
- **高扩展性**：支持业务快速扩展，微服务架构设计
- **高可维护性**：便于后续维护和升级，模块化设计

#### 2.2 五标体系
- **标准化**：统一的技术和流程标准
- **规范化**：严格的开发和管理规范
- **自动化**：提高开发效率和质量，CI/CD自动化
- **智能化**：利用AI技术提升能力，LLM智能顾问
- **可视化**：直观的监控和管理界面

#### 2.3 五化架构
- **流程化**：标准化的开发流程
- **文档化**：完善的文档体系
- **工具化**：高效的开发工具链
- **数字化**：数据驱动的决策
- **生态化**：开放的生态系统

### 3. 部署架构设计

#### 3.1 总体部署架构

HaiLan Pro 采用基于容器化的云原生部署架构，通过分层设计实现高可用、高性能、高安全的部署目标。

**部署架构图：**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                  用户层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ 移动端 PWA  │  │ 桌面端 Web  │  │ Figma 预览  │  │ 管理后台     │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                CDN + WAF 层                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
│  │  CDN 节点    │  │  WAF 防护   │  │  DDoS 防护  │                         │
│  └─────────────┘  └─────────────┘  └─────────────┘                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              负载均衡层 (Nginx)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
│  │  Nginx LB   │  │  SSL 终结   │  │  反向代理    │                         │
│  └─────────────┘  └─────────────┘  └─────────────┘                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Kubernetes 集群层                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐      │
│  │   Frontend Pod    │  │   Backend Pod     │  │   Worker Pod      │      │
│  │  (React + Nginx)  │  │  (Supabase API)   │  │  (Async Jobs)     │      │
│  │   Replicas: 3     │  │   Replicas: 2     │  │   Replicas: 2     │      │
│  └───────────────────┘  └───────────────────┘  └───────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据持久层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ PostgreSQL  │  │    IPFS     │  │   Redis     │  │   S3/MinIO  │       │
│  │ (Supabase)  │  │  (敏感数据)  │  │   缓存      │  │  (静态资源)  │       │
│  │  Primary    │  │  Cluster    │  │   Cluster   │  │   Bucket    │       │
│  │  + Standby  │  │             │  │             │  │             │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            监控与运维层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ Prometheus  │  │   Grafana   │  │ ELK Stack   │  │   AlertMgr  │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.2 部署环境划分

**环境策略：**

| 环境 | 用途 | 集群配置 | 数据隔离 |
|------|------|----------|----------|
| 开发环境 (DEV) | 日常开发测试 | 单节点小型集群 | 独立数据库 |
| 预发环境 (STAGING) | 集成测试、UAT | 中型集群 + 完整监控 | 生产数据脱敏副本 |
| 生产环境 (PROD) | 真实用户服务 | 高可用多集群 | 生产数据库 + 主从复制 |

**环境配置管理：**

```yaml
# 环境配置示例 (values.yaml)
environment:
  name: production
  replicaCount:
    frontend: 3
    backend: 2
    worker: 2

resources:
  frontend:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
```

#### 3.3 容器化部署方案

**前端容器 (React + Nginx)：**

```dockerfile
# 多阶段构建优化镜像大小
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN bun install
COPY . .
RUN bun run build

# 生产镜像使用 Nginx
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY docker/nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost/health || exit 1
```

**后端容器 (Supabase Edge Functions)：**

```dockerfile
FROM denoland/deno:alpine
WORKDIR /app
COPY . .
RUN deno cache --reload <supabase/functions/**/*.ts>
EXPOSE 8080
CMD ["deno", "run", "--allow-net", "--allow-env", "index.ts"]
```

#### 3.4 Kubernetes 部署清单

**Frontend Deployment：**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hailan-frontend
  namespace: hailan-pro
spec:
  replicas: 3
  selector:
    matchLabels:
      app: hailan-frontend
  template:
    metadata:
      labels:
        app: hailan-frontend
        version: v1.0.0
    spec:
      containers:
      - name: frontend
        image: hailan.pro/frontend:v1.0.0
        ports:
        - containerPort: 80
          name: http
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
        env:
        - name: VITE_API_URL
          value: "https://api.hailan.pro"
        - name: VITE_SUPABASE_URL
          valueFrom:
            secretKeyRef:
              name: supabase-secrets
              key: url
```

**Service：**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: hailan-frontend-service
  namespace: hailan-pro
spec:
  selector:
    app: hailan-frontend
  ports:
  - port: 80
    targetPort: 80
    name: http
  type: ClusterIP
```

**HorizontalPodAutoscaler：**

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: hailan-frontend-hpa
  namespace: hailan-pro
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: hailan-frontend
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
```

#### 3.5 数据库部署架构

**PostgreSQL 主从复制：**

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: hailan-postgres
  namespace: hailan-pro
spec:
  instances: 3
  primaryUpdateStrategy: unsupervised
  postgresql:
    parameters:
      max_connections: "200"
      shared_buffers: "256MB"
      effective_cache_size: "1GB"
  bootstrap:
    initdb:
      database: hailan
      owner: hailan_user
      secret:
        name: hailan-postgres-credentials
  storage:
    size: 100Gi
    storageClass: fast-ssd
  monitoring:
    enabled: true
```

**备份策略：**

- **全量备份**：每天凌晨 2:00 执行
- **增量备份**：每小时执行 WAL 归档
- **备份保留**：保留 30 天
- **异地备份**：同步至对象存储 (S3/MinIO)

#### 3.6 缓存层部署

**Redis Cluster：**

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: hailan-redis
  namespace: hailan-pro
spec:
  serviceName: hailan-redis
  replicas: 6
  selector:
    matchLabels:
      app: hailan-redis
  template:
    metadata:
      labels:
        app: hailan-redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        command:
        - redis-server
        - /conf/redis.conf
        - --cluster-enabled yes
        ports:
        - containerPort: 6379
          name: client
        - containerPort: 16379
          name: gossip
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
```

#### 3.7 高可用架构

**多可用区部署：**

```
可用区 A (CN-North-1a)          可用区 B (CN-North-1b)
┌─────────────────────┐        ┌─────────────────────┐
│ Frontend: 2 Pods    │        │ Frontend: 1 Pod     │
│ Backend: 1 Pod      │   <->  │ Backend: 1 Pod      │
│ Redis: Master       │        │ Redis: Slave        │
│ PG: Primary         │        │ PG: Standby         │
└─────────────────────┘        └─────────────────────┘
```

**故障转移策略：**

| 组件 | 故障检测时间 | 转移时间 | 转移方式 |
|------|-------------|----------|----------|
| Frontend Pod | 10s | 30s | Kubernetes 自动重建 |
| Backend Pod | 10s | 30s | Kubernetes 自动重建 |
| PostgreSQL Master | 30s | 60s | Patroni 自动选举 |
| Redis Master | 5s | 10s | Redis Cluster 自动选举 |

#### 3.8 负载均衡策略

**Nginx Ingress 配置：**

```nginx
upstream hailan_frontend {
    least_conn;
    server hailan-frontend-1.hailan-pro.svc.cluster.local:80 max_fails=3 fail_timeout=30s;
    server hailan-frontend-2.hailan-pro.svc.cluster.local:80 max_fails=3 fail_timeout=30s;
    server hailan-frontend-3.hailan-pro.svc.cluster.local:80 max_fails=3 fail_timeout=30s;

    keepalive 32;
    keepalive_timeout 60s;
}

server {
    listen 443 ssl http2;
    server_name hailan.pro;

    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;

    # 静态资源缓存
    location /static/ {
        proxy_pass http://hailan_frontend;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API 代理
    location /api/ {
        proxy_pass http://hailan-backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # PWA 资源
    location / {
        proxy_pass http://hailan_frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 3.9 安全架构

**网络隔离：**

```yaml
# NetworkPolicy 示例
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hailan-network-policy
  namespace: hailan-pro
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: hailan-postgres
    ports:
    - protocol: TCP
      port: 5432
```

**密钥管理：**

- 使用 Kubernetes Secrets 存储敏感配置
- 集成 External Secrets Operator 从外部密钥管理系统同步
- 定期轮换数据库密码、API 密钥

#### 3.10 部署流程

**CI/CD 部署流程：**

```
代码提交 → GitHub Actions 触发
         ↓
    代码扫描 (ESLint, Prettier)
         ↓
    单元测试 (Vitest)
         ↓
    构建 Docker 镜像
         ↓
    推送至镜像仓库
         ↓
    更新 Kubernetes Deployment
         ↓
    健康检查验证
         ↓
    自动化冒烟测试
         ↓
    部署成功 / 回滚
```

**灰度发布策略：**

1. **金丝雀发布**：先发布 5% 流量到新版本
2. **监控验证**：观察错误率、响应时间、用户反馈
3. **逐步放量**：每 15 分钟增加 25% 流量
4. **全量切换**：100% 流量切换到新版本
5. **清理旧版本**：下线旧版本 Pod

#### 3.11 监控告警

**关键指标监控：**

| 指标类型 | 监控项 | 告警阈值 |
|----------|--------|----------|
| 应用层 | Pod 重启次数 | > 3次/小时 |
| 应用层 | HTTP 5xx 错误率 | > 1% |
| 应用层 | API 响应时间 P99 | > 500ms |
| 资源层 | CPU 使用率 | > 80% |
| 资源层 | 内存使用率 | > 85% |
| 资源层 | 磁盘使用率 | > 80% |
| 数据库 | 连接数 | > 180 (max 200) |
| 数据库 | 慢查询数量 | > 10/min |

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
