---
@file: 150-备份恢复方案.md
@description: HaiLan Pro 备份恢复方案，包含数据备份、灾难恢复、容灾方案
@author: YanYuCloudCube Team
@version: v1.0.0
@created: 2026-01-26
@updated: 2026-01-26
@status: published
@tags: [HaiLan-Pro-部署运维],[]
---

> ***YanYuCloudCube***
> **标语**：言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **标语**：万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 150 备份恢复方案

## 概述

本文档详细描述HaiLan Pro-HaiLan-Pro-部署运维-备份恢复方案相关内容，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景
HaiLan Pro (海蓝) 是新一代高端、私密、智能的情趣健康生活管理平台。项目基于「五高五标五化」理念，通过 PWA 技术结合 AI 智能辅助与物联网，为用户提供从生理健康到心理愉悦的全方位解决方案。

#### 1.2 项目愿景
打造极致隐私、智能陪伴、品质合规、全场景覆盖的情趣健康生活管理平台，为用户提供安全、专业、高端的健康生活体验。

#### 1.3 核心价值主张
- **极致隐私**：双重加密、隐私浏览模式及伪装发货机制
- **智能陪伴**：基于 LLM 的 AI 情感与生理健康顾问
- **品质合规**：医疗级标准商品，高端"海蓝蓝"视觉调性
- **全场景覆盖**：PWA 端支持离线浏览、桌面安装及无缝推送

#### 1.4 文档目标
- 规范备份恢复方案相关的业务标准与技术落地要求
- 为项目相关人员提供清晰的参考依据
- 保障相关模块开发、实施、运维的一致性与规范性

### 2. 设计原则

#### 2.1 五高原则
- **高可用性**：确保系统7x24小时稳定运行，支持PWA离线能力
- **高性能**：优化响应时间和处理能力，支持高并发访问
- **高安全性**：保护用户数据和隐私安全，双重加密机制
- **高扩展性**：支持业务快速扩展，微服务架构设计
- **高可维护性**：便于后续维护和升级，模块化设计

#### 2.2 五标体系
- **标准化**：统一的技术和流程标准
- **规范化**：严格的开发和管理规范
- **自动化**：提高开发效率和质量，CI/CD自动化
- **智能化**：利用AI技术提升能力，LLM智能顾问
- **可视化**：直观的监控和管理界面

#### 2.3 五化架构
- **流程化**：标准化的开发流程
- **文档化**：完善的文档体系
- **工具化**：高效的开发工具链
- **数字化**：数据驱动的决策
- **生态化**：开放的生态系统

### 3. 备份恢复方案

#### 3.1 备份策略

HaiLan Pro 采用多层次备份策略，确保数据安全和业务连续性。

**备份类型：**

| 备份类型 | 频率 | 保留期 | 存储位置 |
|----------|------|--------|----------|
| 全量备份 | 每天 02:00 | 30 天 | 对象存储 + 异地 |
| 增量备份 | 每小时 | 7 天 | 对象存储 |
| WAL 日志 | 实时 | 3 天 | 对象存储 |
| 配置备份 | 每次变更 | 90 天 | Git 仓库 |

#### 3.2 数据库备份

**PostgreSQL 备份脚本：**

```bash
#!/bin/bash
# backup-postgres.sh

set -e

BACKUP_DIR="/backup/postgres"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="hailan_pro_${DATE}.sql.gz"

# 创建备份目录
mkdir -p ${BACKUP_DIR}

# 执行备份
pg_dump ${DATABASE_URL} | gzip > ${BACKUP_DIR}/${BACKUP_FILE}

# 上传到对象存储
aws s3 cp ${BACKUP_DIR}/${BACKUP_FILE} \
  s3://hailan-backups/postgresql/${BACKUP_FILE}

# 清理本地文件
rm ${BACKUP_DIR}/${BACKUP_FILE}

# 清理旧备份 (保留30天)
aws s3 ls s3://hailan-backups/postgresql/ | \
  grep "PRE" | \
  awk '{print $2}' | \
  while read prefix; do
    date=$(echo $prefix | cut -d'_' -f1)
    if [ $(date -d "$date -30 days" +%Y%m%d) -gt 0 ]; then
      aws s3 rm s3://hailan-backups/postgresql/${prefix}
    fi
  done

echo "Backup completed: ${BACKUP_FILE}"
```

**Crontab 配置：**

```bash
# crontab -e
0 2 * * * /scripts/backup-postgres.sh >> /var/log/backup.log 2>&1
```

#### 3.3 Redis 备份

**Redis 备份配置：**

```bash
#!/bin/bash
# backup-redis.sh

REDIS_HOST="localhost"
REDIS_PORT="6379"
REDIS_PASSWORD="${REDIS_PASSWORD}"
BACKUP_DIR="/backup/redis"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="redis_${DATE}.rdb"

# 创建备份目录
mkdir -p ${BACKUP_DIR}

# 触发 BGSAVE
redis-cli -h ${REDIS_HOST} -p ${REDIS_PORT} -a ${REDIS_PASSWORD} BGSAVE

# 等待备份完成
while [ $(redis-cli -h ${REDIS_HOST} -p ${REDIS_PORT} -a ${REDIS_PASSWORD} LASTSAVE) -eq $(redis-cli -h ${REDIS_HOST} -p ${REDIS_PORT} -a ${REDIS_PASSWORD} LASTSAVE) ]; do
  sleep 1
done

# 复制 RDB 文件
cp /var/lib/redis/dump.rdb ${BACKUP_DIR}/${BACKUP_FILE}

# 上传到对象存储
aws s3 cp ${BACKUP_DIR}/${BACKUP_FILE} \
  s3://hailan-backups/redis/${BACKUP_FILE}

# 清理本地文件
rm ${BACKUP_DIR}/${BACKUP_FILE}

echo "Redis backup completed: ${BACKUP_FILE}"
```

#### 3.4 IPFS 备份

**IPFS 数据备份：**

```bash
#!/bin/bash
# backup-ipfs.sh

IPFS_CLUSTER_ID="hailan-ipfs"
BACKUP_FILE="ipfs_pins_$(date +%Y%m%d).json"

# 导出所有 Pin 信息
ipfs pin ls --type=recursive | jq -R 'split(" ") | {key: .[0], type: .[1]}' > ${BACKUP_FILE}

# 上传到对象存储
aws s3 cp ${BACKUP_FILE} \
  s3://hailan-backups/ipfs/${BACKUP_FILE}

# 清理本地文件
rm ${BACKUP_FILE}

echo "IPFS backup completed: ${BACKUP_FILE}"
```

#### 3.5 恢复流程

**PostgreSQL 恢复：**

```bash
#!/bin/bash
# restore-postgres.sh

BACKUP_FILE=$1
RESTORE_DIR="/restore/postgres"

# 下载备份文件
aws s3 cp s3://hailan-backups/postgresql/${BACKUP_FILE} ${RESTORE_DIR}/

# 解压并恢复
gunzip -c ${RESTORE_DIR}/${BACKUP_FILE} | psql ${DATABASE_URL}

# 验证恢复
psql ${DATABASE_URL} -c "SELECT COUNT(*) FROM users;"

echo "Restore completed from: ${BACKUP_FILE}"
```

**Redis 恢复：**

```bash
#!/bin/bash
# restore-redis.sh

BACKUP_FILE=$1
RESTORE_DIR="/restore/redis"

# 停止 Redis
systemctl stop redis

# 下载备份文件
aws s3 cp s3://hailan-backups/redis/${BACKUP_FILE} ${RESTORE_DIR}/dump.rdb

# 复制到 Redis 数据目录
cp ${RESTORE_DIR}/dump.rdb /var/lib/redis/dump.rdb

# 修改权限
chown redis:redis /var/lib/redis/dump.rmb

# 启动 Redis
systemctl start redis

echo "Redis restore completed from: ${BACKUP_FILE}"
```

#### 3.6 灾难恢复

**RTO/RPO 目标：**

| 指标 | 目标值 | 说明 |
|------|--------|------|
| RTO (恢复时间) | < 4小时 | 从故障到服务恢复 |
| RPO (数据丢失) | < 1小时 | 最大可接受数据丢失 |

**灾难恢复步骤：**

```
1. 检测故障 (自动化监控)
   ↓
2. 通知响应团队 (告警触发)
   ↓
3. 评估故障影响 (初步分析)
   ↓
4. 启动恢复流程 (切换到备份)
   ↓
5. 验证数据完整性 (数据检查)
   ↓
6. 恢复服务 (启动应用)
   ↓
7. 验证服务可用 (健康检查)
   ↓
8. 故障后复盘 (文档记录)
```

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
