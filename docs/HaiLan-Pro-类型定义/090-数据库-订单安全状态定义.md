---
file: 090-数据库-订单安全状态定义.md
description: HaiLan Pro 订单安全状态(NORMAL/ENCRYPTED_ADDR/ANONYMOUS)枚举值定义
author: YanYuCloudCube Team
version: v1.0.0
created: 2026-01-26
updated: 2026-01-26
status: published
tags:
  - HaiLan-Pro-类型定义,[]
---

> ***YanYuCloudCube***
> **标语**：言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **标语**：万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 090 数据库-订单安全状态定义

## 概述

本文档详细描述HaiLan Pro-HaiLan-Pro-类型定义-数据库-订单安全状态定义相关内容，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景
HaiLan Pro (海蓝) 是新一代高端、私密、智能的情趣健康生活管理平台。项目基于「五高五标五化」理念，通过 PWA 技术结合 AI 智能辅助与物联网，为用户提供从生理健康到心理愉悦的全方位解决方案。

#### 1.2 项目愿景
打造极致隐私、智能陪伴、品质合规、全场景覆盖的情趣健康生活管理平台，为用户提供安全、专业、高端的健康生活体验。

#### 1.3 核心价值主张
- **极致隐私**：双重加密、隐私浏览模式及伪装发货机制
- **智能陪伴**：基于 LLM 的 AI 情感与生理健康顾问
- **品质合规**：医疗级标准商品，高端"海蓝蓝"视觉调性
- **全场景覆盖**：PWA 端支持离线浏览、桌面安装及无缝推送

#### 1.4 文档目标
- 规范数据库-订单安全状态定义相关的业务标准与技术落地要求
- 为项目相关人员提供清晰的参考依据
- 保障相关模块开发、实施、运维的一致性与规范性

### 2. 设计原则

#### 2.1 五高原则
- **高可用性**：确保系统7x24小时稳定运行，支持PWA离线能力
- **高性能**：优化响应时间和处理能力，支持高并发访问
- **高安全性**：保护用户数据和隐私安全，双重加密机制
- **高扩展性**：支持业务快速扩展，微服务架构设计
- **高可维护性**：便于后续维护和升级，模块化设计

#### 2.2 五标体系
- **标准化**：统一的技术和流程标准
- **规范化**：严格的开发和管理规范
- **自动化**：提高开发效率和质量，CI/CD自动化
- **智能化**：利用AI技术提升能力，LLM智能顾问
- **可视化**：直观的监控和管理界面

#### 2.3 五化架构
- **流程化**：标准化的开发流程
- **文档化**：完善的文档体系
- **工具化**：高效的开发工具链
- **数字化**：数据驱动的决策
- **生态化**：开放的生态系统

### 3. 订单安全状态定义

#### 3.1 安全状态枚举

```typescript
/**
 * 订单安全状态枚举
 * 定义订单的隐私保护级别
 */
export enum OrderSecurityLevel {
  /**
   * 普通订单
   * - 使用真实收货信息
   * - 正常物流配送
   * - 标准客服处理
   */
  NORMAL = 'NORMAL',

  /**
   * 加密地址订单
   * - 收货地址加密存储
   * - 仅用户本人可查看
   * - 物流单部分信息隐藏
   */
  ENCRYPTED_ADDR = 'ENCRYPTED_ADDR',

  /**
   * 匿名订单
   * - 使用虚拟收货信息
   * - 通过代收点/自提点配送
   * - 完全隐藏用户真实身份
   * - 使用伪装发货信息
   */
  ANONYMOUS = 'ANONYMOUS'
}
```

#### 3.2 NORMAL 普通订单

```typescript
/**
 * 普通订单配置
 */
export interface NormalOrderConfig {
  /** 安全等级 */
  securityLevel: OrderSecurityLevel.NORMAL;

  /** 收货信息 */
  shipping: {
    /** 使用真实收货人姓名 */
    useRealName: true;
    /** 使用真实联系电话 */
    useRealPhone: true;
    /** 使用真实收货地址 */
    useRealAddress: true;
  };

  /** 物流显示 */
  logistics: {
    /** 显示完整收货信息 */
    showFullInfo: true;
    /** 显示物流详情 */
    showLogistics: true;
    /** 显示物流单号 */
    showTrackingNumber: true;
  };

  /** 发货信息 */
  sender: {
    /** 使用真实发货人 */
    useRealSender: true;
    /** 发货备注公开 */
    noteVisible: true;
  };

  /** 售后服务 */
  afterSale: {
    /** 正常售后流程 */
    standardProcess: true;
    /** 可联系真实信息 */
    contactRealInfo: true;
  };
}
```

#### 3.3 ENCRYPTED_ADDR 加密地址订单

```typescript
/**
 * 加密地址订单配置
 */
export interface EncryptedAddressOrderConfig {
  /** 安全等级 */
  securityLevel: OrderSecurityLevel.ENCRYPTED_ADDR;

  /** 收货信息 */
  shipping: {
    /** 使用真实收货人姓名 */
    useRealName: true;
    /** 使用真实联系电话 */
    useRealPhone: true;
    /** 使用真实收货地址 */
    useRealAddress: true;
    /** 收货信息加密存储 */
    encryptAddress: true;
  };

  /** 加密规则 */
  encryption: {
    /** 加密算法：AES-256-GCM */
    algorithm: 'aes-256-gcm';
    /** 加密字段：receiver_name, receiver_phone, detailed_address */
    encryptedFields: ['receiver_name', 'receiver_phone', 'detailed_address'];
    /** 解密权限：仅订单所有者 */
    decryptPermission: 'owner_only';
  };

  /** 物流显示 */
  logistics: {
    /** 部分隐藏收货信息 */
    maskReceiverInfo: true;
    /** 姓名脱敏：王*明 */
    nameMaskRule: 'surname_only';
    /** 电话脱敏：138****1234 */
    phoneMaskRule: 'middle_hidden';
    /** 地址脱敏：隐藏门牌号 */
    addressMaskRule: 'house_hidden';
    /** 显示物流详情 */
    showLogistics: true;
    /** 显示物流单号 */
    showTrackingNumber: true;
  };

  /** 发货信息 */
  sender: {
    /** 使用真实发货人 */
    useRealSender: true;
    /** 发货备注公开 */
    noteVisible: true;
  };

  /** 售后服务 */
  afterSale: {
    /** 售后需验证身份 */
    requireVerification: true;
    /** 可联系真实信息（需验证） */
    contactRealInfo: true;
  };
}
```

#### 3.4 ANONYMOUS 匿名订单

```typescript
/**
 * 匿名订单配置
 */
export interface AnonymousOrderConfig {
  /** 安全等级 */
  securityLevel: OrderSecurityLevel.ANONYMOUS;

  /** 收货信息 */
  shipping: {
    /** 使用虚拟收货人姓名 */
    useRealName: false;
    /** 使用虚拟联系电话 */
    useRealPhone: false;
    /** 使用虚拟收货地址（代收点） */
    useRealAddress: false;
  };

  /** 虚拟信息生成 */
  virtual: {
    /** 虚拟收货人姓名 */
    virtualReceiverName: string;
    /** 虚拟联系电话（用于取货通知） */
    virtualPhone: string;
    /** 代收点地址 */
    pickupPoint: PickupPoint;
    /** 取件码 */
    pickupCode: string;
    /** 取件码有效期 */
    pickupExpiresAt: Date;
  };

  /** 物流显示 */
  logistics: {
    /** 仅显示代收点信息 */
    showPickupInfoOnly: true;
    /** 隐藏物流详情 */
    showLogistics: false;
    /** 隐藏物流单号 */
    showTrackingNumber: false;
    /** 显示取件码 */
    showPickupCode: true;
  };

  /** 发货信息（伪装） */
  sender: {
    /** 使用伪装发货人名称 */
    useRealSender: false;
    /** 伪装发货人 */
    disguiseSender: {
      /** 常用伪装名称 */
      commonNames: [
        'XX电商仓储',
        'XX物流中心',
        'XX礼品配送',
        'XX日用品配送中心'
      ];
    };
    /** 发货备注伪装 */
    noteVisible: true;
    /** 伪装备注 */
    disguiseNotes: [
      '日用品配送',
      '礼品包裹',
      '通用包裹',
      '生活用品'
    ];
  };

  /** 售后服务 */
  afterSale: {
    /** 售后通过客服中转 */
    requireAgent: true;
    /** 不直接联系真实信息 */
    contactRealInfo: false;
    /** 售后联系虚拟客服号 */
    supportVirtualContact: true;
  };
}
```

#### 3.5 代收点数据结构

```typescript
/**
 * 代收点信息
 */
export interface PickupPoint {
  /** 代收点ID */
  id: string;
  /** 代收点名称 */
  name: string;
  /** 代收点类型 */
  type: PickupPointType;
  /** 联系电话 */
  phone: string;

  /** 地址信息 */
  province: string;
  city: string;
  district: string;
  detailedAddress: string;
  postalCode: string;

  /** 营业信息 */
  businessHours: string;
  /** 服务范围（公里） */
  serviceRadius: number;

  /** 配送时效 */
  deliveryTime: string;

  /** 是否支持24小时自提 */
  support24hSelfPickup: boolean;
}

/**
 * 代收点类型
 */
export enum PickupPointType {
  /** 菜鸟驿站 */
  CAINIAO_STATION = 'cainiao_station',
  /** 丰巢柜 */
  FENGCHAO_LOCKER = 'fengchao_locker',
  /** 便利店代收 */
  CONVENIENCE_STORE = 'convenience_store',
  /** 社区服务站 */
  COMMUNITY_SERVICE = 'community_service',
  /** 物流网点 */
  LOGISTICS_OUTLET = 'logistics_outlet'
}

/**
 * 代收点服务
 */
export class PickupPointService {
  /**
   * 根据用户地址查找附近代收点
   * @param address 用户地址
   * @param radius 搜索半径（公里）
   */
  static async findNearby(
    address: string,
    radius: number = 5
  ): Promise<PickupPoint[]> {
    // TODO: 实现代收点搜索逻辑
    // 1. 解析地址获取经纬度
    // 2. 查找附近代收点
    // 3. 按距离排序返回
    return [];
  }

  /**
   * 生成取件码
   */
  static generatePickupCode(): string {
    const prefix = 'HL';
    const random = Math.random().toString().substring(2, 8);
    return `${prefix}${random}`.toUpperCase();
  }

  /**
   * 验证取件码
   */
  static verifyPickupCode(code: string): boolean {
    // 取件码格式：HL + 6位数字
    return /^HL\d{6}$/.test(code);
  }
}
```

#### 3.6 数据库表设计

```sql
-- ========================================
-- 订单安全配置表 (order_security_config)
-- ========================================
CREATE TABLE order_security_config (
    id                      VARCHAR(32) PRIMARY KEY,
    order_id                VARCHAR(32) NOT NULL UNIQUE REFERENCES orders(id) ON DELETE CASCADE,

    -- 安全等级
    security_level           VARCHAR(30) NOT NULL,
    CHECK (security_level IN ('NORMAL', 'ENCRYPTED_ADDR', 'ANONYMOUS')),

    -- 加密配置（ENCRYPTED_ADDR使用）
    encryption_key          VARCHAR(255),                -- 加密密钥（存储时加密）
    encrypted_data          TEXT,                         -- 加密的收货信息

    -- 虚拟信息（ANONYMOUS使用）
    virtual_receiver_name   VARCHAR(50),
    virtual_receiver_phone  VARCHAR(20),
    pickup_point_id         VARCHAR(32),
    pickup_code             VARCHAR(20),
    pickup_expires_at       TIMESTAMP,

    -- 伪装发货信息
    disguise_sender_name    VARCHAR(100),
    disguise_note           VARCHAR(200),

    -- 物流显示规则
    logistics_display_rule  JSONB DEFAULT '{}'::jsonb,

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_order_security_config_order_id ON order_security_config(order_id);
CREATE INDEX idx_order_security_config_level ON order_security_config(security_level);
CREATE INDEX idx_order_security_config_pickup_code ON order_security_config(pickup_code);
CREATE INDEX idx_order_security_config_expires_at ON order_security_config(pickup_expires_at);

-- ========================================
-- 代收点表 (pickup_points)
-- ========================================
CREATE TABLE pickup_points (
    id                      VARCHAR(32) PRIMARY KEY,

    -- 基本信息
    type                    VARCHAR(30) NOT NULL,
    name                    VARCHAR(100) NOT NULL,
    phone                   VARCHAR(20),

    -- 地址信息
    province                VARCHAR(50) NOT NULL,
    city                    VARCHAR(50) NOT NULL,
    district                VARCHAR(50) NOT NULL,
    detailed_address        VARCHAR(200) NOT NULL,
    postal_code             VARCHAR(10),

    -- 位置信息
    latitude                DECIMAL(10, 8),
    longitude               DECIMAL(11, 8),

    -- 营业信息
    business_hours          VARCHAR(100),
    service_radius          DECIMAL(5, 2) DEFAULT 5,     -- 服务范围（公里）
    delivery_time           VARCHAR(50),                 -- 配送时效

    -- 服务能力
    support_24h_pickup       BOOLEAN DEFAULT FALSE,
    max_package_size        DECIMAL(8, 2),              -- 最大包裹尺寸（cm）
    max_package_weight      DECIMAL(8, 2),              -- 最大包裹重量（kg）

    -- 状态
    is_active               BOOLEAN DEFAULT TRUE,

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 约束
    CONSTRAINT chk_pickup_type CHECK (
        type IN ('CAINIAO_STATION', 'FENGCHAO_LOCKER', 'CONVENIENCE_STORE',
                'COMMUNITY_SERVICE', 'LOGISTICS_OUTLET')
    )
);

CREATE INDEX idx_pickup_points_type ON pickup_points(type);
CREATE INDEX idx_pickup_points_location ON pickup_points USING GIST(
    point(longitude, latitude)
);
CREATE INDEX idx_pickup_points_is_active ON pickup_points(is_active);
```

#### 3.7 订单安全服务

```typescript
/**
 * 订单安全服务
 * 处理订单安全等级的设置和验证
 */
export class OrderSecurityService {
  /**
   * 创建订单时设置安全等级
   * @param userId 用户ID
   * @param orderData 订单数据
   */
  static async createSecureOrder(
    userId: string,
    orderData: CreateOrderDTO
  ): Promise<OrderSecurityConfig> {
    const userPrivacyLevel = await this.getUserPrivacyLevel(userId);

    let securityConfig: OrderSecurityConfig;

    switch (userPrivacyLevel) {
      case PrivacyLevel.DISGUISE:
        securityConfig = await this.createAnonymousOrder(orderData);
        break;
      case PrivacyLevel.STEALTH:
        securityConfig = await this.createEncryptedOrder(orderData);
        break;
      default:
        securityConfig = this.createNormalOrder(orderData);
    }

    return securityConfig;
  }

  /**
   * 创建匿名订单
   * @private
   */
  private static async createAnonymousOrder(
    orderData: CreateOrderDTO
  ): Promise<AnonymousOrderConfig> {
    // 1. 查找附近代收点
    const pickupPoints = await PickupPointService.findNearby(
      orderData.shippingAddress
    );

    if (pickupPoints.length === 0) {
      throw new Error('该地区暂无代收点服务');
    }

    // 2. 选择最近的代收点
    const pickupPoint = pickupPoints[0];

    // 3. 生成虚拟信息
    const virtualInfo = {
      virtualReceiverName: VirtualNicknameGenerator.generateReceiverName(),
      virtualPhone: this.generateVirtualPhone(),
      pickupPoint,
      pickupCode: PickupPointService.generatePickupCode(),
      pickupExpiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
    };

    // 4. 生成伪装发货信息
    const disguiseSender = this.generateDisguiseSender();

    return {
      securityLevel: OrderSecurityLevel.ANONYMOUS,
      shipping: {
        useRealName: false,
        useRealPhone: false,
        useRealAddress: false
      },
      virtual: virtualInfo,
      logistics: {
        showPickupInfoOnly: true,
        showLogistics: false,
        showTrackingNumber: false,
        showPickupCode: true
      },
      sender: {
        useRealSender: false,
        disguiseSender
      },
      afterSale: {
        requireAgent: true,
        contactRealInfo: false,
        supportVirtualContact: true
      }
    };
  }

  /**
   * 创建加密地址订单
   * @private
   */
  private static async createEncryptedOrder(
    orderData: CreateOrderDTO
  ): Promise<EncryptedAddressOrderConfig> {
    // 1. 加密收货信息
    const encryptedData = PrivacyEncryptionService.encrypt(
      JSON.stringify({
        receiverName: orderData.receiverName,
        receiverPhone: orderData.receiverPhone,
        detailedAddress: orderData.detailedAddress
      }),
      PrivacyLevel.STEALTH
    );

    return {
      securityLevel: OrderSecurityLevel.ENCRYPTED_ADDR,
      shipping: {
        useRealName: true,
        useRealPhone: true,
        useRealAddress: true,
        encryptAddress: true
      },
      encryption: {
        algorithm: 'aes-256-gcm',
        encryptedFields: ['receiver_name', 'receiver_phone', 'detailed_address']
      },
      logistics: {
        maskReceiverInfo: true,
        nameMaskRule: 'surname_only',
        phoneMaskRule: 'middle_hidden',
        addressMaskRule: 'house_hidden',
        showLogistics: true,
        showTrackingNumber: true
      },
      sender: {
        useRealSender: true,
        noteVisible: true
      },
      afterSale: {
        requireVerification: true,
        contactRealInfo: true
      }
    };
  }

  /**
   * 创建普通订单
   * @private
   */
  private static createNormalOrder(
    orderData: CreateOrderDTO
  ): NormalOrderConfig {
    return {
      securityLevel: OrderSecurityLevel.NORMAL,
      shipping: {
        useRealName: true,
        useRealPhone: true,
        useRealAddress: true
      },
      logistics: {
        showFullInfo: true,
        showLogistics: true,
        showTrackingNumber: true
      },
      sender: {
        useRealSender: true,
        noteVisible: true
      },
      afterSale: {
        standardProcess: true,
        contactRealInfo: true
      }
    };
  }

  /**
   * 生成伪装发货人
   * @private
   */
  private static generateDisguiseSender(): DisguiseSender {
    const names = [
      'XX电商仓储',
      'XX物流中心',
      'XX礼品配送',
      'XX日用品配送中心'
    ];
    const notes = [
      '日用品配送',
      '礼品包裹',
      '通用包裹',
      '生活用品'
    ];

    return {
      name: names[Math.floor(Math.random() * names.length)],
      note: notes[Math.floor(Math.random() * notes.length)]
    };
  }

  /**
   * 生成虚拟手机号
   * @private
   */
  private static generateVirtualPhone(): string {
    return '170' + Math.random().toString().substring(2, 11);
  }

  /**
   * 获取用户隐私等级
   * @private
   */
  private static async getUserPrivacyLevel(userId: string): Promise<PrivacyLevel> {
    // TODO: 从数据库获取用户隐私等级
    return PrivacyLevel.STANDARD;
  }
}

/**
 * 创建订单DTO
 */
interface CreateOrderDTO {
  receiverName: string;
  receiverPhone: string;
  shippingAddress: string;
  detailedAddress: string;
}

/**
 * 伪装发货人接口
 */
interface DisguiseSender {
  name: string;
  note: string;
}
```

#### 3.8 数据脱敏显示规则

```typescript
/**
 * 数据脱敏工具
 */
export class DataMaskingUtil {
  /**
   * 姓名脱敏 - 只显示姓氏
   * @param name 真实姓名
   */
  static maskName(name: string): string {
    if (!name) return '';
    const surname = name.charAt(0);
    return `${surname}*`;
  }

  /**
   * 手机号脱敏 - 中间4位隐藏
   * @param phone 手机号
   */
  static maskPhone(phone: string): string {
    if (!phone) return '';
    return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
  }

  /**
   * 地址脱敏 - 隐藏门牌号
   * @param address 详细地址
   */
  static maskAddress(address: string): string {
    if (!address) return '';
    // 替换数字门牌号为**
    return address.replace(/\d+号/, '**号');
  }

  /**
   * 身份证号脱敏
   * @param idCard 身份证号
   */
  static maskIdCard(idCard: string): string {
    if (!idCard) return '';
    // 显示前3位和后4位
    return idCard.replace(/(.{3}).*(.{4})/, '$1********$2');
  }

  /**
   * 根据订单安全等级脱敏显示
   * @param data 原始数据
   * @param securityLevel 安全等级
   */
  static maskOrderData(
    data: OrderDisplayData,
    securityLevel: OrderSecurityLevel
  ): OrderDisplayData {
    switch (securityLevel) {
      case OrderSecurityLevel.NORMAL:
        return data; // 不脱敏

      case OrderSecurityLevel.ENCRYPTED_ADDR:
        return {
          ...data,
          receiverName: this.maskName(data.receiverName),
          receiverPhone: this.maskPhone(data.receiverPhone),
          detailedAddress: this.maskAddress(data.detailedAddress)
        };

      case OrderSecurityLevel.ANONYMOUS:
        return {
          receiverName: data.virtualReceiverName,
          receiverPhone: data.virtualPhone, // 虚拟号码不脱敏
          detailedAddress: data.pickupPoint?.address || '代收点地址',
          pickupCode: data.pickupCode
        };

      default:
        return data;
    }
  }
}

/**
 * 订单显示数据接口
 */
interface OrderDisplayData {
  receiverName: string;
  receiverPhone: string;
  detailedAddress: string;
  virtualReceiverName?: string;
  virtualPhone?: string;
  pickupPoint?: PickupPoint;
  pickupCode?: string;
}
```

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
