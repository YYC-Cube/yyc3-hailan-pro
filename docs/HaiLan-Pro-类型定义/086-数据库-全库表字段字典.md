---
@file: 086-数据库-全库表字段字典.md
@description: HaiLan Pro 全数据库所有表、字段的定义、类型、注释、约束的完整字典
@author: YanYuCloudCube Team
@version: v1.0.0
@created: 2026-01-26
@updated: 2026-01-26
@status: published
@tags: [HaiLan-Pro-类型定义],[]
---

> ***YanYuCloudCube***
> **标语**：言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **标语**：万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 086 数据库-全库表字段字典

## 概述

本文档详细描述HaiLan Pro-HaiLan-Pro-类型定义-数据库-全库表字段字典相关内容，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景
HaiLan Pro (海蓝) 是新一代高端、私密、智能的情趣健康生活管理平台。项目基于「五高五标五化」理念，通过 PWA 技术结合 AI 智能辅助与物联网，为用户提供从生理健康到心理愉悦的全方位解决方案。

#### 1.2 项目愿景
打造极致隐私、智能陪伴、品质合规、全场景覆盖的情趣健康生活管理平台，为用户提供安全、专业、高端的健康生活体验。

#### 1.3 核心价值主张
- **极致隐私**：双重加密、隐私浏览模式及伪装发货机制
- **智能陪伴**：基于 LLM 的 AI 情感与生理健康顾问
- **品质合规**：医疗级标准商品，高端"海蓝蓝"视觉调性
- **全场景覆盖**：PWA 端支持离线浏览、桌面安装及无缝推送

#### 1.4 文档目标
- 规范数据库-全库表字段字典相关的业务标准与技术落地要求
- 为项目相关人员提供清晰的参考依据
- 保障相关模块开发、实施、运维的一致性与规范性

### 2. 设计原则

#### 2.1 五高原则
- **高可用性**：确保系统7x24小时稳定运行，支持PWA离线能力
- **高性能**：优化响应时间和处理能力，支持高并发访问
- **高安全性**：保护用户数据和隐私安全，双重加密机制
- **高扩展性**：支持业务快速扩展，微服务架构设计
- **高可维护性**：便于后续维护和升级，模块化设计

#### 2.2 五标体系
- **标准化**：统一的技术和流程标准
- **规范化**：严格的开发和管理规范
- **自动化**：提高开发效率和质量，CI/CD自动化
- **智能化**：利用AI技术提升能力，LLM智能顾问
- **可视化**：直观的监控和管理界面

#### 2.3 五化架构
- **流程化**：标准化的开发流程
- **文档化**：完善的文档体系
- **工具化**：高效的开发工具链
- **数字化**：数据驱动的决策
- **生态化**：开放的生态系统

### 3. 全库表字段字典

#### 3.1 PostgreSQL关系型数据库表结构

##### 3.1.1 用户模块表

```sql
-- ========================================
-- 用户信息表 (users)
-- ========================================
CREATE TABLE users (
    -- 主键
    id                      VARCHAR(32) PRIMARY KEY,        -- 用户唯一标识，格式：user_{timestamp}_{random}

    -- 账号信息
    email                   VARCHAR(100) UNIQUE NOT NULL,  -- 邮箱地址
    phone                   VARCHAR(20) UNIQUE,           -- 手机号码
    password_hash           VARCHAR(255) NOT NULL,        -- 密码哈希（bcrypt）
    nickname                VARCHAR(50),                 -- 用户昵称
    avatar_url              VARCHAR(500),                -- 头像URL

    -- 个人信息
    gender                  VARCHAR(10),                 -- 性别：male/female/other
    birth_date              DATE,                        -- 出生日期（用于年龄验证）
    real_name               VARCHAR(50),                 -- 真实姓名（加密存储）
    id_card_number          VARCHAR(100),                -- 身份证号（加密存储）

    -- 隐私设置
    privacy_level           VARCHAR(20) DEFAULT 'STANDARD', -- 隐私等级：STANDARD/STEALTH/DISGUISE
    privacy_mode_enabled    BOOLEAN DEFAULT TRUE,        -- 是否启用隐私模式
    stealth_mode_enabled    BOOLEAN DEFAULT FALSE,       -- 是否启用隐身模式
    biometric_enabled       BOOLEAN DEFAULT FALSE,       -- 是否启用生物识别

    -- 账户状态
    status                  VARCHAR(20) DEFAULT 'active',  -- 账户状态：active/inactive/banned/deleted
    email_verified          BOOLEAN DEFAULT FALSE,       -- 邮箱是否已验证
    phone_verified          BOOLEAN DEFAULT FALSE,       -- 手机是否已验证
    last_login_at           TIMESTAMP,                   -- 最后登录时间
    last_login_ip           INET,                        -- 最后登录IP

    -- 会员信息
    member_level            VARCHAR(20) DEFAULT 'regular', -- 会员等级：regular/silver/gold/platinum
    member_expire_at        TIMESTAMP,                   -- 会员到期时间
    points_balance          INTEGER DEFAULT 0,           -- 积分余额

    -- 时间戳
    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at              TIMESTAMP,                   -- 软删除时间

    -- 索引
    CONSTRAINT chk_age_18_plus CHECK (
        birth_date IS NULL OR
        EXTRACT(YEAR FROM AGE(birth_date)) >= 18
    )
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_member_level ON users(member_level);
CREATE INDEX idx_users_created_at ON users(created_at DESC);

-- ========================================
-- 用户收货地址表 (user_addresses)
-- ========================================
CREATE TABLE user_addresses (
    id                      VARCHAR(32) PRIMARY KEY,
    user_id                 VARCHAR(32) NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- 地址信息
    receiver_name           VARCHAR(50) NOT NULL,        -- 收货人姓名
    receiver_phone          VARCHAR(20) NOT NULL,        -- 收货人电话
    province                VARCHAR(50) NOT NULL,        -- 省份
    city                    VARCHAR(50) NOT NULL,        -- 城市
    district                VARCHAR(50) NOT NULL,        -- 区县
    detailed_address        VARCHAR(200) NOT NULL,       -- 详细地址
    postal_code             VARCHAR(10),                -- 邮政编码

    -- 隐私设置
    is_encrypted            BOOLEAN DEFAULT FALSE,       -- 是否加密地址
    disguise_name           VARCHAR(50),                -- 伪装收货人名称
    disguise_note           VARCHAR(100),               -- 伪装备注

    -- 状态
    is_default              BOOLEAN DEFAULT FALSE,       -- 是否默认地址
    is_active               BOOLEAN DEFAULT TRUE,        -- 是否有效

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_addresses_user_id ON user_addresses(user_id);
CREATE INDEX idx_user_addresses_is_default ON user_addresses(is_default);

-- ========================================
-- 用户设备表 (user_devices)
-- ========================================
CREATE TABLE user_devices (
    id                      VARCHAR(32) PRIMARY KEY,
    user_id                 VARCHAR(32) NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- 设备信息
    device_type             VARCHAR(20) NOT NULL,        -- 设备类型：ios/android/web/miniprogram
    device_id               VARCHAR(100),                -- 设备唯一标识
    device_name             VARCHAR(100),                -- 设备名称
    os_version              VARCHAR(50),                 -- 操作系统版本
    app_version             VARCHAR(20),                 -- 应用版本

    -- 推送配置
    push_token              VARCHAR(500),                -- 推送令牌
    push_enabled            BOOLEAN DEFAULT TRUE,        -- 是否允许推送

    -- 登录状态
    last_active_at          TIMESTAMP,                   -- 最后活跃时间
    is_active               BOOLEAN DEFAULT TRUE,        -- 是否活跃

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_devices_user_id ON user_devices(user_id);
CREATE INDEX idx_user_devices_device_id ON user_devices(device_id);
```

##### 3.1.2 商品模块表

```sql
-- ========================================
-- 商品分类表 (product_categories)
-- ========================================
CREATE TABLE product_categories (
    id                      VARCHAR(32) PRIMARY KEY,
    parent_id               VARCHAR(32) REFERENCES product_categories(id),

    -- 分类信息
    code                    VARCHAR(50) UNIQUE NOT NULL, -- 分类代码：CARE/PLAY/INTIMACY/LINGERIE/SMART
    name                    VARCHAR(100) NOT NULL,       -- 分类名称
    slug                    VARCHAR(100) UNIQUE NOT NULL, -- URL友好名称
    description            TEXT,                         -- 分类描述
    icon_url                VARCHAR(500),                -- 分类图标

    -- 分类属性
    level                   INTEGER DEFAULT 0,           -- 分类层级：0/1/2
    path                    VARCHAR(500),                -- 分类路径
    sort_order              INTEGER DEFAULT 0,           -- 排序顺序
    is_active               BOOLEAN DEFAULT TRUE,        -- 是否启用

    -- SEO
    meta_title              VARCHAR(200),
    meta_description        VARCHAR(500),
    meta_keywords           VARCHAR(500),

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_product_categories_code ON product_categories(code);
CREATE INDEX idx_product_categories_parent_id ON product_categories(parent_id);

-- ========================================
-- 商品表 (products)
-- ========================================
CREATE TABLE products (
    id                      VARCHAR(32) PRIMARY KEY,
    category_id             VARCHAR(32) NOT NULL REFERENCES product_categories(id),
    sku                     VARCHAR(50) UNIQUE NOT NULL,  -- SKU编号

    -- 商品基本信息
    name                    VARCHAR(200) NOT NULL,        -- 商品名称
    slug                    VARCHAR(200) UNIQUE NOT NULL, -- URL友好名称
    short_desc              VARCHAR(500),                -- 简短描述
    description            TEXT,                         -- 详细描述

    -- 商品图片
    main_image              VARCHAR(500),                -- 主图
    images                  JSONB DEFAULT '[]'::jsonb,    -- 图片数组

    -- 价格信息
    price                   DECIMAL(10,2) NOT NULL,       -- 售价
    original_price          DECIMAL(10,2),               -- 原价
    cost_price              DECIMAL(10,2),               -- 成本价

    -- 库存信息
    stock                   INTEGER DEFAULT 0,           -- 库存数量
    stock_warning           INTEGER DEFAULT 10,          -- 库存预警值

    -- 商品属性
    brand                   VARCHAR(100),                -- 品牌
    material                VARCHAR(100),                -- 材质
    size                    VARCHAR(50),                 -- 尺码
    color                   VARCHAR(50),                 -- 颜色
    weight                  DECIMAL(8,2),                -- 重量（克）

    -- 商品标签
    tags                    JSONB DEFAULT '[]'::jsonb,    -- 标签数组
    is_new                  BOOLEAN DEFAULT FALSE,       -- 是否新品
    is_hot                  BOOLEAN DEFAULT FALSE,       -- 是否热销
    is_recommended          BOOLEAN DEFAULT FALSE,       -- 是否推荐

    -- 销售信息
    sales_count             INTEGER DEFAULT 0,           -- 销售数量
    view_count              INTEGER DEFAULT 0,           -- 浏览数量
    favorite_count          INTEGER DEFAULT 0,           -- 收藏数量
    rating_avg              DECIMAL(3,2) DEFAULT 0,      -- 平均评分
    review_count            INTEGER DEFAULT 0,           -- 评价数量

    -- 状态
    status                  VARCHAR(20) DEFAULT 'draft',  -- 状态：draft/published/discontinued
    is_active               BOOLEAN DEFAULT TRUE,        -- 是否上架
    published_at            TIMESTAMP,                   -- 发布时间

    -- SEO
    meta_title              VARCHAR(200),
    meta_description        TEXT,

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at              TIMESTAMP
);

CREATE INDEX idx_products_category_id ON products(category_id);
CREATE INDEX idx_products_sku ON products(sku);
CREATE INDEX idx_products_status ON products(status);
CREATE INDEX idx_products_is_active ON products(is_active);
CREATE INDEX idx_products_created_at ON products(created_at DESC);
CREATE INDEX idx_products_sales_count ON products(sales_count DESC);

-- ========================================
-- 商品SKU表 (product_skus)
-- ========================================
CREATE TABLE product_skus (
    id                      VARCHAR(32) PRIMARY KEY,
    product_id              VARCHAR(32) NOT NULL REFERENCES products(id) ON DELETE CASCADE,

    -- SKU信息
    sku_code                VARCHAR(50) UNIQUE NOT NULL,  -- SKU编码
    spec_name               VARCHAR(200),                -- 规格名称

    -- 价格库存
    price                   DECIMAL(10,2) NOT NULL,
    stock                   INTEGER DEFAULT 0,

    -- 规格属性
    spec_attributes         JSONB DEFAULT '{}'::jsonb,  -- 规格属性：{size: "M", color: "红色"}

    is_active               BOOLEAN DEFAULT TRUE,
    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_product_skus_product_id ON product_skus(product_id);
CREATE INDEX idx_product_skus_sku_code ON product_skus(sku_code);
```

##### 3.1.3 订单模块表

```sql
-- ========================================
-- 订单表 (orders)
-- ========================================
CREATE TABLE orders (
    id                      VARCHAR(32) PRIMARY KEY,
    user_id                 VARCHAR(32) NOT NULL REFERENCES users(id),
    order_no                VARCHAR(50) UNIQUE NOT NULL,  -- 订单号：HL{date}{random}

    -- 订单金额
    total_amount            DECIMAL(10,2) NOT NULL,       -- 订单总额
    discount_amount         DECIMAL(10,2) DEFAULT 0,      -- 优惠金额
    shipping_amount         DECIMAL(10,2) DEFAULT 0,      -- 运费
    payable_amount          DECIMAL(10,2) NOT NULL,       -- 应付金额
    paid_amount             DECIMAL(10,2) DEFAULT 0,      -- 实付金额

    -- 商品信息摘要
    product_summary         JSONB DEFAULT '{}'::jsonb,   -- 商品摘要：{items: [{productId, name, quantity, price}]}

    -- 收货地址
    receiver_name           VARCHAR(50) NOT NULL,        -- 收货人
    receiver_phone          VARCHAR(20) NOT NULL,        -- 收货电话
    receiver_address        VARCHAR(500) NOT NULL,       -- 收货地址

    -- 订单状态
    status                  VARCHAR(20) DEFAULT 'pending', -- 订单状态：pending/paid/shipped/completed/cancelled/refunding
    payment_status          VARCHAR(20) DEFAULT 'unpaid', -- 支付状态：unpaid/partial/refunded
    shipping_status         VARCHAR(20) DEFAULT 'unshipped', -- 物流状态：unshipped/shipped/delivered

    -- 安全状态
    security_level          VARCHAR(30) DEFAULT 'NORMAL', -- 安全状态：NORMAL/ENCRYPTED_ADDR/ANONYMOUS

    -- 时间记录
    paid_at                 TIMESTAMP,                   -- 支付时间
    shipped_at              TIMESTAMP,                   -- 发货时间
    completed_at            TIMESTAMP,                   -- 完成时间
    cancelled_at            TIMESTAMP,                   -- 取消时间

    -- 备注
    user_remark             VARCHAR(500),                -- 用户备注
    admin_remark            VARCHAR(500),                -- 管理员备注

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_order_no ON orders(order_no);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_payment_status ON orders(payment_status);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);

-- ========================================
-- 订单商品明细表 (order_items)
-- ========================================
CREATE TABLE order_items (
    id                      VARCHAR(32) PRIMARY KEY,
    order_id                VARCHAR(32) NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    product_id              VARCHAR(32) NOT NULL REFERENCES products(id),
    sku_id                  VARCHAR(32) REFERENCES product_skus(id),

    -- 商品信息快照
    product_name            VARCHAR(200) NOT NULL,       -- 商品名称
    product_image           VARCHAR(500),                -- 商品图片
    sku_code                VARCHAR(50),                 -- SKU编码
    spec_name               VARCHAR(200),                -- 规格名称

    -- 价格数量
    unit_price              DECIMAL(10,2) NOT NULL,      -- 单价
    quantity                INTEGER NOT NULL,            -- 数量
    subtotal                DECIMAL(10,2) NOT NULL,      -- 小计

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_product_id ON order_items(product_id);
```

##### 3.1.4 AI对话模块表

```sql
-- ========================================
-- AI对话会话表 (ai_conversations)
-- ========================================
CREATE TABLE ai_conversations (
    id                      VARCHAR(32) PRIMARY KEY,
    user_id                 VARCHAR(32) NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- 会话信息
    title                   VARCHAR(200),                -- 会话标题
    category                VARCHAR(30) DEFAULT 'general', -- 会话类别：general/health/intimacy/companionship

    -- AI配置
    ai_personality          VARCHAR(30) DEFAULT 'gentle', -- AI人格：gentle/professional/playful
    temperature            DECIMAL(3,2) DEFAULT 0.7,     -- 温度参数
    max_tokens              INTEGER DEFAULT 1000,        -- 最大token数

    -- 统计
    message_count           INTEGER DEFAULT 0,           -- 消息数量
    last_message_at         TIMESTAMP,                   -- 最后消息时间

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_ai_conversations_user_id ON ai_conversations(user_id);
CREATE INDEX idx_ai_conversations_created_at ON ai_conversations(created_at DESC);

-- ========================================
-- AI对话消息表 (ai_messages)
-- ========================================
CREATE TABLE ai_messages (
    id                      VARCHAR(32) PRIMARY KEY,
    conversation_id        VARCHAR(32) NOT NULL REFERENCES ai_conversations(id) ON DELETE CASCADE,

    -- 消息信息
    role                    VARCHAR(20) NOT NULL,         -- 角色：user/assistant/system
    content                 TEXT NOT NULL,                -- 消息内容
    content_type           VARCHAR(20) DEFAULT 'text',    -- 内容类型：text/image/audio

    -- 元数据
    metadata               JSONB DEFAULT '{}'::jsonb,    -- 元数据：{tokens: 100, model: "gpt-4"}

    -- 时间
    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_ai_messages_conversation_id ON ai_messages(conversation_id);
CREATE INDEX idx_ai_messages_created_at ON ai_messages(created_at ASC);
```

##### 3.1.5 IoT设备模块表

```sql
-- ========================================
-- IoT设备表 (iot_devices)
-- ========================================
CREATE TABLE iot_devices (
    id                      VARCHAR(32) PRIMARY KEY,
    user_id                 VARCHAR(32) REFERENCES users(id) ON DELETE SET NULL,

    -- 设备信息
    device_id               VARCHAR(100) UNIQUE NOT NULL, -- 设备唯一标识（蓝牙MAC等）
    device_type             VARCHAR(50) NOT NULL,         -- 设备类型：massager/vibrator/smart_ring等
    device_name             VARCHAR(100),                 -- 设备名称
    brand                   VARCHAR(50),                  -- 品牌
    model                   VARCHAR(50),                  -- 型号

    -- 连接信息
    bluetooth_address      VARCHAR(20),                  -- 蓝牙MAC地址
    last_connected_at       TIMESTAMP,                   -- 最后连接时间
    connection_count        INTEGER DEFAULT 0,           -- 连接次数

    -- 设备状态
    status                  VARCHAR(20) DEFAULT 'offline', -- 设备状态：online/offline/error
    battery_level           INTEGER,                      -- 电量百分比

    -- 固件信息
    firmware_version        VARCHAR(20),                  -- 固件版本
    hardware_version        VARCHAR(20),                  -- 硬件版本

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_iot_devices_user_id ON iot_devices(user_id);
CREATE INDEX idx_iot_devices_device_id ON iot_devices(device_id);
CREATE INDEX idx_iot_devices_device_type ON iot_devices(device_type);

-- ========================================
-- IoT设备数据表 (iot_device_data)
-- ========================================
CREATE TABLE iot_device_data (
    id                      VARCHAR(32) PRIMARY KEY,
    device_id               VARCHAR(32) NOT NULL REFERENCES iot_devices(id) ON DELETE CASCADE,

    -- 数据信息
    data_type               VARCHAR(50) NOT NULL,         -- 数据类型：session/settings/health
    data_value              JSONB NOT NULL,              -- 数据值（JSON格式）

    created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_iot_device_data_device_id ON iot_device_data(device_id);
CREATE INDEX idx_iot_device_data_created_at ON iot_device_data(created_at DESC);
```

#### 3.2 MongoDB文档数据库集合结构

```javascript
// ========================================
// 用户会话集合 (user_sessions)
// ========================================
db.createCollection("user_sessions", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["_id", "userId", "token"],
      properties: {
        _id: { bsonType: "string" },
        userId: { bsonType: "string" },
        token: { bsonType: "string" },
        refreshToken: { bsonType: "string" },
        deviceInfo: {
          bsonType: "object",
          properties: {
            type: { enum: ["ios", "android", "web", "miniprogram"] },
            id: { bsonType: "string" },
            name: { bsonType: "string" }
          }
        },
        ipAddress: { bsonType: "string" },
        expiresAt: { bsonType: "date" },
        createdAt: { bsonType: "date" },
        lastAccessAt: { bsonType: "date" }
      }
    }
  }
});

db.user_sessions.createIndex({ userId: 1 });
db.user_sessions.createIndex({ token: 1 }, { unique: true });
db.user_sessions.createIndex({ expiresAt: 1 }, { expireAfterSeconds: 0 });

// ========================================
-- 用户行为日志集合 (user_behavior_logs)
// ========================================
db.createCollection("user_behavior_logs", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["_id", "userId", "action"],
      properties: {
        _id: { bsonType: "string" },
        userId: { bsonType: "string" },
        sessionId: { bsonType: "string" },
        action: {
          enum: ["page_view", "click", "search", "add_to_cart", "purchase", "favorite"]
        },
        pagePath: { bsonType: "string" },
        metadata: { bsonType: "object" },
        createdAt: { bsonType: "date" }
      }
    }
  }
});

db.user_behavior_logs.createIndex({ userId: 1, createdAt: -1 });
db.user_behavior_logs.createIndex({ action: 1, createdAt: -1 });

// ========================================
-- 商品浏览历史集合 (product_view_history)
// ========================================
db.createCollection("product_view_history", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["_id", "userId", "productId"],
      properties: {
        _id: { bsonType: "string" },
        userId: { bsonType: "string" },
        productId: { bsonType: "string" },
        productName: { bsonType: "string" },
        productImage: { bsonType: "string" },
        categoryId: { bsonType: "string" },
        viewCount: { bsonType: "int", minimum: 1 },
        firstViewAt: { bsonType: "date" },
        lastViewAt: { bsonType: "date" }
      }
    }
  }
});

db.product_view_history.createIndex({ userId: 1, productId: 1 }, { unique: true });
db.product_view_history.createIndex({ userId: 1, lastViewAt: -1 });

// ========================================
-- 系统通知集合 (system_notifications)
// ========================================
db.createCollection("system_notifications", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["_id", "userId", "type", "title"],
      properties: {
        _id: { bsonType: "string" },
        userId: { bsonType: "string" },
        type: {
          enum: ["system", "order", "shipping", "promotion", "social"]
        },
        title: { bsonType: "string" },
        content: { bsonType: "string" },
        data: { bsonType: "object" },
        actionUrl: { bsonType: "string" },
        actionText: { bsonType: "string" },
        isRead: { bsonType: "bool" },
        readAt: { bsonType: "date" },
        createdAt: { bsonType: "date" }
      }
    }
  }
});

db.system_notifications.createIndex({ userId: 1, isRead: 1, createdAt: -1 });
db.system_notifications.createIndex({ userId: 1, isRead: 1 });
```

#### 3.3 Redis缓存键定义

```typescript
/**
 * Redis缓存键前缀规范
 */
export const RedisKeys = {
  // ========== 用户相关 ==========
  /** 用户信息缓存：user:info:{userId} */
  USER_INFO: (userId: string) => `user:info:${userId}`,

  /** 用户会话缓存：user:session:{token} */
  USER_SESSION: (token: string) => `user:session:${token}`,

  /** 用户权限缓存：user:permissions:{userId} */
  USER_PERMISSIONS: (userId: string) => `user:permissions:${userId}`,

  /** 用户购物车：cart:{userId} */
  USER_CART: (userId: string) => `cart:${userId}`,

  // ========== 商品相关 ==========
  /** 商品详情缓存：product:detail:{productId} */
  PRODUCT_DETAIL: (productId: string) => `product:detail:${productId}`,

  /** 商品库存缓存：product:stock:{skuId} */
  PRODUCT_STOCK: (skuId: string) => `product:stock:${skuId}`,

  /** 商品列表缓存：product:list:{category}:{page} */
  PRODUCT_LIST: (category: string, page: number) => `product:list:${category}:${page}`,

  /** 热门商品缓存：product:hot */
  PRODUCT_HOT: 'product:hot',

  // ========== 订单相关 ==========
  /** 订单详情缓存：order:detail:{orderId} */
  ORDER_DETAIL: (orderId: string) => `order:detail:${orderId}`,

  /** 订单状态缓存：order:status:{orderNo} */
  ORDER_STATUS: (orderNo: string) => `order:status:${orderNo}`,

  // ========== 通知相关 ==========
  /** 未读消息数：notification:unread:{userId} */
  NOTIFICATION_UNREAD: (userId: string) => `notification:unread:${userId}`,

  // ========== 限流相关 ==========
  /** 接口限流：rate:limit:{userId}:{api} */
  RATE_LIMIT: (userId: string, api: string) => `rate:limit:${userId}:${api}`,

  /** 验证码：captcha:{type}:{account} */
  CAPTCHA: (type: string, account: string) => `captcha:${type}:${account}`,

  // ========== 分布式锁 ==========
  /** 分布式锁：lock:{resource}:{token} */
  LOCK: (resource: string, token: string) => `lock:${resource}:${token}`,

  // ========== 统计相关 ==========
  /** 页面访问量：stats:pv:{page}:{date} */
  STATS_PV: (page: string, date: string) => `stats:pv:${page}:${date}`,

  /** 商品浏览量：stats:product:view:{productId} */
  STATS_PRODUCT_VIEW: (productId: string) => `stats:product:view:${productId}`,

  // ========== IoT相关 ==========
  /** 设备在线状态：iot:device:online:{deviceId} */
  IOT_DEVICE_ONLINE: (deviceId: string) => `iot:device:online:${deviceId}`,

  /** 设备连接状态：iot:device:connected:{userId}:{deviceId} */
  IOT_DEVICE_CONNECTED: (userId: string, deviceId: string) => `iot:device:connected:${userId}:${deviceId}`
};
```

### 4. 字段类型规范

#### 4.1 PostgreSQL字段类型映射

| 业务场景 | PostgreSQL类型 | 说明 |
|----------|----------------|------|
| 主键ID | VARCHAR(32) | UUID或自定义格式 |
| 用户邮箱 | VARCHAR(100) | RFC标准邮箱长度 |
| 手机号 | VARCHAR(20) | 包含国际区号 |
| 密码哈希 | VARCHAR(255) | bcrypt哈希结果 |
| 金额 | DECIMAL(10,2) | 精确到分 |
| 百分比 | DECIMAL(5,2) | 0.00-100.00 |
| IP地址 | INET | PostgreSQL原生IP类型 |
| JSON数据 | JSONB | 二进制JSON，带索引 |
| 时间戳 | TIMESTAMP | 带时区时间戳 |
| 布尔值 | BOOLEAN | true/false |
| 枚举值 | VARCHAR(20) | 字符串枚举 |

#### 4.2 MongoDB文档类型映射

| 业务场景 | BSON类型 | 说明 |
|----------|----------|------|
| 主键ID | String | ObjectId或自定义 |
| 时间 | Date | ISO 8601格式 |
| 嵌套文档 | Object | JSON对象 |
| 数组 | Array | JSON数组 |
| 二进制 | BinData | 文件、图片 |
| 布尔值 | Boolean | true/false |
| 数值 | Number/Decimal | Int32/Int64/Decimal128 |

#### 4.3 Redis键值类型映射

| 业务场景 | 数据类型 | TTL建议 |
|----------|----------|---------|
| 用户信息 | Hash | 1小时 |
| 会话Token | String | 7天 |
| 验证码 | String | 5分钟 |
| 商品详情 | Hash | 30分钟 |
| 购物车 | Hash | 7天 |
| 限流计数 | String | 按需 |
| 分布式锁 | String | 30秒 |
| 统计计数 | String | 永久 |

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
