# 海蓝 (HaiLan) Pro - 自动化测试框架

> **统一工具配置与最佳实践规范**

---

## 1. 框架栈选型

| 测试类型 | 框架/工具 | 选型理由 | 配置文件路径 |
|---------|----------|---------|------------|
| **单元测试** | **Vitest** | 与 Vite 生态深度集成，极速启动，支持 Snapshot。 | `/vitest.config.ts` |
| **组件测试** | **Vitest + React Testing Lib** | 与单元测试工具链统一，轻量级。 | `/vitest.config.ts` |
| **E2E测试** | **Cypress** | 真实浏览器，支持自动重试，网络拦截，Debug友好。 | `/cypress.config.ts` |
| **性能测试** | **k6** | Go 语言高性能，Cloud Native，易于编写复杂场景。 | `/scripts/performance/loadTest.k6.js` |
| **API测试** | **Supertest** | 专为 Node.js 设计，模拟 HTTP Server，无网络开销。 | - (集成在 Vitest 中) |
| **代码质量** | **SonarQube** | 持续集成，代码异味、重复度检测。 | - |

---

## 2. 配置规范

### 2.1 Vitest (Unit & Component)

**核心配置要点**：

- **环境**: `jsdom` (模拟浏览器环境)。
- **覆盖率**: `v8` (V8 原生提供，速度快)。
- **并行**: 开启多线程 (`maxThreads: 4`)。
- **断言**: 默认包含，支持 Expect API。

**最佳实践**：

1. **文件命名**: 测试文件必须命名为 `*.test.ts` 或 `*.spec.ts`。
2. **目录结构**: 放置在 `__tests__` 目录下，与源码同级。
3. **Mock**: 使用 `vi.mock` 模拟外部依赖，避免网络请求。

```typescript
// 示例：Mock API 请求
import { describe, it, expect, vi } from 'vitest';
import { fetchProducts } from '@/services/productService';
vi.mock('@/services/api', () => ({
  request: vi.fn().mockResolvedValue({ data: [] })
}));
```

### 2.2 Cypress (E2E)

**核心配置要点**：

- **Base URL**: 指向 `staging` 环境或 `localhost`。
- **视口**: 默认 `1280x720`，覆盖桌面主流分辨率。
- **重试**: `runMode: 3` (CI环境)，`openMode: 0` (本地开发)。
- **视频录制**: 开启，便于排查失败原因。

**最佳实践**：

1. **Page Object Model (POM)**: 封装页面元素选择器，提高可维护性。

    ```typescript
    // cypress/support/e2e.ts
    export const LoginPage = {
      usernameInput: () => cy.get('[data-testid="username"]'),
      loginBtn: () => cy.get('[data-testid="login-btn"]'),
      // ...
    };
    ```

2. **Data Test ID**: 在 React 组件中使用 `data-testid` 属性选择器，避免依赖 CSS 类名。
3. **等待策略**: 使用 Cypress 内置的自动重试机制，避免硬编码 `cy.wait(5000)`。
4. **独立测试**: 每个 `it` 块必须独立执行，不依赖前置 `it`。

### 2.3 k6 (Performance)

**核心配置要点**：

- **阶段 (Stages)**: 使用 `stages` 数组模拟真实流量波动。
- **阈值 (Thresholds)**: 定义 `p(95)`, `p(99)` 响应时间上限，失败则终止测试。
- **检查 (Check)**: 使用 `check` 函数验证响应状态码和内容。

**最佳实践**：

1. **参数化**: 使用环境变量 (`__ENV.VAR`) 配置不同的测试环境。
2. **模拟真实用户**: 包含 `think_time` (思考时间)，不要无脑刷接口。
3. **数据隔离**: 测试数据（如商品ID）应随机化，避免热点效应。

---

## 3. 用例编写规范

### 3.1 单元测试

```typescript
describe('ProductService', () => {
  beforeEach(() => {
    // 每个测试前的重置逻辑
  });

  it('should fetch products successfully', async () => {
    const products = await fetchProducts();
    expect(products).toBeDefined();
    expect(products).toBeInstanceOf(Array);
  });

  it('should throw error when network fails', async () => {
    // 验证异常处理
    await expect(fetchProducts()).rejects.toThrow('Network Error');
  });
});
```

### 3.2 E2E 测试

```typescript
describe('Checkout Flow', () => {
  beforeEach(() => {
    cy.visit('/products/101'); // 访问商品详情
  });

  it('allows user to add item to cart and checkout', () => {
    // 1. 加购
    cy.contains('加入购物车').click();
    cy.get('[data-testid="cart-count"]').should('contain', '1');

    // 2. 结算
    cy.visit('/cart');
    cy.contains('去结算').click();
    
    // 3. 断言
    cy.url().should('include', '/checkout');
  });
});
```

### 3.3 性能测试

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6/http';

export default function () {
  const res = http.get('https://api.hailan.com/products');
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
  sleep(1); // 休眠1秒
}
```

---

## 4. 报告与集成

### 4.1 本地报告

- **Vitest**: `npm run test -- --reporter=html` (生成 `coverage/index.html`)。
- **Cypress**: `cypress run` (生成 HTML 报告)。
- **k6**: `k6 run --out json=report.json` (生成 JSON 报告)。

### 4.2 CI/CD 集成 (GitHub Actions)

详见 [`03-持续集成与测试.md`](./03-持续集成与测试.md)。

- 测试失败时，CI 任务必须失败（`failFast`）。
- 报告产物 (Artifacts) 必须上传（`actions/upload-artifact`）。
- **覆盖率封印**: 若覆盖率 < 85%，禁止合并 Pull Request。

---

## 5. 调试技巧

### 5.1 Vitest

- `npm run test -- --ui`: 启动可视化 UI 调试界面。
- `--run`: 避免监听模式，仅运行一次。
- `t.only`: 仅运行某个测试 (调试时使用，上线前记得删除)。

### 5.2 Cypress

- `cypress open`: 启动 Test Runner (GUI)。
- `cy.pause()`: 在代码中插入断点。
- `cy.debug()`: 打印当前元素状态。
- `cy.log()`: 输出调试信息到 Command Log。

### 5.3 k6

- `k6 run --out influxdb=http://...`: 集成 Grafana 实时监控。
- `--http-debug`: 打印完整的 HTTP 请求/响应。
