---
file: 022-数据架构设计文档.md
description: HaiLan Pro 项目全数据流转、存储、处理的架构设计，明确数据链路与数据规范
author: YanYuCloudCube Team
version: v1.0.0
created: 2026-01-26
updated: 2026-02-03
status: published
tags:
  - 架构设计,[数据架构],[数据流转]
---

> ***YanYuCloudCube***
> 言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> 万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 022 数据架构设计文档

## 概述

本文档详细描述HaiLan Pro项目的数据架构设计，阐述数据的产生、流转、存储、处理全链路，明确数据模型、数据规范以及数据安全策略，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景

HaiLan Pro 作为医疗级私密健康管理系统，处理的数据具有高度敏感性和隐私性。数据架构设计必须在保证数据安全的前提下，实现高效的流转与存储。

#### 1.2 数据架构目标

- **数据安全**：敏感数据加密存储，零知识证明验证
- **数据隔离**：用户数据完全隔离，防止泄露
- **数据一致性**：多端数据同步，状态一致
- **数据可追溯**：完整的数据流转记录
- **数据合规**：符合 GDPR 等隐私法规要求

### 2. 数据分类体系

#### 2.1 按敏感度分类

| 分类 | 说明 | 存储方案 | 访问控制 |
|------|------|----------|----------|
| 公开数据 | 商品信息、静态资源 | PostgreSQL + CDN | 无限制 |
| 用户数据 | 用户基础信息、偏好设置 | PostgreSQL | 用户本人 |
| 敏感数据 | 订单信息、健康数据 | PostgreSQL (加密字段) | 用户本人 + ZK验证 |
| 绝密数据 | 医疗记录、隐私文档 | IPFS (加密) + DID引用 | 用户本人 + 多重验证 |

#### 2.2 按业务领域分类

```
数据域
├── 用户域 (User Domain)
│   ├── 用户基础信息
│   ├── 用户偏好设置
│   └── 用户行为数据
├── 商品域 (Product Domain)
│   ├── 商品目录
│   ├── 商品分类
│   └── 商品评价
├── 订单域 (Order Domain)
│   ├── 购物车
│   ├── 订单主表
│   ├── 订单详情
│   └── 支付记录
├── 隐私域 (Privacy Domain)
│   ├── 隐私设置
│   ├── 加密密钥
│   └── DID 身份
├── AI 域 (AI Domain)
│   ├── 对话历史
│   ├── 推荐记录
│   └── 问答日志
└── IoT 域 (IoT Domain)
    ├── 设备信息
    ├── 设备数据
    └── 健康指标
```

### 3. 数据存储架构

#### 3.1 存储分层设计

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层                              │
│  (React Context API - 前端状态管理)                         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      本地存储层                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  IndexedDB  │  │ localStorage│  │  Cache API  │         │
│  │ (离线数据)  │  │ (配置缓存)  │  │ (资源缓存)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      分布式存储层                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    IPFS 网络                        │    │
│  │  (加密后的敏感数据、隐私文档、健康记录)              │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      关系型存储层                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Supabase / PostgreSQL                  │    │
│  │  (用户信息、商品数据、订单记录、权限配置)            │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                       缓存加速层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Redis     │  │    CDN      │  │  PWA Cache  │         │
│  │ (会话缓存)  │  │ (静态资源)  │  │ (离线资源)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2 核心数据表设计

##### 3.2.1 用户相关表

**users 表 (用户基础信息)**
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  did VARCHAR(255) UNIQUE NOT NULL,           -- 去中心化身份标识
  email VARCHAR(255) UNIQUE,                  -- 加密存储
  phone VARCHAR(50) UNIQUE,                   -- 加密存储
  privacy_level VARCHAR(20) DEFAULT 'STANDARD', -- STANDARD/STEALTH/DISGUISE
  preferences JSONB,                          -- 用户偏好设置
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  last_active TIMESTAMP
);
```

**user_profiles 表 (用户扩展信息)**
```sql
CREATE TABLE user_profiles (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  display_name VARCHAR(100),                  -- 显示名称
  avatar_url VARCHAR(500),                    -- 头像 URL
  bio TEXT,                                   -- 个人简介
  interests TEXT[],                           -- 兴趣标签
  health_goals JSONB,                         -- 健康目标
  ipfs_data_cid VARCHAR(255),                 -- 敏感数据 IPFS CID
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**privacy_settings 表 (隐私设置)**
```sql
CREATE TABLE privacy_settings (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  stealth_mode_enabled BOOLEAN DEFAULT false,
  camouflage_enabled BOOLEAN DEFAULT false,
  biometric_auth BOOLEAN DEFAULT true,
  data_retention_days INT DEFAULT 90,
  encryption_version VARCHAR(10) DEFAULT 'v1.0',
  mask_level INT DEFAULT 1,                   -- 0-5 遮罩等级
  auto_logout_minutes INT DEFAULT 30,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

##### 3.2.2 商品相关表

**categories 表 (商品分类)**
```sql
CREATE TABLE categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  code VARCHAR(50) UNIQUE NOT NULL,           -- CARE/PLAY/INTIMACY/LINGERIE/SMART
  name VARCHAR(100) NOT NULL,
  name_en VARCHAR(100),
  description TEXT,
  icon_url VARCHAR(500),
  display_order INT DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**products 表 (商品主表)**
```sql
CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  category_id UUID REFERENCES categories(id),
  sku VARCHAR(100) UNIQUE NOT NULL,
  name VARCHAR(200) NOT NULL,
  description TEXT,
  price DECIMAL(10,2) NOT NULL,
  compare_at_price DECIMAL(10,2),             -- 划线价
  cost_price DECIMAL(10,2),                   -- 成本价
  images JSONB,                               -- 图片数组
  videos JSONB,                               -- 视频数组
  attributes JSONB,                           -- 商品属性
  variants JSONB,                             -- 变体信息
  inventory INT DEFAULT 0,
  sales_count INT DEFAULT 0,
  rating_average DECIMAL(3,2) DEFAULT 0,
  review_count INT DEFAULT 0,
  is_featured BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

##### 3.2.3 订单相关表

**orders 表 (订单主表)**
```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  order_number VARCHAR(50) UNIQUE NOT NULL,
  status VARCHAR(20) DEFAULT 'PENDING',        -- PENDING/PAID/SHIPPED/COMPLETED/CANCELLED
  privacy_mode VARCHAR(20) DEFAULT 'NORMAL',  -- NORMAL/ENCRYPTED_ADDR/ANONYMOUS
  items JSONB NOT NULL,                       -- 订单商品列表
  subtotal DECIMAL(10,2) NOT NULL,
  shipping_fee DECIMAL(10,2) DEFAULT 0,
  discount DECIMAL(10,2) DEFAULT 0,
  total DECIMAL(10,2) NOT NULL,
  shipping_address JSONB,                     -- 加密存储
  billing_address JSONB,                      -- 加密存储
  payment_method VARCHAR(50),
  payment_id VARCHAR(255),
  tracking_number VARCHAR(255),
  notes TEXT,
  ipfs_receipt_cid VARCHAR(255),              -- 订单收据 IPFS CID
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

##### 3.2.4 AI 相关表

**ai_conversations 表 (AI 对话记录)**
```sql
CREATE TABLE ai_conversations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  session_id UUID NOT NULL,
  role VARCHAR(20) NOT NULL,                  -- user/assistant/system
  content TEXT NOT NULL,                      -- 加密存储
  context JSONB,                              -- 对话上下文
  tokens_used INT,
  model_version VARCHAR(50),
  ipfs_content_cid VARCHAR(255),              -- 内容 IPFS CID
  created_at TIMESTAMP DEFAULT NOW()
);
```

**ai_recommendations 表 (AI 推荐记录)**
```sql
CREATE TABLE ai_recommendations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  scenario VARCHAR(100),                      -- 推荐场景
  product_ids UUID[],                         -- 推荐商品
  algorithm VARCHAR(50),
  confidence DECIMAL(5,4),
  feedback BOOLEAN,                           -- 用户反馈
  created_at TIMESTAMP DEFAULT NOW()
);
```

##### 3.2.5 IoT 相关表

**iot_devices 表 (IoT 设备)**
```sql
CREATE TABLE iot_devices (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  device_id VARCHAR(255) UNIQUE NOT NULL,     -- 设备唯一标识
  device_name VARCHAR(100),
  device_type VARCHAR(50),                    -- 设备类型
  bluetooth_address VARCHAR(50),
  firmware_version VARCHAR(50),
  last_sync TIMESTAMP,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**health_data 表 (健康数据)**
```sql
CREATE TABLE health_data (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  device_id UUID REFERENCES iot_devices(id),
  data_type VARCHAR(50) NOT NULL,             -- 数据类型
  value JSONB NOT NULL,                       -- 数据值（加密）
  unit VARCHAR(50),
  recorded_at TIMESTAMP NOT NULL,
  ipfs_data_cid VARCHAR(255),                 -- 原始数据 IPFS CID
  zk_proof_hash VARCHAR(255),                 -- 零知识证明哈希
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 4. 数据流转设计

#### 4.1 用户注册数据流

```
[用户输入]
    ↓
[前端加密] - Email/Phone 加密
    ↓
[Supabase Auth] - 用户认证
    ↓
[DID 生成] - 匿名身份标识
    ↓
[PostgreSQL] - 用户基础信息
    ↓
[IPFS] - 敏感配置（加密）
```

#### 4.2 订单创建数据流

```
[购物车操作]
    ↓
[CartContext] - 前端状态
    ↓
[IndexedDB] - 离线缓存
    ↓
[结账提交]
    ↓
[地址加密] - 隐私保护
    ↓
[PostgreSQL] - 订单记录
    ↓
[IPFS] - 订单详情（加密）
    ↓
[DID 引用] - 数据关联
```

#### 4.3 IoT 数据同步流

```
[Web Bluetooth 连接]
    ↓
[设备数据采集]
    ↓
[前端加密]
    ↓
[IPFS 存储] - 加密数据
    ↓
[ZK-Proof 生成] - 验证凭证
    ↓
[PostgreSQL] - 数据索引 + CID
    ↓
[用户查看] - ZK 验证后解密
```

### 5. 数据安全策略

#### 5.1 加密策略

| 数据类型 | 加密方式 | 密钥管理 | 存储位置 |
|----------|----------|----------|----------|
| 用户身份信息 | AES-256-GCM | 用户密钥 | PostgreSQL |
| 地址信息 | AES-256-GCM | 用户密钥 | PostgreSQL |
| 健康数据 | AES-256-GCM + DID | 用户密钥 | IPFS |
| 对话内容 | AES-256-GCM | 会话密钥 | IPFS |
| IoT 数据 | AES-256-GCM + ZK | 设备密钥 | IPFS |

#### 5.2 零知识证明架构

```
[敏感数据]
    ↓
[Commitment] - 承诺方案
    ↓
[Prover] - 证明生成
    ↓
[ZK-Proof] - 零知识证明
    ↓
[Verifier] - 验证合约
    ↓
[Access Granted] - 访问授权
```

#### 5.3 数据脱敏规则

```typescript
// 数据脱敏配置
const MASKING_RULES = {
  email: (value: string) => {
    const [local, domain] = value.split('@');
    return `${local[0]}***@${domain}`;
  },
  phone: (value: string) => {
    return value.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
  },
  address: (value: string) => {
    return value.substring(0, 6) + '***';
  },
  card: (value: string) => {
    return value.replace(/\d(?=\d{4})/g, '*');
  }
};
```

### 6. 数据一致性保障

#### 6.1 多端同步策略

```typescript
// 数据同步策略
interface SyncStrategy {
  // 实时同步
  realtime: {
    websocket: boolean;
    conflict: 'last-write-wins' | 'server-wins' | 'manual';
  };
  // 延迟同步
  deferred: {
    queue: 'indexeddb' | 'localstorage';
    retry: {
      maxAttempts: number;
      backoff: number;
    };
  };
  // 离线处理
  offline: {
    cache: 'serviceworker' | 'indexeddb';
    merge: 'auto' | 'manual';
  };
}
```

#### 6.2 数据版本控制

```sql
-- 数据版本表
CREATE TABLE data_versions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  table_name VARCHAR(100) NOT NULL,
  record_id UUID NOT NULL,
  version INT NOT NULL,
  data JSONB NOT NULL,
  ipfs_cid VARCHAR(255),
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 7. 数据生命周期管理

#### 7.1 数据保留策略

| 数据类型 | 保留期限 | 处理方式 |
|----------|----------|----------|
| 用户日志 | 90 天 | 自动删除 |
| 对话历史 | 365 天 | 归档至 IPFS |
| 订单记录 | 永久 | 归档存储 |
| IoT 原始数据 | 30 天 | 聚合后删除 |
| 临时文件 | 7 天 | 自动清理 |

#### 7.2 数据清理流程

```
[到期数据检测]
    ↓
[用户通知] - 提前7天
    ↓
[数据归档] - 重要数据
    ↓
[IPFS 迁移] - 长期存储
    ↓
[本地删除] - 清理完成
```

### 8. 数据备份与恢复

#### 8.1 备份策略

```yaml
backup_schedule:
  # 增量备份
  incremental:
    frequency: "hourly"
    retention: 24
  # 全量备份
  full:
    frequency: "daily"
    retention: 30
  # 归档备份
  archive:
    frequency: "monthly"
    retention: 12
```

#### 8.2 恢复流程

```
[故障检测]
    ↓
[备份定位]
    ↓
[数据恢复]
    ↓
[一致性校验]
    ↓
[服务恢复]
```

### 9. 数据质量保障

#### 9.1 数据校验规则

```typescript
// 数据校验 schema
const VALIDATION_SCHEMAS = {
  user: {
    email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
    phone: /^1[3-9]\d{9}$/,
    did: /^did:hailan:[a-f0-9]{32}$/
  },
  product: {
    sku: /^[A-Z0-9-]{8,20}$/,
    price: (val: number) => val > 0 && val < 100000
  },
  order: {
    orderNumber: /^[A-Z0-9]{12,20}$/
  }
};
```

#### 9.2 数据监控指标

- 数据完整性：主键、外键约束检查
- 数据准确性：格式校验、范围校验
- 数据时效性：时间戳监控
- 数据一致性：跨表关联检查

### 10. 附录

#### 10.1 数据字典

详见：[086-数据库-全库表字段字典.md](../HaiLan-Pro-类型定义/086-数据库-全库表字段字典.md)

#### 10.2 枚举值定义

详见：[087-数据库-枚举值字典文档.md](../HaiLan-Pro-类型定义/087-数据库-枚举值字典文档.md)

#### 10.3 参考文档

- [021-系统架构设计文档.md](./021-系统架构设计文档.md) - 系统整体架构
- [024-数据库设计文档.md](./024-数据库设计文档.md) - 数据库详细设计
- [026-隐私保护架构设计.md](./026-隐私保护架构设计.md) - 隐私保护方案

---

<div align="center">

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」

</div>
