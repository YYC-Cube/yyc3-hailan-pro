---
@file: 025-安全架构设计文档.md
@description: HaiLan Pro 系统全维度安全防护设计，包含数据安全、接口安全、权限安全等
@author: YanYuCloudCube Team
@version: v1.0.0
@created: 2026-01-26
@updated: 2026-02-03
@status: published
@tags: [架构设计],[安全架构],[风险防护]
---

> ***YanYuCloudCube***
> 言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> 万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 025 安全架构设计文档

## 概述

本文档详细描述HaiLan Pro项目的安全架构设计，阐述系统全维度安全防护体系，包括数据安全、接口安全、权限安全、传输安全等核心安全机制，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景

HaiLan Pro 作为医疗级私密健康管理系统，处理的数据具有高度敏感性。安全架构设计必须满足 GDPR、PIPL 等隐私法规要求，同时提供极致的用户隐私保护体验。

#### 1.2 安全架构目标

- **数据安全**：敏感数据加密存储，零知识证明验证
- **传输安全**：全链路加密传输，防止中间人攻击
- **接口安全**：严格的鉴权授权机制，防止越权访问
- **隐私保护**：多级隐私模式，用户完全掌控数据
- **合规审计**：完整的安全审计日志，满足合规要求

### 2. 安全架构分层

#### 2.1 安全分层模型

```
┌─────────────────────────────────────────────────────────────┐
│                    应用安全层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  身份认证    │  │  会话管理    │  │  权限控制    │          │
│  │  Supabase   │  │  JWT Token  │  │  RLS Policy  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据安全层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  数据加密    │  │  隐私脱敏    │  │  ZK-Proof   │          │
│  │  AES-256    │  │  Data Mask  │  │  验证机制    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    网络安全层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  TLS 1.3    │  │  CORS 控制  │  │  限流熔断    │          │
│  │  HTTPS      │  │  CSP Header │  │  DDoS 防护  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    基础设施层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  容器安全    │  │  密钥管理    │  │  安全审计    │          │
│  │  Docker     │  │  HSM/KMS    │  │  日志监控    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### 3. 身份认证安全

#### 3.1 认证架构

**认证方式：**

```typescript
// 认证方式配置
interface AuthConfig {
  // 主认证方式
  primary: {
    method: 'email' | 'phone' | 'oauth';
    mfa: boolean;              // 多因素认证
    biometric: boolean;        // 生物识别
  };
  // OAuth 提供商
  oauth: {
    providers: ('google' | 'apple' | 'wechat')[];
    scope: string[];
  };
  // 会话管理
  session: {
    duration: number;          // 会话时长（秒）
    refresh: boolean;          // 自动刷新
    storage: 'localStorage' | 'sessionStorage' | 'secureCookie';
  };
}
```

**认证流程：**

```
[用户输入凭证]
        ↓
[前端加密] - Supabase Auth
        ↓
[后端验证] - Supabase Auth Service
        ↓
[生成 JWT] - Access Token + Refresh Token
        ↓
[前端存储] - Secure Storage
        ↓
[后续请求] - Bearer Token Authorization
        ↓
[令牌验证] - RLS Policy Check
        ↓
[授权通过/拒绝]
```

#### 3.2 多因素认证 (MFA)

```typescript
// MFA 配置
interface MFAConfig {
  enabled: boolean;
  methods: {
    totp: boolean;              // TOTP (Time-based OTP)
    sms: boolean;               // 短信验证码
    email: boolean;             // 邮箱验证码
    biometric: boolean;         // 生物识别
    hardwareKey: boolean;       // 硬件密钥
  };
  recovery: {
    codes: string[];            // 恢复码
    backupMethod: string;       // 备用方法
  };
}
```

### 4. 数据安全

#### 4.1 加密策略

**数据分类加密：**

| 数据类型 | 存储加密 | 传输加密 | 密钥管理 |
|----------|----------|----------|----------|
| 用户身份信息 | AES-256-GCM | TLS 1.3 | 用户密钥 |
| 健康数据 | AES-256-GCM + ZK | TLS 1.3 | DID 密钥 |
| 对话内容 | AES-256-GCM | TLS 1.3 | 会话密钥 |
| IoT 数据 | AES-256-GCM + ZK | TLS 1.3 | 设备密钥 |
| 支付信息 | AES-256-GCM | TLS 1.3 | 支付密钥 |

**加密实现：**

```typescript
// 加密服务
class EncryptionService {
  // AES-256-GCM 加密
  async encrypt(data: string, key: CryptoKey): Promise<{
    ciphertext: string;
    iv: string;
    tag: string;
  }> {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encrypted = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv },
      key,
      new TextEncoder().encode(data)
    );

    const ciphertext = new Uint8Array(encrypted.slice(0, -16));
    const tag = new Uint8Array(encrypted.slice(-16));

    return {
      ciphertext: btoa(String.fromCharCode(...ciphertext)),
      iv: btoa(String.fromCharCode(...iv)),
      tag: btoa(String.fromCharCode(...tag))
    };
  }

  // AES-256-GCM 解密
  async decrypt(
    ciphertext: string,
    iv: string,
    tag: string,
    key: CryptoKey
  ): Promise<string> {
    const data = concatUint8Array(
      Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0)),
      Uint8Array.from(atob(tag), c => c.charCodeAt(0))
    );

    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: Uint8Array.from(atob(iv), c => c.charCodeAt(0)) },
      key,
      data
    );

    return new TextDecoder().decode(decrypted);
  }
}
```

#### 4.2 密钥管理

**密钥层级：**

```
┌─────────────────────────────────────────────────────────────┐
│                   主密钥 (Master Key)                        │
│              硬件安全模块 (HSM) / KMS                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  数据加密密钥 (DEK)                           │
│              每个用户/会话独立生成                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  内容加密密钥 (CEK)                           │
│              用于具体数据内容的加密                           │
└─────────────────────────────────────────────────────────────┘
```

### 5. 接口安全

#### 5.1 API 安全策略

**请求头验证：**

```typescript
// 安全请求头
interface SecureHeaders {
  // 鉴权
  'Authorization': string;        // Bearer Token
  'X-Request-ID': string;         // 请求追踪ID
  'X-Device-ID': string;          // 设备指纹
  'X-Timestamp': string;          // 请求时间戳
  'X-Signature': string;          // 请求签名

  // 防重放
  'X-Nonce': string;              // 随机数
}
```

**接口签名：**

```typescript
// 签名生成
async function generateSignature(
  method: string,
  path: string,
  body: any,
  secretKey: string
): Promise<string> {
  const timestamp = Date.now().toString();
  const nonce = crypto.getRandomValues(new Uint8Array(16)).toString();

  const payload = {
    method,
    path,
    body: JSON.stringify(body),
    timestamp,
    nonce
  };

  const message = JSON.stringify(payload);
  const signature = await crypto.subtle.sign(
    'HMAC',
    await importKey(secretKey),
    new TextEncoder().encode(message)
  );

  return btoa(String.fromCharCode(...new Uint8Array(signature)));
}
```

#### 5.2 CORS 策略

```typescript
// CORS 配置
const corsConfig = {
  origin: (origin: string) => {
    const allowed = [
      'https://hailan.pro',
      'https://app.hailan.pro',
      'https://preview.figma.com'
    ];
    return allowed.includes(origin);
  },
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: [
    'Content-Type',
    'Authorization',
    'X-Request-ID',
    'X-Device-ID'
  ],
  credentials: true,
  maxAge: 86400 // 24小时
};
```

#### 5.3 限流策略

```typescript
// 限流配置
interface RateLimitConfig {
  // 用户级限流
  user: {
    requests: number;            // 请求数量
    window: number;              // 时间窗口（秒）
    burst: number;               // 突发容量
  };
  // IP 级限流
  ip: {
    requests: number;
    window: number;
  };
  // 接口级限流
  endpoint: {
    [key: string]: {
      requests: number;
      window: number;
    };
  };
}

// 实际配置
const rateLimitConfig: RateLimitConfig = {
  user: { requests: 100, window: 60, burst: 20 },
  ip: { requests: 200, window: 60 },
  endpoint: {
    '/api/ai/chat': { requests: 30, window: 60 },
    '/api/products': { requests: 200, window: 60 },
    '/api/orders': { requests: 20, window: 60 }
  }
};
```

### 6. 权限控制

#### 6.1 RBAC 模型

```typescript
// 角色定义
enum Role {
  ADMIN = 'ADMIN',                   // 管理员
  USER = 'USER',                     // 普通用户
  VIP = 'VIP',                       // VIP 用户
  MODERATOR = 'MODERATOR',           // 版主
  SUPPORT = 'SUPPORT'                // 客服
}

// 权限定义
enum Permission {
  // 用户权限
  USER_READ = 'user:read',
  USER_WRITE = 'user:write',
  USER_DELETE = 'user:delete',

  // 商品权限
  PRODUCT_READ = 'product:read',
  PRODUCT_WRITE = 'product:write',
  PRODUCT_DELETE = 'product:delete',

  // 订单权限
  ORDER_READ = 'order:read',
  ORDER_WRITE = 'order:write',
  ORDER_DELETE = 'order:delete',

  // 内容权限
  CONTENT_READ = 'content:read',
  CONTENT_WRITE = 'content:write',
  CONTENT_MODERATE = 'content:moderate',

  // 系统权限
  SYSTEM_ADMIN = 'system:admin',
  SYSTEM_MONITOR = 'system:monitor'
}

// 角色权限映射
const rolePermissions: Record<Role, Permission[]> = {
  [Role.ADMIN]: Object.values(Permission),
  [Role.USER]: [
    Permission.USER_READ,
    Permission.USER_WRITE,
    Permission.PRODUCT_READ,
    Permission.ORDER_READ,
    Permission.ORDER_WRITE,
    Permission.CONTENT_READ,
    Permission.CONTENT_WRITE
  ],
  [Role.VIP]: [
    Permission.USER_READ,
    Permission.USER_WRITE,
    Permission.PRODUCT_READ,
    Permission.ORDER_READ,
    Permission.ORDER_WRITE,
    Permission.CONTENT_READ,
    Permission.CONTENT_WRITE
  ],
  [Role.MODERATOR]: [
    Permission.USER_READ,
    Permission.PRODUCT_READ,
    Permission.CONTENT_READ,
    Permission.CONTENT_MODERATE
  ],
  [Role.SUPPORT]: [
    Permission.USER_READ,
    Permission.ORDER_READ,
    Permission.CONTENT_READ
  ]
};
```

#### 6.2 Row Level Security (RLS)

```sql
-- 启用 RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE health_data ENABLE ROW LEVEL SECURITY;

-- 用户只能访问自己的数据
CREATE POLICY user_self_access ON users
  FOR ALL
  USING (auth.uid() = id);

-- 用户只能访问自己的订单
CREATE POLICY order_self_access ON orders
  FOR ALL
  USING (auth.uid() = user_id);

-- 管理员可以访问所有数据
CREATE POLICY admin_full_access ON users
  FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid()
      AND role = 'ADMIN'
    )
  );
```

### 7. 传输安全

#### 7.1 TLS 配置

```nginx
# Nginx TLS 配置
server {
    listen 443 ssl http2;
    server_name hailan.pro;

    # TLS 1.3 only
    ssl_protocols TLSv1.3;
    ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256';
    ssl_prefer_server_ciphers off;

    # HSTS
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # 证书
    ssl_certificate /etc/ssl/certs/hailan.pro.crt;
    ssl_certificate_key /etc/ssl/private/hailan.pro.key;

    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/ssl/certs/ca-bundle.crt;
}
```

#### 7.2 内容安全策略 (CSP)

```typescript
// CSP 配置
const cspPolicy = {
  'default-src': ["'none'"],
  'script-src': ["'self'", "'unsafe-inline'", "'unsafe-eval'"],
  'style-src': ["'self'", "'unsafe-inline'"],
  'img-src': ["'self'", 'data:', 'https:'],
  'font-src': ["'self'"],
  'connect-src': ["'self'", 'https://api.hailan.pro', 'wss://api.hailan.pro'],
  'media-src': ["'self'"],
  'object-src': ["'none'"],
  'base-uri': ["'self'"],
  'form-action': ["'self'"],
  'frame-ancestors': ["'none'"],
  'upgrade-insecure-requests': []
};
```

### 8. 安全审计

#### 8.1 审计日志

```sql
-- 审计日志表
CREATE TABLE security_audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- 用户信息
  user_id UUID REFERENCES users(id),
  session_id UUID,

  -- 事件信息
  event_type VARCHAR(100) NOT NULL,
  event_category VARCHAR(50) NOT NULL,
  description TEXT,

  -- 请求信息
  request_id VARCHAR(100) UNIQUE,
  request_method VARCHAR(10),
  request_path VARCHAR(500),
  request_ip VARCHAR(50),
  user_agent TEXT,

  -- 响应信息
  response_status INT,
  response_time INT,

  -- 安全信息
  auth_method VARCHAR(50),
  permission_required VARCHAR(100),
  permission_granted BOOLEAN,
  failure_reason TEXT,

  -- 时间戳
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_security_audit_logs_user_id ON security_audit_logs(user_id);
CREATE INDEX idx_security_audit_logs_event_type ON security_audit_logs(event_type);
CREATE INDEX idx_security_audit_logs_created_at ON security_audit_logs(created_at DESC);
```

#### 8.2 安全事件

```typescript
// 安全事件类型
enum SecurityEventType {
  // 认证事件
  LOGIN_SUCCESS = 'auth.login.success',
  LOGIN_FAILURE = 'auth.login.failure',
  LOGOUT = 'auth.logout',
  MFA_ENABLED = 'auth.mfa.enabled',
  MFA_DISABLED = 'auth.mfa.disabled',

  // 授权事件
  PERMISSION_GRANTED = 'auth.permission.granted',
  PERMISSION_DENIED = 'auth.permission.denied',
  ROLE_ASSIGNED = 'auth.role.assigned',
  ROLE_REVOKED = 'auth.role.revoked',

  // 数据事件
  DATA_ACCESSED = 'data.accessed',
  DATA_MODIFIED = 'data.modified',
  DATA_DELETED = 'data.deleted',
  DATA_EXPORTED = 'data.exported',

  // 隐私事件
  PRIVACY_MODE_CHANGED = 'privacy.mode.changed',
  ENCRYPTION_KEY_ROTATED = 'encryption.key.rotated',
  ZK_PROOF_VERIFIED = 'zkproof.verified',

  // 异常事件
  SUSPICIOUS_ACTIVITY = 'security.suspicious',
  RATE_LIMIT_EXCEEDED = 'security.ratelimit.exceeded',
  INTRUSION_ATTEMPT = 'security.intrusion'
}

// 安全事件记录
class SecurityAuditService {
  async logEvent(event: SecurityEventType, context: {
    userId?: string;
    sessionId?: string;
    requestId?: string;
    metadata?: Record<string, any>;
  }) {
    await supabase.from('security_audit_logs').insert({
      user_id: context.userId,
      session_id: context.sessionId,
      event_type: event,
      event_category: event.split('.')[0],
      request_id: context.requestId,
      metadata: context.metadata
    });
  }
}
```

### 9. 安全监控

#### 9.1 异常检测

```typescript
// 异常检测规则
interface AnomalyDetectionRule {
  // 登录异常
  login: {
    maxFailures: number;          // 最大失败次数
    timeWindow: number;           // 时间窗口（秒）
    lockoutDuration: number;      // 锁定时长（秒）
  };
  // 地理异常
  location: {
    maxDistance: number;          // 最大距离（公里）
    requireVerification: boolean; // 是否需要验证
  };
  // 行为异常
  behavior: {
    unusualPattern: boolean;      // 异常模式检测
    baselineDays: number;         // 基准天数
    threshold: number;            // 阈值（标准差）
  };
}

// 实际配置
const anomalyRules: AnomalyDetectionRule = {
  login: {
    maxFailures: 5,
    timeWindow: 300,
    lockoutDuration: 900
  },
  location: {
    maxDistance: 500,
    requireVerification: true
  },
  behavior: {
    unusualPattern: true,
    baselineDays: 30,
    threshold: 3
  }
};
```

#### 9.2 告警规则

```typescript
// 告警规则
interface AlertRule {
  name: string;
  condition: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  actions: string[];
}

const alertRules: AlertRule[] = [
  {
    name: '多次登录失败',
    condition: 'auth.login.failure > 5 in 5min',
    severity: 'high',
    actions: ['lock_account', 'notify_user', 'notify_admin']
  },
  {
    name: '异常IP访问',
    condition: 'request.ip in blacklist',
    severity: 'critical',
    actions: ['block_request', 'notify_admin']
  },
  {
    name: '敏感数据访问',
    condition: 'data.accessed.sensitive',
    severity: 'medium',
    actions: ['log_access', 'require_mfa']
  },
  {
    name: '限流触发',
    condition: 'ratelimit.exceeded',
    severity: 'medium',
    actions: ['throttle_requests', 'log_event']
  }
];
```

### 10. 安全合规

#### 10.1 GDPR 合规

```typescript
// GDPR 合规措施
interface GDPRCompliance {
  // 数据主体权利
  dataSubjectRights: {
    rightToAccess: boolean;        // 访问权
    rightToRectification: boolean; // 更正权
    rightToErasure: boolean;       // 删除权
    rightToPortability: boolean;   // 可携带权
    rightToObject: boolean;        // 反对权
  };
  // 数据处理
  dataProcessing: {
    consent: boolean;              // 同意机制
    purposeLimitation: boolean;    // 目的限制
    dataMinimization: boolean;     // 数据最小化
    accuracy: boolean;             // 准确性
    storageLimitation: boolean;    // 存储限制
  };
  // 数据保护
  dataProtection: {
    pseudonymization: boolean;     // 假名化
    encryption: boolean;           // 加密
    confidentiality: boolean;       // 机密性
    integrity: boolean;            // 完整性
    availability: boolean;         // 可用性
  };
}
```

#### 10.2 PIPL 合规

```typescript
// PIPL (个人信息保护法) 合规
interface PIPLCompliance {
  // 处理规则
  processingRules: {
    explicitConsent: boolean;      // 明确同意
    purposeSpecification: boolean;  // 目的明确
    necessity: boolean;             // 必要性
    minimization: boolean;          // 最小化
    openness: boolean;             // 公开透明
    accuracy: boolean;              // 准确性
    accountability: boolean;        // 问责制
  };
  // 敏感个人信息
  sensitiveInfo: {
    biometric: boolean;            // 生物识别
    health: boolean;               // 健康信息
    financial: boolean;            // 财务信息
    tracking: boolean;             // 行踪信息
    specialCategory: boolean;      // 特殊类别
  };
  // 境外提供
  crossBorder: {
    assessment: boolean;           // 安全评估
    certification: boolean;         // 认证机制
    standardContract: boolean;     // 标准合同
  };
}
```

### 11. 附录

#### 11.1 安全检查清单

- [ ] 所有 API 端点实现认证和授权
- [ ] 敏感数据加密存储
- [ ] 全站 HTTPS 强制跳转
- [ ] CSP 头正确配置
- [ ] CORS 策略严格限制
- [ ] 实现速率限制和熔断
- [ ] 启用安全日志记录
- [ ] 定期安全审计
- [ ] 隐私政策完整
- [ ] 用户数据导出功能
- [ ] 用户数据删除功能
- [ ] 数据泄露应急预案

#### 11.2 参考文档

- [021-系统架构设计文档.md](./021-系统架构设计文档.md) - 系统架构
- [026-隐私保护架构设计.md](./026-隐私保护架构设计.md) - 隐私保护

---

<div align="center">

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」

</div>
