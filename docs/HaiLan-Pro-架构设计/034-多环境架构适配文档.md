---
file: 034-多环境架构适配文档.md
description: HaiLan Pro 开发、测试、预生产、生产环境的架构适配与配置规范
author: YanYuCloudCube Team
version: v1.0.0
created: 2026-01-26
updated: 2026-01-26
status: published
tags:
  - HaiLan-Pro-架构设计,[]
---

> ***YanYuCloudCube***
> 言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> 万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

# 034 多环境架构适配文档

## 概述

本文档详细描述HaiLan Pro的多环境架构适配设计，包括开发、测试、预生产、生产环境的配置规范与部署策略，确保项目按照YYC³标准规范进行开发和实施。

## 核心内容

### 1. 背景与目标

#### 1.1 项目背景
HaiLan Pro (海蓝) 是新一代高端、私密、智能的情趣健康生活管理平台。项目基于「五高五标五化」理念，通过 PWA 技术结合 AI 智能辅助与物联网，为用户提供从生理健康到心理愉悦的全方位解决方案。

#### 1.2 多环境价值
- **风险控制**：在测试环境充分验证，降低生产环境风险
- **团队协作**：开发、测试、运维并行工作
- **成本优化**：根据环境需求配置资源，降低成本
- **快速迭代**：支持快速验证新功能和修复

#### 1.3 文档目标
- 规范多环境架构适配相关的业务标准与技术落地要求
- 定义各环境配置差异和部署策略
- 保障环境切换和部署的一致性与规范性

### 2. 设计原则

#### 2.1 五高原则
- **高可用性**：生产环境多副本部署，故障自动转移
- **高性能**：根据环境负载动态调整资源配置
- **高安全性**：生产环境严格的访问控制和审计
- **高扩展性**：支持快速扩展新环境和配置
- **高可维护性**：统一的环境管理工具和流程

#### 2.2 五标体系
- **标准化**：统一的环境配置格式和命名规范
- **规范化**：标准化的环境切换和部署流程
- **自动化**：自动化的环境配置同步和部署
- **智能化**：智能的环境监控和告警
- **可视化**：环境状态和配置的可视化管理

#### 2.3 五化架构
- **流程化**：标准化的环境创建和配置流程
- **文档化**：完善的环境配置文档
- **工具化**：自动化的环境管理工具链
- **数字化**：环境资源使用量化指标
- **生态化**：兼容各类云平台和容器编排

### 3. 多环境架构设计

#### 3.1 环境划分

```
┌─────────────────────────────────────────────────────────────────┐
│                    HaiLan Pro 多环境架构                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    开发环境 (dev)                           │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │   │
│  │  │本地开发   │  │热重载     │  │调试工具    │  │Mock数据│ │   │
│  │  │localhost │  │HMR       │  │DevTools  │  │Mock API│ │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    测试环境 (test)                         │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │   │
│  │  │自动化测试 │  │集成测试   │  │测试数据   │  │CI/CD   │ │   │
│  │  │E2E Tests │  │Integration│  │Test Data │  │Pipeline │ │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    预生产环境 (staging)                    │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │   │
│  │  │生产仿真   │  │压力测试   │  │真实数据   │  │灰度发布 │ │   │
│  │  │Prod-like │  │Load Test │  │Real Data │  │Canary  │ │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    生产环境 (production)                   │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │   │
│  │  │高可用部署 │  │监控告警   │  │备份恢复   │  │安全加固 │ │   │
│  │  │HA Cluster│  │Monitoring│  │Backup    │  │Security │ │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.2 环境配置

##### 3.2.1 环境变量定义

```typescript
// src/config/environment.ts
export enum Environment {
  DEVELOPMENT = 'development',
  TEST = 'test',
  STAGING = 'staging',
  PRODUCTION = 'production',
}

export interface AppConfig {
  // 基础配置
  env: Environment;
  appVersion: string;
  apiUrl: string;
  wsUrl: string;

  // 功能开关
  features: {
    enableAI: boolean;
    enableIoT: boolean;
    enablePWA: boolean;
    enableAnalytics: boolean;
    enableDebug: boolean;
  };

  // 第三方服务
  services: {
    supabase: {
      url: string;
      anonKey: string;
    };
    openai: {
      apiKey: string;
      baseURL: string;
    };
    sentry: {
      dsn: string;
      environment: string;
    };
  };

  // 性能配置
  performance: {
    cacheEnabled: boolean;
    cacheTTL: number;
    requestTimeout: number;
  };

  // 安全配置
  security: {
    encryptionEnabled: boolean;
    privacyMode: 'STANDARD' | 'STEALTH' | 'DISGUISE';
  };
}

// 环境配置映射
const ENV_CONFIGS: Record<Environment, AppConfig> = {
  [Environment.DEVELOPMENT]: {
    env: Environment.DEVELOPMENT,
    appVersion: '1.0.0-dev',
    apiUrl: 'http://localhost:3000/api',
    wsUrl: 'ws://localhost:3000/ws',
    features: {
      enableAI: true,
      enableIoT: true,
      enablePWA: true,
      enableAnalytics: false,
      enableDebug: true,
    },
    services: {
      supabase: {
        url: process.env.VITE_SUPABASE_URL || '',
        anonKey: process.env.VITE_SUPABASE_ANON_KEY || '',
      },
      openai: {
        apiKey: process.env.VITE_OPENAI_API_KEY || '',
        baseURL: 'https://api.openai.com/v1',
      },
      sentry: {
        dsn: '',
        environment: 'development',
      },
    },
    performance: {
      cacheEnabled: true,
      cacheTTL: 300000, // 5分钟
      requestTimeout: 30000,
    },
    security: {
      encryptionEnabled: false,
      privacyMode: 'STANDARD',
    },
  },

  [Environment.TEST]: {
    env: Environment.TEST,
    appVersion: '1.0.0-test',
    apiUrl: 'http://test-api.hailan.pro/api',
    wsUrl: 'ws://test-api.hailan.pro/ws',
    features: {
      enableAI: true,
      enableIoT: false,
      enablePWA: false,
      enableAnalytics: false,
      enableDebug: true,
    },
    services: {
      supabase: {
        url: process.env.VITE_SUPABASE_URL || '',
        anonKey: process.env.VITE_SUPABASE_ANON_KEY || '',
      },
      openai: {
        apiKey: process.env.VITE_OPENAI_API_KEY || '',
        baseURL: 'https://api.openai.com/v1',
      },
      sentry: {
        dsn: '',
        environment: 'test',
      },
    },
    performance: {
      cacheEnabled: true,
      cacheTTL: 60000, // 1分钟
      requestTimeout: 10000,
    },
    security: {
      encryptionEnabled: true,
      privacyMode: 'STANDARD',
    },
  },

  [Environment.STAGING]: {
    env: Environment.STAGING,
    appVersion: '1.0.0-staging',
    apiUrl: 'https://staging-api.hailan.pro/api',
    wsUrl: 'wss://staging-api.hailan.pro/ws',
    features: {
      enableAI: true,
      enableIoT: true,
      enablePWA: true,
      enableAnalytics: true,
      enableDebug: false,
    },
    services: {
      supabase: {
        url: process.env.VITE_SUPABASE_URL || '',
        anonKey: process.env.VITE_SUPABASE_ANON_KEY || '',
      },
      openai: {
        apiKey: process.env.VITE_OPENAI_API_KEY || '',
        baseURL: 'https://api.openai.com/v1',
      },
      sentry: {
        dsn: process.env.VITE_SENTRY_DSN || '',
        environment: 'staging',
      },
    },
    performance: {
      cacheEnabled: true,
      cacheTTL: 600000, // 10分钟
      requestTimeout: 15000,
    },
    security: {
      encryptionEnabled: true,
      privacyMode: 'STANDARD',
    },
  },

  [Environment.PRODUCTION]: {
    env: Environment.PRODUCTION,
    appVersion: '1.0.0',
    apiUrl: 'https://api.hailan.pro/api',
    wsUrl: 'wss://api.hailan.pro/ws',
    features: {
      enableAI: true,
      enableIoT: true,
      enablePWA: true,
      enableAnalytics: true,
      enableDebug: false,
    },
    services: {
      supabase: {
        url: process.env.VITE_SUPABASE_URL || '',
        anonKey: process.env.VITE_SUPABASE_ANON_KEY || '',
      },
      openai: {
        apiKey: process.env.VITE_OPENAI_API_KEY || '',
        baseURL: 'https://api.openai.com/v1',
      },
      sentry: {
        dsn: process.env.VITE_SENTRY_DSN || '',
        environment: 'production',
      },
    },
    performance: {
      cacheEnabled: true,
      cacheTTL: 3600000, // 1小时
      requestTimeout: 10000,
    },
    security: {
      encryptionEnabled: true,
      privacyMode: 'STANDARD',
    },
  },
};

// 获取当前环境配置
export function getConfig(): AppConfig {
  const env = (import.meta.env.VITE_APP_ENV || Environment.DEVELOPMENT) as Environment;
  return ENV_CONFIGS[env];
}
```

##### 3.2.2 环境变量配置文件

```bash
# .env.development
VITE_APP_ENV=development
VITE_APP_VERSION=1.0.0-dev

# Supabase
VITE_SUPABASE_URL=http://localhost:54321
VITE_SUPABASE_ANON_KEY=eyJ-local-dev-key

# OpenAI
VITE_OPENAI_API_KEY=sk-dev-key
VITE_OPENAI_BASE_URL=https://api.openai.com/v1

# Sentry
VITE_SENTRY_DSN=

# Features
VITE_ENABLE_AI=true
VITE_ENABLE_IOT=true
VITE_ENABLE_PWA=true
VITE_ENABLE_ANALYTICS=false
VITE_ENABLE_DEBUG=true
```

```bash
# .env.test
VITE_APP_ENV=test
VITE_APP_VERSION=1.0.0-test

# Supabase
VITE_SUPABASE_URL=https://test-project.supabase.co
VITE_SUPABASE_ANON_KEY=eyJ-test-key

# OpenAI
VITE_OPENAI_API_KEY=sk-test-key
VITE_OPENAI_BASE_URL=https://api.openai.com/v1

# Sentry
VITE_SENTRY_DSN=

# Features
VITE_ENABLE_AI=true
VITE_ENABLE_IOT=false
VITE_ENABLE_PWA=false
VITE_ENABLE_ANALYTICS=false
VITE_ENABLE_DEBUG=true
```

```bash
# .env.staging
VITE_APP_ENV=staging
VITE_APP_VERSION=1.0.0-staging

# Supabase
VITE_SUPABASE_URL=https://staging-project.supabase.co
VITE_SUPABASE_ANON_KEY=eyJ-staging-key

# OpenAI
VITE_OPENAI_API_KEY=sk-staging-key
VITE_OPENAI_BASE_URL=https://api.openai.com/v1

# Sentry
VITE_SENTRY_DSN=https://xxx@sentry.io/xxx

# Features
VITE_ENABLE_AI=true
VITE_ENABLE_IOT=true
VITE_ENABLE_PWA=true
VITE_ENABLE_ANALYTICS=true
VITE_ENABLE_DEBUG=false
```

```bash
# .env.production
VITE_APP_ENV=production
VITE_APP_VERSION=1.0.0

# Supabase
VITE_SUPABASE_URL=https://project.supabase.co
VITE_SUPABASE_ANON_KEY=eyJ-production-key

# OpenAI
VITE_OPENAI_API_KEY=sk-production-key
VITE_OPENAI_BASE_URL=https://api.openai.com/v1

# Sentry
VITE_SENTRY_DSN=https://xxx@sentry.io/xxx

# Features
VITE_ENABLE_AI=true
VITE_ENABLE_IOT=true
VITE_ENABLE_PWA=true
VITE_ENABLE_ANALYTICS=true
VITE_ENABLE_DEBUG=false
```

#### 3.3 部署配置

##### 3.3.1 Kubernetes配置

```yaml
# k8s/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: hailan-pro
---
apiVersion: v1
kind: Namespace
metadata:
  name: hailan-pro-staging
---
apiVersion: v1
kind: Namespace
metadata:
  name: hailan-pro-dev
```

```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: hailan-pro
data:
  APP_ENV: "production"
  APP_VERSION: "1.0.0"
  API_URL: "https://api.hailan.pro"
  ENABLE_AI: "true"
  ENABLE_IOT: "true"
  ENABLE_PWA: "true"
  ENABLE_ANALYTICS: "true"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: hailan-pro-staging
data:
  APP_ENV: "staging"
  APP_VERSION: "1.0.0-staging"
  API_URL: "https://staging-api.hailan.pro"
  ENABLE_AI: "true"
  ENABLE_IOT: "true"
  ENABLE_PWA: "true"
  ENABLE_ANALYTICS: "true"
```

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hailan-pro-frontend
  namespace: hailan-pro
spec:
  replicas: 3
  selector:
    matchLabels:
      app: hailan-pro
      component: frontend
  template:
    metadata:
      labels:
        app: hailan-pro
        component: frontend
    spec:
      containers:
      - name: frontend
        image: hailan-pro/frontend:1.0.0
        ports:
        - containerPort: 80
        env:
        - name: APP_ENV
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: APP_ENV
        - name: API_URL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: API_URL
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hailan-pro-frontend
  namespace: hailan-pro-staging
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hailan-pro
      component: frontend
  template:
    metadata:
      labels:
        app: hailan-pro
        component: frontend
    spec:
      containers:
      - name: frontend
        image: hailan-pro/frontend:1.0.0-staging
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
```

```yaml
# k8s/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: hailan-pro-frontend
  namespace: hailan-pro
spec:
  type: ClusterIP
  selector:
    app: hailan-pro
    component: frontend
  ports:
  - port: 80
    targetPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: hailan-pro-frontend
  namespace: hailan-pro-staging
spec:
  type: ClusterIP
  selector:
    app: hailan-pro
    component: frontend
  ports:
  - port: 80
    targetPort: 80
```

```yaml
# k8s/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hailan-pro-ingress
  namespace: hailan-pro
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - hailan.pro
    - www.hailan.pro
    secretName: hailan-pro-tls
  rules:
  - host: hailan.pro
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: hailan-pro-frontend
            port:
              number: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hailan-pro-ingress
  namespace: hailan-pro-staging
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-staging
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - staging.hailan.pro
    secretName: hailan-pro-staging-tls
  rules:
  - host: staging.hailan.pro
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: hailan-pro-frontend
            port:
              number: 80
```

##### 3.3.2 Docker Compose配置

```yaml
# docker-compose.yml
version: '3.8'

services:
  # 前端应用
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_APP_ENV: development
    ports:
      - "3000:80"
    environment:
      - VITE_APP_ENV=development
      - VITE_API_URL=http://api:3001
    volumes:
      - ./src:/app/src
      - ./public:/app/public
    command: npm run dev

  # API服务
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/hailan
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    volumes:
      - ./api/src:/app/src

  # PostgreSQL
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=hailan
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres-data:/var/lib/postgresql/data

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

volumes:
  postgres-data:
  redis-data:
```

```yaml
# docker-compose.staging.yml
version: '3.8'

services:
  frontend:
    image: hailan-pro/frontend:1.0.0-staging
    ports:
      - "80:80"
    environment:
      - VITE_APP_ENV=staging
      - VITE_API_URL=https://staging-api.hailan.pro

  api:
    image: hailan-pro/api:1.0.0-staging
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=staging
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
```

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  frontend:
    image: hailan-pro/frontend:1.0.0
    ports:
      - "80:80"
    environment:
      - VITE_APP_ENV=production
      - VITE_API_URL=https://api.hailan.pro
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  api:
    image: hailan-pro/api:1.0.0
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
```

#### 3.4 CI/CD配置

##### 3.4.1 GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: hailan-pro/frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-staging:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}

      - name: Deploy to staging
        run: |
          kubectl set image deployment/hailan-pro-frontend \
            frontend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop \
            -n hailan-pro-staging
          kubectl rollout status deployment/hailan-pro-frontend -n hailan-pro-staging

  deploy-production:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_PROD }}

      - name: Deploy to production
        run: |
          kubectl set image deployment/hailan-pro-frontend \
            frontend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main \
            -n hailan-pro
          kubectl rollout status deployment/hailan-pro-frontend -n hailan-pro

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/hailan-pro-frontend -n hailan-pro
```

#### 3.5 环境切换

##### 3.5.1 切换脚本

```bash
#!/bin/bash
# scripts/switch-env.sh

ENV=$1

if [ -z "$ENV" ]; then
  echo "Usage: ./switch-env.sh <dev|test|staging|prod>"
  exit 1
fi

case $ENV in
  dev)
    cp .env.development .env.local
    echo "Switched to DEVELOPMENT environment"
    ;;
  test)
    cp .env.test .env.local
    echo "Switched to TEST environment"
    ;;
  staging)
    cp .env.staging .env.local
    echo "Switched to STAGING environment"
    ;;
  prod)
    cp .env.production .env.local
    echo "Switched to PRODUCTION environment"
    ;;
  *)
    echo "Unknown environment: $ENV"
    exit 1
    ;;
esac

# 清理缓存并重启
rm -rf node_modules/.vite
bun install
bun run dev
```

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
