/**
 * HaiLan 可访问性样式系统
 * 基于设计文档 01-Figma-HaiLan-Adult-products.md 第4节
 * 符合 WCAG 2.1 AA 标准
 */

/* === 焦点环设计 Focus Ring === */
@layer base {
  /* 全局焦点环样式 */
  *:focus {
    outline: none;
  }
  
  *:focus-visible {
    outline: 2px solid var(--color-brand-hailan-blue, #0056b3);
    outline-offset: 2px;
    border-radius: inherit;
    position: relative;
    z-index: 10;
  }
  
  /* 确保最小4px圆角 */
  *:focus-visible {
    border-radius: max(inherit, 4px);
  }
  
  /* 按钮焦点环 */
  button:focus-visible,
  a:focus-visible,
  [role="button"]:focus-visible {
    outline: 2px solid var(--color-brand-hailan-blue);
    outline-offset: 2px;
  }
  
  /* 输入框焦点环 */
  input:focus-visible,
  textarea:focus-visible,
  select:focus-visible {
    outline: 2px solid var(--color-brand-hailan-blue);
    outline-offset: 0px;
    border-color: var(--color-brand-hailan-blue);
  }
  
  /* 深色背景下的焦点环 */
  [data-theme="dark"] *:focus-visible,
  .bg-dark *:focus-visible {
    outline-color: var(--color-brand-hailan-blue-light, #3b82f6);
  }
}

/* === 焦点环工具类 === */
@layer utilities {
  .focus-ring {
    @apply focus-visible:outline-2 focus-visible:outline-[#0056b3] focus-visible:outline-offset-2;
  }
  
  .focus-ring-inset {
    @apply focus-visible:outline-2 focus-visible:outline-[#0056b3] focus-visible:outline-offset-0;
  }
  
  .focus-ring-white {
    @apply focus-visible:outline-2 focus-visible:outline-white focus-visible:outline-offset-2;
  }
}

/* === 跳过导航链接 Skip Links === */
.skip-link {
  position: absolute;
  top: -40px;
  left: 0;
  background: var(--color-brand-hailan-blue);
  color: white;
  padding: 8px 16px;
  text-decoration: none;
  border-radius: 0 0 4px 0;
  z-index: 9999;
  transition: top var(--duration-fast) var(--ease-standard);
}

.skip-link:focus {
  top: 0;
  outline: 2px solid white;
  outline-offset: -4px;
}

/* === 屏幕阅读器辅助文本 === */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

.sr-only-focusable:focus,
.sr-only-focusable:active {
  position: static;
  width: auto;
  height: auto;
  overflow: visible;
  clip: auto;
  white-space: normal;
}

/* === 高对比度模式 High Contrast Mode === */
@media (prefers-contrast: high) {
  * {
    border-color: currentColor !important;
  }
  
  button,
  a,
  input,
  select,
  textarea {
    outline: 2px solid currentColor;
  }
}

/* === 色盲友好的状态指示 === */
@layer utilities {
  /* 成功状态 - 绿色 + 勾选图标 */
  .status-success {
    @apply text-green-600 bg-green-50 border-green-200;
  }
  
  .status-success::before {
    content: '✓';
    margin-right: 0.5rem;
    font-weight: bold;
  }
  
  /* 错误状态 - 红色 + 警告图标 */
  .status-error {
    @apply text-red-600 bg-red-50 border-red-200;
  }
  
  .status-error::before {
    content: '⚠';
    margin-right: 0.5rem;
    font-weight: bold;
  }
  
  /* 警告状态 - 黄色 + 感叹号 */
  .status-warning {
    @apply text-yellow-700 bg-yellow-50 border-yellow-200;
  }
  
  .status-warning::before {
    content: '!';
    margin-right: 0.5rem;
    font-weight: bold;
    background: currentColor;
    color: white;
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
  }
  
  /* 信息状态 - 蓝色 + 信息图标 */
  .status-info {
    @apply text-blue-600 bg-blue-50 border-blue-200;
  }
  
  .status-info::before {
    content: 'i';
    margin-right: 0.5rem;
    font-weight: bold;
    background: currentColor;
    color: white;
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-style: italic;
  }
}

/* === 键盘导航优化 === */
@layer base {
  /* 改善键盘导航的可见性 */
  [tabindex]:focus-visible {
    outline: 2px solid var(--color-brand-hailan-blue);
    outline-offset: 2px;
  }
  
  /* 移除鼠标点击时的焦点环 */
  [tabindex]:focus:not(:focus-visible) {
    outline: none;
  }
}

/* === 文本可读性 === */
@layer utilities {
  /* 确保最小对比度 4.5:1 */
  .text-readable {
    color: var(--color-text-primary);
    background-color: var(--color-bg-primary);
  }
  
  /* 大文字最小对比度 3:1 */
  .text-readable-large {
    font-size: 1.25rem;
    font-weight: 400;
  }
  
  /* 强制高对比度 */
  .text-high-contrast {
    color: #000000;
    background-color: #FFFFFF;
  }
}

/* === 动效减少（尊重用户偏好） === */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
  
  /* 保留必要的过渡效果，但大幅缩短 */
  .preserve-transition {
    transition-duration: 100ms !important;
  }
}

/* === 触摸目标大小 === */
@layer utilities {
  /* 确保最小 44x44px 触摸目标 */
  .touch-target {
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  /* 小按钮的内部填充 */
  .touch-target-padding {
    padding: 12px;
  }
}

/* === ARIA 实时区域样式 === */
[aria-live] {
  /* 确保实时区域始终可访问 */
  position: relative;
}

[aria-live="polite"] {
  /* 礼貌模式 - 不打断当前阅读 */
}

[aria-live="assertive"] {
  /* 断言模式 - 立即通知 */
  font-weight: 600;
}

/* === 禁用状态的可访问性 === */
[disabled],
[aria-disabled="true"] {
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: none;
}

button[disabled],
input[disabled],
select[disabled],
textarea[disabled] {
  opacity: 0.5;
  cursor: not-allowed;
}

/* === 隐私模式下的可访问性 === */
.privacy-mode [data-privacy-blur] {
  /* 确保隐私模糊内容有替代文本 */
  position: relative;
}

.privacy-mode [data-privacy-blur]::after {
  content: attr(aria-label);
  position: absolute;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* === 表单验证可访问性 === */
input:invalid,
textarea:invalid,
select:invalid {
  border-color: var(--color-error);
}

input:invalid:focus,
textarea:invalid:focus,
select:invalid:focus {
  outline-color: var(--color-error);
  border-color: var(--color-error);
}

[aria-invalid="true"] {
  border-color: var(--color-error) !important;
}

/* === 必填字段指示 === */
[required]::after,
[aria-required="true"]::after {
  content: ' *';
  color: var(--color-error);
  font-weight: bold;
}

/* === 链接可访问性 === */
a {
  /* 确保链接有下划线或其他视觉区分 */
  text-decoration-skip-ink: auto;
}

a:not([class]) {
  text-decoration: underline;
  text-decoration-thickness: 1px;
  text-underline-offset: 0.2em;
}

a:hover,
a:focus {
  text-decoration-thickness: 2px;
}

/* 确保链接在正文中可识别 */
p a,
li a,
td a {
  color: var(--color-brand-hailan-blue);
  text-decoration: underline;
}

/* === 图片可访问性 === */
img:not([alt]) {
  /* 警告：缺少alt属性 */
  outline: 3px solid red;
}

img[alt=""] {
  /* 装饰性图片 */
  user-select: none;
}

/* === 对话框/模态框可访问性 === */
[role="dialog"],
[role="alertdialog"] {
  /* 确保对话框在最上层 */
  z-index: var(--z-modal);
}

/* 当模态框打开时，禁用背景滚动 */
body:has([role="dialog"]),
body:has([role="alertdialog"]) {
  overflow: hidden;
}

/* === 菜单可访问性 === */
[role="menu"],
[role="listbox"] {
  /* 确保菜单项可键盘导航 */
}

[role="menuitem"]:focus,
[role="option"]:focus {
  background-color: var(--color-bg-tertiary);
  outline: none;
}

/* === 工具提示可访问性 === */
[role="tooltip"] {
  /* 工具提示应该在悬停/��焦时显示 */
  z-index: var(--z-tooltip);
  max-width: 300px;
  word-wrap: break-word;
}

/* === 进度指示器 === */
[role="progressbar"] {
  /* 确保进度条有可见的进度 */
  background-color: var(--color-bg-secondary);
  border-radius: 9999px;
  overflow: hidden;
}

/* === 选项卡可访问性 === */
[role="tablist"] {
  display: flex;
  gap: 0.25rem;
}

[role="tab"] {
  cursor: pointer;
}

[role="tab"][aria-selected="true"] {
  font-weight: 600;
  border-bottom: 2px solid var(--color-brand-hailan-blue);
}

[role="tabpanel"] {
  outline: none;
}

[role="tabpanel"]:focus-visible {
  outline: 2px solid var(--color-brand-hailan-blue);
  outline-offset: 4px;
}

/* === 通知/警告可访问性 === */
[role="alert"] {
  padding: 1rem;
  border-radius: 0.5rem;
  border: 1px solid currentColor;
}

[role="alert"][aria-live="assertive"] {
  /* 紧急通知 - 使用更明显的样式 */
  font-weight: 600;
  animation: shake 0.3s ease-in-out;
}

/* === 加载状态可访问性 === */
[aria-busy="true"] {
  opacity: 0.7;
  pointer-events: none;
  position: relative;
}

[aria-busy="true"]::after {
  content: '';
  position: absolute;
  inset: 0;
  background-color: rgba(255, 255, 255, 0.5);
  z-index: 1;
}
